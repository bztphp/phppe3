<?php
/*
 *  PHP Portal Engine v3.0.0
 *  https://github.com/bztphp/phppe3/
 *
 *  Copyright LGPL 2015 bzt
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU Lesser General Public License as published
 *  by the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Lesser General Public License for more details.
 *
 *   <http://www.gnu.org/licenses/>
 *
 *   PHPPE Core - Use as is
 */
namespace PHPPE{define("VERSION","3.0.0");class AddOn{public$args;public$name;public$value;public$attrs;protected$css;protected$err;final function __construct($a,$n,&$v,$t=[],$r=0){$this->args=$a;$this->name=$n;$this->value=$v;$this->attrs=$t;$this->css=(!empty($r)?"req":"")."input";$this->err=Core::iserror($n)?" style='background:".Core::$ec.";'":"";}function __toString(){return __CLASS__;}}class App{function __toString(){return __CLASS__;}}class Model{public$id;public$name;protected static$_table;final function find($s=[],$w="",$o=""){if(empty(static::$_table))throw new\Exception("no _table");return Core::query("*",static::$_table,$w?$w:($s?"id=?":""),"",$o,0,0,a($s)?$s:[$s]);}final function load($i=0,$w="",$o=""){if(empty(static::$_table))throw new\Exception("no _table");$r=Core::fetch("*",static::$_table,$w?$w:"id=?","",$o,a($i)?$i:[$i?$i:$this->id]);if(!empty($r)){foreach($this as$k=>$v)if($k[0]!='_')$this->$k=is_string($r[$k])&&($r[$k][0]=='{'||$r[$k][0]=='[')?jd($r[$k]):$r[$k];return true;}return false;}final function save($f=0){if(empty(static::$_table))throw new\Exception("no _table");$d=Core::db();if(empty($d))throw new\Exception("no ds");$a=[];foreach($this as$k=>$v)if($k[0]!='_'&&($f||$k!='id')&&$k!='created')$a[$k]=is_scalar($v)?$v:json_encode($v);if(!Core::exec(($this->id&&!$f?"UPDATE ".static::$_table." SET ".implode("=?,",array_keys($a))."=? WHERE id=".$d->quote($this->id):"INSERT INTO ".static::$_table." (".implode(",",array_keys($a)).") VALUES (?".str_repeat(",?",count($a)-1.).")"),array_values($a)))return false;if(!$this->id)$this->id=$d->lastInsertId();return$this->id;}function __toString(){return __CLASS__;}}class Client{public$ip;public$agent;public$user;public$tz;public$lang;public$screen=[];function __toString(){return __CLASS__;}}class User extends Model{public$id=0;public$name="Anonymous";public$data=[];private$acl=[];final function has($l){foreach(a($l)?$l:x("|",$l) as$a){$a=r($a);if(!empty($this->id)&&($this->id==-1||$a=="loggedin"||!empty($this->acl[$a])||!empty($this->acl["$a:".self::$core->item])))return 1;}return 0;}final function grant($l){foreach(a($l)?$l:x("|",$l) as$a){$a=r($a);if(!empty($this->id)&&!empty($a))$this->acl[$a]=1;}}final function clear($l=""){if(empty($l))$this->acl=[];else{foreach(a($l)?$l:x("|",$l) as$a){$a=r($a);unset($this->acl[$a]);foreach($this->acl as$k=>$v)if(z($k,0,u($a)+1)==$a.":")unset($this->acl[$k]);}}}function __toString(){return __CLASS__;}}define('M',"vendor/");define('N',M."phppe/");define('P',N."core/");define('PE',".php");define('C',"\\PHPPE\\");define('A',C."AddOn\\");class Core{private$id;public$base;public$site;public$runlevel=2;public$app;public$action;public$item;public$form;public$now;public$needframe=true;public$neederror=true;public$syslog=false;public$timeout;public$output;public$template;public$mailer;public$cache;public$cachettl=600;public static$core;public static$user;public static$client;public static$l=[];public static$fm;public static$ec="#FFA0A0";private$meta=[];private$try;private$started;private$error;private$libs;private$addons;private$js;private$jslib;private$css;private$menu;private static$r;private static$n;private static$c;private static$o;private static$p;private static$mc;private static$tc;private static$db;private static$sel;private static$bill;private static$w;private static$v;function __construct($islib=true){$this->started=microtime(1);$core=self::$core=&$this;set_exception_handler(function(\Exception$e){self::log('C',"Uncought exception: ".$e->getMessage());});ini_set("error_log",n(__DIR__)."/".P."log/php.log");ini_set("log_errors",1);if(version_compare(PHP_VERSION,"5.5")<0)self::log("C","PHP 5.5.0 required, found ".PHP_VERSION);ini_set("file_uploads",1);ini_set("upload_tmp_dir",n(__DIR__)."/.tmp");ini_set("uploadprogress.file.filename_template",n(__DIR__)."/.tmp/upd_%s.txt");if(y("mb_internal_encoding"))mb_internal_encoding("utf-8");if(get_magic_quotes_gpc()){foreach($_REQUEST as$k=>$v)if(is_string($v))$_REQUEST[$k]=stripslashes($v);elseif(a($v))foreach($v as$K=>$V)if(is_string($V))$_REQUEST[$k][$K]=stripslashes($V);}$c=__FILE__;if(filesize($c)!=65535||'11718027dada50d45a47aab83c3cc9559e10d0ae'!=sha1(pr("/\'([^\']+)\'\!\=sha1/","''!=sha1",g($c))))self::log("C","Corrupted ".m($c));chdir(n(__DIR__));$S=$_SERVER;$R=$_REQUEST;$c=P."config".PE;if(f($c))require_once($c);$this->id="PHPPE".VERSION;if($this->runlevel<0||$this->runlevel>3)$this->runlevel=0;if($this->timeout<60)$this->timeout=7*24*3600;if($this->cachettl<10)$this->cachettl=10;if(!empty($this->allowed)&&!a($this->allowed))$this->allowed=x(",",$this->allowed);ini_set("display_errors",$this->runlevel>1?1:0);$this->now=time();$this->error=$this->js=$this->jslib=$this->css=[];$this->sec=(t(getenv("HTTPS"))=="on")?1:0;self::$w=isset($S['REQUEST_METHOD'])?1:0;$this->output=self::$w?"html":"tty";$this->try=self::$tc=0;$c=$S['SCRIPT_NAME'];$C=n($c);$d="SERVER_NAME";$this->base=(!empty($this->base)?$this->base:(!empty($S[$d])?$S[$d]:"localhost")).(!empty($C)&&$C[0]!="/"?"/":"").$C;list($d)=x("?",@$S['REQUEST_URI']);foreach([$c,n($c)] as$C)if(z($d,0,u($C))==$C){$d=w($d,u($C));break;}$D="--dump";$A="argv";$d=x("/",!empty($d)?$d:"//");$this->app=!empty($d[1])?t($d[1]):(!empty($R['app'])?r(t($R['app'])):(!self::$w&&!empty($S[$A][1])&&$S[$A][1]!=$D?r(t($S[$A][1])):"index"));$this->action=!empty($d[2])?t($d[2]):(!empty($R['action'])?r(t($R['action'])):(!self::$w&&!empty($S[$A][2])&&$S[$A][2]!=$D?r(t($S[$A][2])):"action"));$this->item=!empty($d[3])?t($d[3]):(!empty($R['item'])?r($R['item']):(!self::$w&&!empty($S[$A][3])&&$S[$A][3]!=$D?r($S[$A][3]):""));$c=$this->app."_".$this->action;if(strpos($c,"..")!==false||strpos($c,"/")!==false||w($this->app,-4)==PE||w($this->action,-4)==PE)$this->redirect("/403");$this->template=$c;$c=self::si("post_max_size");$d=self::si("upload_max_filesize");$v=self::si("memory_limit");if($c>$d&&$d)$c=$d;self::$fm=($c>$v&&$v?$v:$c);if(!self::$w&&!empty($S[$A][1])){if(in_array("--version",$S[$A]))die(VERSION."\n");if(in_array("--help",$S[$A]))die("PHP Portal Engine ".VERSION.", LGPL 2015 bzt\n\nphp ".m(__FILE__)." (cmd | [application [action [item]]] ) [ $D ]\n\nCommands:\n --version\n --diag [--gid=x]\n\n");}if(!self::$w&&((!f(P."config".PE)&&!$islib)||(!empty($S[$A][1])&&$S[$A][1]=="--diag")))$this->bootdiag();else{$this->bootstrap();if(!$islib)$this->run();}}private function bootdiag(){ini_set("display_errors",1);header("Content-Type:text/plain");if(!extension_loaded("posix")&&y("dl"))@dl((PHP_SHLIB_SUFFIX=="dll"?"php_":"")."posix.".PHP_SHLIB_SUFFIX);if(!empty($_SERVER['argv'][2])&&z($_SERVER['argv'][2],0,6)=="--gid=")$g["g"]=intval(w($_SERVER['argv'][2],6));elseif(y("posix_getpwnam"))foreach(["www","_www","www-data","http","httpd","apache","nginx"] as$n){$g=posix_getpwnam($n);if(!empty($g["gid"])){$g["g"]=$g["gid"];break;}}if(empty($g["g"])){$g["g"]=33;echo("DIAG-W: Fallback to gid 33\n");}function i($c,$r,$g,$f=0){if(!f($c)||$f){if(!f($c))echo("DIAG-A: $c\n");file_put_contents($c,$r);}if(f($c)&&$g["r"]&&(!chgrp($c,$g["g"])||!chown($c,fileowner(__FILE__))))echo("DIAG-E: chown/chgrp ".$g["g"]." $c\n");return!chmod($c,0640);}$pe="";$C=0750;$g["r"]=!self::$w&&y("posix_getuid")&&posix_getuid()==0;if(!$g["r"])echo("DIAG-W: not root or no php-posix, chown/chgrp skipped!\n");$o=umask(0);@symlink(N."core","phppe");$D=[".tmp"=>0770,"data"=>0770,"app"=>0,M=>0,M."bin"=>0,N=>0,P=>0,P."log"=>0770,P."views"=>0,P."ctrl"=>0,P."lang"=>0,P."libs"=>0,P."out"=>0,P."sql"=>0,"public/images"=>0,"public/css"=>0,"public/js"=>0,"app/ctrl"=>0,"app/lang"=>0,"app/libs"=>0,"app/views"=>0];foreach(["*","*/*","*/*/*","*/*/*/*"] as$v)$D+=array_fill_keys(@glob(M.$v,GLOB_ONLYDIR),0);foreach($D as$d=>$p){if(!$p)$p=$C;if(!is_dir($d)){echo("DIAG-A: $d\n");if(!mkdir($d,$p))self::log("C","creating $d","diag");}$p2=fileperms($d)&0777;if($p2!=$p){$pe.=sprintf("\t%03o?\t%03o ",$p2,$p)."$d\n";@chmod($d,$p);}if($g["r"]&&(!chgrp($d,$g["g"])||!chown($d,fileowner(__FILE__))))echo("DIAG-E: chown/chgrp ".$g["g"]." $d\n");}@symlink("../../app",N."app");foreach(["images","css","js"] as$v){if(!f("app/$v"))echo("DIAG-A: app/$v\n");@symlink("../public/$v","app/$v");}umask(0227);i("app/config".PE,"",$g);umask(0027);i("public/favicon.ico","",$g);i(P."config".PE,"",$g);$U="http://phppe.org/";$D=P."views/";$e=".tpl";i($D."403$e","<h1>403</h1><!=L('Access denied')>",$g);i($D."404$e","<h1>404</h1><!=L('Not found')>: <b><!=core.app></b>",$g);i($D."frame$e","<div id='content'><!app></div>",$g);i($D."index$e","<h1>PHPPE works!</h1>Next step: install <a href='".$U."phppe3.html#install:1024' target='_new'>PHPPE Pack</a>.<br/><br/><!if core.istry()><div style='display:none;'><!dump core.req2arr('obj')></div><!/if><div style='font-weight:bold;background:#F0F0F0;padding:3px;'>Test form</div><!form obj>Text<!field text(6) obj.f0> Pass<!field pass(6) obj.f1> Num(100..999)<!field *num(6,6,100,999) obj.f2><!field check obj.f3 Check>  File<!field file obj.f4> <!field cancel>  <!field submit></form><table width='100%'><tr><td valign='top' width='50%'><!dump _REQUEST><!dump _FILES></td><td valign='top'><!dump core.req2arr('obj')></td></tr></table>\n",$g);i($D."login$e","<!form login><!field text id><!field pass pass><!field submit></form>",$g);i("composer.json","{\n\t\"name\":\"No name\",\n\t\"version\":\"1.0.0\",\n\t\"keywords\":[\"phppe3\",\"\"],\n\t\"license\":[\"LGPL-3.0+\"],\n\n\t\"type\":\"project\",\n\t\"repositories\":[\n\t\t{\"type\":\"composer\",\"url\":\"$U\"}\n\t],\n\t\"require\":{\"phppe\":\"3.*\"},\n\n\t\"scripts\":{\"post-update-cmd\":\"sudo php public/index.php --diag\"}\n}\n",$g);i(".gitignore",".tmp\nphppe\nvendor\n",$g);umask($o);if($pe)self::log("C","Wrong permissions:\n$pe","diag");die("DIAG-I: OK\n");}private function bootstrap(){$S=$_SERVER;$R=$_REQUEST;$v="libs/pass";$c="app/$v".PE;if(f($c))i($c);else{$c=P.$v.PE;if(f($c))i($c);}$c=P."libs/minify".PE;if(empty($this->nominify)&&f($c))i($c);if(!y(C."minify")){function minify($t,$T){return$t;}}$c=M."autoload".PE;if(f($c))i($c);self::$r=[];$d=@glob(N."*/*_*".PE,GLOB_NOSORT);usort($d,function($a,$b){return strcmp(m($a),m($b));});foreach($d as$f){if(p("/([^\/]+)\/([0-9]{2}_([^\.]+)\.php)$/",$f,$m)&&$m[1]==$m[3]){$c=C.$m[1];i($f);if(ce($c)&&t($c)!="\\".t(__CLASS__)){$C=new$c();if($m[1]!="DS"&&empty($this->libs[$m[1]]))$this->libs[$m[1]]=$C;}}}session_name(!empty($this->sessionvar)?$this->sessionvar:"pe_sid");session_start();if(ini_get("session.use_cookies"))setcookie(session_name(),session_id(),time()+$this->timeout,"/");$c=C."User";$u=$c."s";if(!ce($u)||!is_subclass_of($u,$c))$u=$c;$L="pe_u";if(!empty($_SESSION[$L])&&is_object($_SESSION[$L]))self::$user=$_SESSION[$L];else self::$user=$_SESSION[$L]=new$u();self::$client=new Client;if(self::$w){if(isset($R["pe_cancel"])){$this->redirect();}if(isset($R['clear'])){$u=$_SESSION[$L];$_SESSION=[];$_SESSION[$L]=$u;$this->redirect();}if(!empty(self::$user->id)){foreach(["edit","conf"] as$v){if(isset($R[$v])&&self::$user->has($v)){$_SESSION['pe_'.z($v,0,1)]=!empty($R[$v]);$this->redirect();}}}$L="pe_tz";if($this->app=="index"&&empty($_SESSION[$L])&&!isset($R['nojs'])){$c=L("Enable JavaScript");if(empty($R['n'])){$_SESSION['pe_n']=sha1(rand());$this->_r();$g="getTimezoneOffset()";$d="var d%=new Date();d%.setDate(1);d%.setMonth(@);d%=parseInt(d%.$g);";die("<html><script type='text/javascript'>var now=new Date();".s($d,['%'=>'1','@'=>'1']).s($d,['%'=>'2','@'=>'7'])."txt=now.toString().replace(/[^\(]+\(([^\)]+)\)/,\"$1\");document.location.href=\"".$_SESSION["pe_r"].(strpos($S['REQUEST_URI'],"?")===false?"?":"&")."n=".$_SESSION['pe_n']."&t=\"+(-now.$g*60)+\"&d=\"+(d1==d2||(d1<d2&&d1==parseInt(now.$g))||(d1>d2&&d2==parseInt(now.$g))?\"1\":\"0\")+\"&w=\"+screen.availWidth+\"&h=\"+screen.availHeight;</script>$c</html>");}elseif($R['n']==$_SESSION['pe_n']){unset($_SESSION['pe_n']);$_SESSION[$L]=timezone_name_from_abbr("",$R['t']+0,$R['d']+0);$_SESSION['pe_w']=floor($R['w']);$_SESSION['pe_h']=floor($R['h']);$this->redirect();}else die($c);}$d='HTTP_X_FORWARDED_FOR';self::$client->ip=!empty($S[$d])?$S[$d]:$S['REMOTE_ADDR'];self::$client->screen=!empty($_SESSION['pe_w'])?[$_SESSION['pe_w'],$_SESSION['pe_h']]:[0,0];$d='HTTP_USER_AGENT';self::$client->agent=!empty($S[$d])?$S[$d]:"browser";$d='PHP_AUTH_USER';self::$client->user=!empty($S[$d])?$S[$d]:"";}else{$T=getenv("TZ");$d=x("/",$T?$T:@readlink("/etc/localtime"));$c=count($d);$_SESSION[$L]=$c>1?$d[$c-2]."/".$d[$c-1]:"UTC";$c=floor(getenv("COLUMN"));if($c<1)$c=80;$d=floor(getenv("ROW"));if($d<1)$d=25;self::$client->ip="CLI";self::$client->screen=[$c,$d];$d=getenv("TERM");self::$client->agent=!empty($d)?$d:"term";$d=getenv("USER");self::$client->user=!empty($d)?$d:"";$this->needframe=0;if($this->app=="index")$this->app="scripts";}date_default_timezone_set(self::$client->tz=!empty($_SESSION[$L])?$_SESSION[$L]:"UTC");$L='pe_l';$a="";$d=[];if(empty($_SESSION[$L])){$i='HTTP_ACCEPT_LANGUAGE';$d=x(",",s(!empty($S[$i])?$S[$i]:(getenv('LANG')||"en"),"/",""));}if(!empty($R['lang']))$d=[s(r($R['lang']),"/","")];foreach($d as$v){list($a)=x(";",t($v));if(!empty($a)&&(f(P."lang/$a".PE)||f("app/lang/$a".PE))){$_SESSION[$L]=$a;break;}}if(empty($_SESSION[$L]))$_SESSION[$L]="en";self::$client->lang=$i=$_SESSION[$L];$i=x("_",s($i,"-","_"));setlocale(LC_ALL,t($i[0])."_".k(!empty($i[1])?$i[1]:$i[0]).".UTF8");$c=P."js/core.js".PE;if(f($c)){$this->jslib["core.js"]=$c;$this->css["core.css"]=P."css/core.css";}else$this->js["L(t)"]="return t.replace(/_/g,' ');";self::$l=[];LANG_INIT("core");if(!empty($this->libs))foreach($this->libs as$k=>$v){LANG_INIT($k);$c=N."$k/config".PE;if(q($v,"init"))$v->init(f($c)?i($c):[]);}LANG_INIT("app");if(!empty($this->cache)){$C="cache";$c=P."libs/$C".PE;if(f($c))self::$mc=require_once($c);if(!is_object(self::$mc)){$M="\\Mem$C";if(!ce($M))self::log('C',"no php-memcached",$C);$m=x(":",$this->$C);if($m[0]=="unix"){$p=0;$h=$m[1];}else{$p=$m[1]+0;$h=$m[0];}self::$mc=new$M;if(!@self::$mc->pconnect($h,$p,1)){usleep(100);if(!@self::$mc->pconnect($h,$p,1))self::$mc=null;}}self::lib("MC",L(ucfirst($C)),"",self::$mc);}if(!empty($this->db)){self::dbInit($this->db);$d="CURRENT_TIMESTAMP";try{$t=@strtotime(@self::field($d));if($t>0)$this->now=$t;}catch(\Exception$e){}}}function run($n="",$a=""){list($c)=x("?",@$_SERVER['REQUEST_URI']);$s=$_SERVER['SCRIPT_NAME'];$u=w($c,(z($c,0,u($s))==$s?u($s):u(n($s)))+1);if($u[0]=="/")$u=w($c,1);if($u[u($u)-1]=="/")$u=z($u,0,u($u)-1);$C="cache";if(!empty($_GET[$C])){$d=r($_GET[$C]);switch($d){case "logo":c("image/png");$c=P."images/.phppe";die(f($c)?g($c):base64_decode("R0lGODlhKgAYAMIHAAACAAcAABYAAygBDD4BEFwAGGoBGwWYISH5BAEKAAcALAAAAAAqABgAAAOxeLrcCsDJSSkIoertYOSgBmXh5p3MiT4qJGIw9h3BFZP0LVceU0c91sy1uMwkwQfmYEzhiCwc8sh0QQ+FrMFQIAgY2cIWuUx9LoutWsxNs9udaxDKDb+7Wzth+huRRmlcJANrW148NjJDdF2Db2t7EzUUkwpqAx8EaoWRUyCXgVx5L1QUeQQDBGwFhIYDAxNNHJubBQqPBiWmeWqdWG+6EmrBxJZwxbqjyMnHy87P0BMJADs="));case "css":c("text/css");$p="position:fixed;top:";$s="text-shadow:2px 2px 2px #FFF;";die("#pe_p{".$p."0;z-index:99;left:0;width:100%;padding:0 2px 0 32px;background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAgCAMAAADkO+IoAAAAOVBMVEW".str_repeat("Ikr+",17)."Ikr8AAAAXX+LTAAAAEnRSTlP+9fvv49HFuauV6dzYoIh/d265+mQnAAAALElEQVQI1zXBhw3AIAAEsUvovew/LC8kbBaTQSdpI2pQr04rBas Zo9/967MPI5kA2rkqJuwAAAAASUVORK5CYII=') repeat-x center bottom;height:31px !important;font-family:helvetica;font-size:14px !important;line-height:20px !important;}#pe_p SPAN{margin:0 5px 0 0;cursor:pointer;}#pe_p UL{list-style-type:none;margin:3px;padding:0;}#pe_p IMG{border:0;vertical-align:middle;}#pe_p A{text-decoration:none;color:#000;".$s."}#pe_p .menu {position:fixed;top:8px;left:90px;}#pe_p .dock SPAN{".$s."}#pe_p LI{cursor:pointer;}#pe_p LI:hover{background:#F0F0F0;}#pe_p .dock{".$p."6px;right:48px;}#pe_p .sub{".$p."28px;display:inline;background:#FFF;border:solid 1px #808080;box-shadow:2px 2px 6px #000;}#pe_p .menu_i{padding:5px 6px 5px 6px;".$s."}#pe_p .menu_a{padding:4px 5px 5px 5px;border-top:solid #000 1px;border-left:solid #000 1px;border-right:solid #000 1px;background:#FFF;}@media print{#pe_p{display:none;}}");default:if(!empty(self::$mc)){$c=self::$mc->get("c_$d");if(self::$w&&a($c)&&!empty($c['d'])){c((!empty($c['m'])?$c['m']:"text/plain"));die($c['d']);}}die(k($C)."-E: ".$d);}}if(in_array($this->app,["css","js","images"])){function b($a,$b){c($a=="css"?"text/css":($a=="js"?"text/javascript":"image/png"));die(minify($b,$a));}$N='a_'.sha1($this->base.$u."_".self::$user->id."_".self::$client->lang);$d="";if(!empty(self::$mc))$d=self::$mc->get($N);if(!empty($d))b($this->app,$d);else{$a=N."*/".$this->app."/".s($this->action.($this->item?"/".$this->item:""),["*"=>"",".."=>""]);$c=@glob($a,GLOB_NOSORT)[0];if($c&&f($c)&&w($c,-4)!=PE)$d=g($c);else{$c=@glob($a.PE,GLOB_NOSORT)[0];if($c){ob_start();i($c);$d=o();}}if(!empty($d)){if(!empty(self::$mc)&&empty($this->nocache))self::$mc->set($N,$d,MEMCACHE_COMPRESSED,$this->cachettl);b($this->app,$d);}}$c="404 Not Found";header("HTTP/1.1 $c");die(L($c));}self::$o=[];self::$o["core"]=&$this;self::$o["user"]=&self::$user;self::$o["client"]=&self::$client;$this->meta["viewport"]="width=device-width,initial-scale=1";$A=P."ctrl/";$X=[];$w=0;if(!empty($n)){$this->app=$n;$this->action=!empty($a)?$a:"action";$f="";}elseif(!empty($c)&&!empty(self::$r)){uasort(self::$r,function($a,$b){return strcmp($b[0],$a[0]);});foreach(self::$r as$v){if(p("!^".s($v[0],"!","")."!i",$u,$X)){if(!self::_cf($v[3])){$w=1;continue;}array_shift($X);$d=$v[1];$f=$v[2];break;}}}if(empty($d))$d=$w?"403":$this->app;$R=$_REQUEST;if(self::$w){$c=$this->app.".".$this->action;$S=!empty($_SESSION["pe_s"][$c])?$_SESSION["pe_s"][$c]:"";for($i=1;$i<=9;$i++)if(isset($R["pe_try".$i])&&!empty($R["pe_s"])&&$R["pe_s"]==$S){$this->try=$i;$this->form=!empty($R['pe_f'])?r($R['pe_f']):"";break;}$_SESSION["pe_s"][$c]=sha1(uniqid().$this->id);}if(empty($f))$f="action_".t($this->action);if($this->app=="login"||$d=="login"){$A="admin";if($this->istry()&&!empty($R['id'])&&$R['id']==$A){if(!empty($this->masterpasswd)&&empty(self::$user->id)&&password_verify($_POST['pass'],$this->masterpasswd)){self::log("A","Login ".L($A),"Users");$_SESSION["pe_u"]->id=-1;$_SESSION["pe_u"]->name=L($A);$this->redirect();}}if($_SESSION["pe_u"]->id)$this->redirect("/");}elseif($this->app=="logout"||$d=="logout"){$i=self::$user->id;if($i){self::log("A","Logout ".self::$user->name,"Users");if($i!=-1&&q(self::$user,"logout"))self::$user->logout();}session_destroy();$this->redirect("/");}$A=!empty(self::$mc)&&empty($this->nocache);if(!cc($d)){$C=t($d);$D=ucfirst($d);$E=$this->action;$F=t($E);$G=ucfirst($E);$P="app/ctrl/";$H=N."*/ctrl/";foreach(["$P$d"."_"."$E".PE,"$P$C"."_"."$F".PE,"$P$D"."_"."$G".PE,"$P$d".PE,"$P$C".PE,"$P$D".PE,"$H$d"."_"."$E".PE,"$H$C"."_"."$F".PE,"$H$D"."_"."$G".PE,"$H$d".PE,"$H$C".PE,"$H$D".PE] as$v){$c=@glob($v);if(!empty($c[0])){i($c[0]);self::$p=n(n($c[0]));break;}}}$P=C."App";$D="_Ctrl";$V="pe_v";if(cc(C.$d)||cc(C.$d.$D))$d=C.$d;if(cc($d.$D))$d.=$D;$D=[];if(!cc($d)){if(!self::$w)die("PHPPE-C: ".L("action not found!")."\n");$d=$P;if(!empty(Core::db(0))&&f(P."sql/pages.sql")){try{$T="template";$C='d_'.sha1($this->base.$u);if($A)$D=self::$mc->get($C);if(empty($D[$T])){Core::ds(0);$D=Core::fetch("*","pages","(id=? OR ? LIKE id||'/%') AND (lang='' OR lang=?) AND pubd<=CURRENT_TIMESTAMP AND (expd=0 OR expd>CURRENT_TIMESTAMP)","","id DESC,created DESC",[$u,$u,self::$client->lang]);if($A&&!empty($D[$T]))self::$mc->set($C,$D,MEMCACHE_COMPRESSED,$this->cachettl);}if(!empty($D[$T])){if(!self::_cf($D['filter'])){$this->$T="403";throw new\Exception();}$c=C."Content";if(ce($c)){$d=$c;$f=$D[$T];}Core::$core->template=$D[$T];$o=@jd($D['data']);if(!a($o))$o=[];$c=w($u,u($D['id'])+1);$o['params']=x("/",$c);}}catch(\Exception$e){$D=[];}}}$p=s($d,["PHPPE\\"=>"","_Ctrl"=>""]);foreach([$p,ucfirst($p),$this->app,ucfirst($this->app)] as$C){$c=@include(N."$C/config".PE);if(a($c))break;}if(!empty($_SESSION[$V]))self::$v=$_SESSION[$V];self::$o["app"]=$app=new$d(a($c)?$c:[]);if(!q($app,$f))$f="action";self::log("D",$this->app."/".$this->action." ->$d::$f ".$this->template,"routes");$A&=empty($this->nocache);$m="maintenance";if(empty($this->$m)||!self::$w){$C='p_'.sha1($this->base.$u."_".self::$user->id."_".self::$client->lang);$T="";if($A&&!self::istry()){$p=self::$mc->get($C);if(a($p)){foreach(['m'=>'meta','c'=>'css','j'=>'js','J'=>'jslib'] as$k=>$v)if(a($p[$k]))$this->$v=array_merge($this->$v,$p[$k]);$T=$p['d'];}}if(!$T){if(!empty($D)){$d="dds";$l="template";$p=jd($D[$d]);$e=Core::query("a.id as l,b.id,b.filter,b.$l,b.data,b.dds","pages_list a left join pages b on a.page_id=b.id","a.parent_id=''","","a.id,ordering");foreach($e as$c)if(self::_cf($c['filter'])){$v=@jd($c['data']);unset($v['meta']);$v['id']=$c['id'];$v[$l]=$c[$l];$o[$c['l']][]=$v;if($c['l']=='frame')@$p+=jd($c[$d]);}if(a($p)){foreach($p as$k=>$c)if($k!=$d)$o[$k]=Core::query($c[0],$c[1],@$c[2],@$c[3],@$c[4],@$c[5],@$c[6]);}foreach($o as$k=>$v)if($k!=$d)$app->$k=$v;$this->site=$D['name'];}if(q($app,$f))!empty($X)?call_user_func_array([$app,$f],$X):$app->$f($this->item);if(!empty($app->meta))$this->meta=array_merge($this->meta,$app->meta);$_SESSION[$V]=[];if(!empty($this->template)){$T=$this->template($this->template);if(!$T)$T=$this->template($this->app);if(!$T&&self::$w)$T=$this->template("404");}if($this->needframe){$d=$this->template("frame");if(p("/<!app>/ims",$d,$m,PREG_OFFSET_CAPTURE))$T=z($d,0,$m[0][1]).$T.w($d,$m[0][1]+6);}if($A&&$T)self::$mc->set($C,["m"=>$this->meta,"c"=>$this->css,"j"=>$this->js,"J"=>$this->jslib,"d"=>$T],MEMCACHE_COMPRESSED,$this->cachettl);}}else{$T=$this->template($m);if(empty($T))$T=L(ucfirst($m));}if((@in_array("--dump",$_SERVER['argv'])||isset($R['--dump']))&&$this->runlevel>1){c("text/plain");foreach([$_SERVER,self::$client,self::$user,$this,$app] as$v)print_r($v);die();}self::dbClose();$o=isset($app->output)?$app->output:$this->output;if(self::$w){header("Cache-Control:no-cache,no-store,private,must-revalidate,max-age=0");header("Content-Type:".(!empty($app->mimetype)?$app->mimetype:"text/".(!empty($o)?$o:"html")).";charset=utf-8");}if(!empty($o)){if($o=="html"){$P=$this->needframe&&self::$user->has("panel");$O="";$I=m(__FILE__);if($I=="index.php")$I="";$O.="<!DOCTYPE HTML>\n<html>\n<head>\n<title>".(!empty($this->site)?$this->site:$this->id)."</title>\n<base href='http".($this->sec?"s":"")."://".$this->base."/'/>\n<meta charset='utf-8'/>\n<meta name='Generator' content='".$this->id."'/>\n";foreach($this->meta as$k=>$m)$O.="<meta name='$k' content='".h($m)."'/>\n";$O.="<link rel='shortcut icon' href='favicon.ico' type='image/png'/>\n";$c="css/".(!empty(self::$user->skin)&&f("css/".self::$user->skin.".css")?self::$user->skin:"default").".css";$O.="<style media='all'>\n";$d="@import url('%s');\n";$N=$this->base."_".$this->app.".".$this->action."_".self::$user->id."_".self::$client->lang;if($P)$O.=sprintf($d,"$I?cache=css");if(!empty($this->css)){if(!empty(self::$mc)&&empty($this->noaggr)){$n=sha1($N."_css");if(empty(self::$mc->get("c_$n"))){$da="";foreach($this->css as$u=>$v)if($v&&w($v,-3)!="php")$da.=minify(r(g($v)),"css")."\n";self::$mc->set("c_$n",["m"=>"text/css","d"=>$da],MEMCACHE_COMPRESSED);}$O.=sprintf($d,"$I?cache=$n");foreach($this->css as$u=>$v)if($v&&w($v,-3)=="php")$O.=sprintf($d,"css/$u");}else{foreach($this->css as$u=>$v)if($v)$O.=sprintf($d,"css/$u");}}if(f($c))$O.=sprintf($d,$c);$O.="</style>\n";$d="<script type='text/javascript'";$e="</script>\n";$a=" async src='js/";if(!empty($this->jslib)){if(!empty(self::$mc)&&empty($this->noaggr)){$n=sha1($N."_js");if(empty(self::$mc->get("c_$n"))){$da="";foreach($this->jslib as$u=>$v)if($v&&w($v,-3)!="php")$da.=minify(r(g($v)),"js")."\n";self::$mc->set("c_$n",["m"=>"text/javascript","d"=>$da],MEMCACHE_COMPRESSED);}$O.="$d async src='$I?cache=$n'>$e";foreach($this->jslib as$u=>$v)if($v&&w($v,-3)=="php")$O.="$d$a$u'>$e";}else{foreach($this->jslib as$u=>$v)if($v)$O.="$d$a$u'>$e";}}$c="users.js";if($P&&!isset($this->jslib[$c])&&f(N."Users/js/".$c.PE))$O.="$d$a$c'>$e";$c=$this->js;$a="";if($P&&empty($this->jslib["core.js"])){$x="document.getElementById('pe_'";$y=".style.visibility";$a="pe_t=setTimeout(function(){pe_p('');},2000)";$c['pe_p(i)']="var o=$x+i);if(pe_t!=null)clearTimeout(pe_t);if(pe_c&&pe_c!=i)$x+pe_c)$y='hidden';pe_t=pe_c=null;if(o!=null){if(o$y=='visible')o$y='hidden';else{o$y='visible';pe_c=i;$a;}}return false;";$c['pe_w()']="if(pe_t!=null)clearTimeout(pe_t);$a;return false;";$a="var pe_t,pe_c;\n";}if(!empty($c)){$O.=$d.">\n$a";foreach($c as$fu=>$co)$O.="function $fu {".$co."}\n";$O.=$e;}$O.="</head>\n<body".(!empty($this->js["init()"])?" onload='init();'":"").">\n";if($P){$H=" class='sub' style='visibility:hidden;' onmousemove='return pe_w();'";$O.="<div id='pe_p'><a href='".url("/")."'><img src='$I?cache=logo' alt='".$this->id."' style='margin:3px 10px -3px 10px;'></a><div class='menu'>";$x=0;if(!empty($this->menu)){foreach($this->menu as$e=>$L){@list($ti,$a)=x("@",$e);if(!empty($a)&&!self::$user->has($a))continue;$a=0;if(a($L))$l=$L[array_keys($L)[0]];else$l=$L;$U=$_SERVER['REQUEST_URI'];if(z($l,0,u($U))==$U||"/".z($l,0,u($U))==$U)$a=1;else{$d=x("/",$l);if(empty($d[0]))$d=array_shift($d);if($this->app==(!empty($d[0])?$d[0]:"index"))$a=1;unset($d);}if(a($L)){$O.="<div id='pe_m$x'$H><ul>";foreach($L as$t=>$l){@list($Y,$A)=x("@",$t);if(empty($A)||self::$user->has($A))$O.="<li onclick=\"document.location.href='$l';\"><a href='$l'>".h(L($Y))."</a></li>";}$O.="</ul></div><span class='menu_".($a?"a":"i")."' onclick='return pe_p(\"m$x\");'>".h(L($ti))."</span>";$x++;}else$O.="<span class='menu_".($a?"a":"i")."'><a href='$L'>".h(L($ti))."</a></span>";}}$O.="</div><div class='dock'>";if(!empty($this->libs))foreach($this->libs as$d)if(q($d,"dock"))$O.="<span>".$d->dock()."</span>";$O.="<div id='pe_l'$H><ul>";if(!empty($_SESSION['pe_ls']))$d=$_SESSION['pe_ls'];else{$D=@scandir("app/lang");if(!a($D)||empty($D))$D=@scandir(P."lang");$d=[];foreach($D as$f)if(w($f,-4)==".php")$d[z($f,0,u($f)-4)]=1;$_SESSION['pe_ls']=$d;}foreach($d as$k=>$v)if($k)$O.="<li><a href='".url()."?lang=$k'><img src='images/lang_$k.png' alt='$k' title='$k'>".($k!=L($k)?"&nbsp;".L($k):"")."</a></li>";$O.="</ul></div>";$k=self::$client->lang;$f="images/lang_$k.png";$c=!empty($_SESSION['pe_c']);$O.="<span onclick='return pe_p(\"l\");'>".(f(P.$f)?"<img src='$f' height='10' alt='$k' title='$k'>":$k)."</span>"."<div id='pe_u'$H><ul><li onclick='pe_p(\"\");if(typeof users_profile==\"function\")users_profile(this);else alert(\"".L("Install PHPPE Pack")."\");'>".L("Profile")."</li>".(self::$user->has("conf")?"<li><a href='".url()."?conf=".(1-$c)."'>".L(($c?"Lock":"Unlock"))."</a></li>":"")."<li><a href='".url("logout")."'>".L("Logout")."</a></li></ul></div><span onclick='return pe_p(\"u\");'>".(!empty(self::$user->name)?self::$user->name:"#".self::$user->id)."</span></div></div><div style='height:32px !important;'></div>\n";}echo$O;}else{$c=@glob(N."*/out/".$o."_header".PE);if(!empty($c[0]))i($c[0]);}}echo($T);if(!empty($o)){if($o=="html"){$D=count($this->error);$d='REQUEST_TIME_FLOAT';$T=!empty($_SERVER[$d])?$_SERVER[$d]:$this->started;if($D>0&&$this->neederror){$c="";foreach($this->error as$v)$c.=implode("\n",$v)."\n";echo("<script type='text/javascript'>\nalert('".s(addslashes(r($c)),"\n","\\n")."');\n</script>\n");}echo("\n<!-- MONITORING: ".($D>0?"ERROR":($this->runlevel>0?"WARNING":"OK")).", page ".sprintf("%.4f sec, db %.4f sec, server %.4f sec, mem %.4f mb%s -->\n</body>\n</html>\n",microtime(1)-$T,self::$bill,$this->started-$T,memory_get_peak_usage()/1024/1024,!empty(self::$mc)?", mc":""));}else{$c=@glob(N."*/out/".$this->output."_footer".PE);if(!empty($c[0]))i($c[0]);}}session_write_close();}static function langInit($c=""){if($c=="")$c=m(n(n(d(2))));$L=empty(self::$client->lang)?"en":self::$client->lang;$i=x("_",s($L,"-","_"));$la="";$c=N."$c/lang/";foreach([$L,$i[0],"en"] as$l){if(f($c.$l.PE)){$la=i($c.$l.PE);break;}}if(a($la))self::$l+=$la;}static function log($w,$m,$n=null){if(self::$core->runlevel<3&&$w=="D")return;$w=k($w);if(!in_array($w,["D","I","A","W","E","C"]))$w="A";if(empty($n))$n=!empty(self::$core->app)?self::$core->app:"phppe";$m=r($m);$g=!empty(self::$l[$m])?L($m):$m;$t="";if(!empty(self::$core->trace)){$s=debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS);$l=u(n(__DIR__))+1;foreach($s as$d){$c=w($d['file'],$l);$t.="\t$c:".$d['line'].":".$d['function']."\n";}}$e=e(0);date_default_timezone_set("UTC");$p=date("Y-m-d")."T".date("H:i:s")."Z-$w-".k($n).": ";if($w=="A"||$w=="C"||self::$core->syslog)syslog($w=="C"?LOG_ERR:LOG_NOTICE,self::$core->base.":PHPPE-$w-".k($n).": ".s($m,["\n"=>"\\n","\r"=>"\\r"]).s($t,"\n",""));$l=P."log/".$n.".log";if(!self::$core->syslog&&!file_put_contents($l,$p.s($m,["\n"=>"\\n","\r"=>"\\r"])."\n".$t,FILE_APPEND|LOCK_EX)){$w="C";$g.=(!self::$w?"\nLOG-C":"<br/>\n".date("Y-m-d")."T".date("H:i:s")."Z-C-LOG").": ".L("unable to write")." $l";}if($w=="C"){if(self::$core->output!="html")die(k("$n-C").": ".$g."\n".$t);die("\n<html><body style='margin:8px;background:#000000;color:#A00000;'>"."<div style='text-align:center;font-size:28px;color:#ff0000;'>PHPPE".VERSION." - ".L("Developer Console")."</div><br/><br/>\n".$p.nl2br($g."\n".s($t,"\t","&nbsp;&nbsp;"))."</body></html>\n");}elseif(!self::$w&&$w!="D"&&$w!="I")fwrite(STDERR,k("$n-$w").": ".$g."\n");date_default_timezone_set($_SESSION['pe_tz']);e($e);return true;}static function lib($n="",$l="",$D="",&$o=null){$L=&self::$core->libs;if($l==""&&empty($D)&&!$o)return empty($n)?$L:$L[$n];$d="";if(empty($n)){$n=m(d(1));if(p("/([0-9]+\_)?([^\/\_]+)([^\/]*)\.php$/i",$n,$m))$n=$m[2];unset($m);}if($D){if(!a($D))$D=x(",",$D);foreach($D as$v)if(!self::isinst($v))$d.=($d?",":"").$v;if($d)self::log("C","$n ".L("depends on").": $d");}if(!$d&&$n){if(empty($L[$n]))$L[$n]=$o?$o:new\StdClass();$L[$n]->name=L(empty($l)?$n:$l).(!empty($o->version)?" (".$o->version.")":"");}}static function addon($n="",$l="",$D="",$c=""){if(empty($n)){$S=[self::$core->addons,self::$core->js,self::$core->jslib,self::$core->css];$d=@glob(N."*/addons/*".PE);foreach($d as$f){$F=m($f);$d=i($f);$w=z($F,0,u($F)-4);$W=A.$w;if(ce($W)){self::addon($w,"addon $w");if(q($W,"init")){$W=new$W([],$w,$w);$W->init();unset($W);}}}$r=self::$core->addons;list(self::$core->addons,self::$core->js,self::$core->jslib,self::$core->css)=$S;return$r;}$d="";if($D){if(!a($D))$D=x(",",$D);foreach($D as$v)if(!self::isinst($v))$d.=($d?",":"").$v;}if(empty($d)){self::$core->addons[$n]=(object)['name'=>L(empty($l)?$n:$l),'conf'=>$c];LANG_INIT($n);}else self::log("E","$n ".L("depends on").": $d");}static function isInst($n){return(isset(self::$core->libs[$n])||isset(self::$core->addons[$n])||ce(C.$n)||ce(A.$n)||!empty(@glob(N."*/addons/".$n.PE)[0]));}static function e($w,$c,$m){return!empty(self::$core->output)&&self::$core->output=="html"?"<span style='background:#F00000;color:#FEA0A0;padding:3px;'>".($w?"$w-":"").($c?"$c:&nbsp;":"").h($m)."</span>":"$c-$w: ".s($m,["\r"=>"","\n"=>"\\n"])."\n";}static function error($m,$f=""){if(!isset(self::$core->error[$f]))self::$core->error[$f]=[];self::$core->error[$f][r($m)]=r($m);if(self::$core->runlevel>1)self::log("E",$f."@".$_SERVER['REQUEST_URI']." ".$m,"validate");}static function isError($f=""){return!empty($f)?isset(self::$core->error[$f]):!empty(self::$core->error);}static function route($u="",$n="",$a="",$f=[]){if(empty($u))return self::$r;$A="action";$F="filters";$U="url";$N="name";if(is_string($u)&&!empty($n)){if(!a($f))$f=x(",",$f);self::$r[j($u,$n,$a)]=[$u,$n,$a,$f];}elseif(a($u)&&!empty($u[$U])&&!empty($u[$N])){$f=!empty($u[$F])?$u[$F]:[];$a=!empty($u[$A])?$u[$A]:"";self::$r[j($u[$U],$u[$N],$a)]=[$u[$U],$u[$N],$a,a($f)?$f:x(",",$f)];}elseif(a($u)&&!empty(current($u)[0])){foreach($u as$v)self::$r[j($v[0],$v[1],(!empty($v[2])?$v[2]:""))]=$v;}elseif(is_object($u)&&!empty($u->$U)&&!empty($u->$N)){$f=!empty($u->$F)?$u->$F:[];$a=!empty($u->$A)?$u->$A:"";self::$r[j($u->$U,$u->$N,$a)]=[$u->$U,$u->$N,$a,a($f)?$f:x(",",$f)];}else self::log("W","bad route: ".serialize($u));if(count(self::$r)>=512)self::log("C","too many routes");}static function isTry($f=""){return empty($f)||$f==self::$core->form?self::$core->try:0;}static function mc(){return self::$mc;}static function url($m="",$p=""){$c=self::$core->base;$f=m(__FILE__);if(empty($m)&&!empty(self::$core->app))$m=self::$core->app;if(empty($p)&&!empty(self::$core->app)&&self::$core->app==$m)$p=self::$core->action;$a=($m!="/"?($m.$p!="indexaction"?$m."/":"").(!empty($p)&&$p!="action"?$p."/":""):"");return "http".(self::$core->sec?"s":"")."://".$c.($c[u($c)-1]!="/"?"/":"").($f!="index".PE?$f.($a?"/":""):"").$a;}static function redirect($u="",$s=0){if($s)self::_r();if(empty($u)&&!empty($_SESSION["pe_r"])){$u=$_SESSION["pe_r"];unset($_SESSION["pe_r"]);}session_write_close();header("HTTP/1.1 302 Found");$f=m(__FILE__);header("Location:".(!empty($u)?(strpos($u,"://")?$u:"http".(self::$core->sec?"s":"")."://".self::$core->base.($f!="index".PE?"/".$f:"").($u&&$u[0]!="/"?"/":"").$u):self::url().self::$core->item));exit();}static function get($u,$p="",$T=30,$l=0){static$C;if($l>7)return;if(p("/^([^\:]+)\:\/\/([^\/\:]+)\:?([0-9]*)(.*)$/",$u,$m)){$s=0;if($m[1]!="http"&&$m[1]!="https")return;if($m[1]=="https"){$s=1;$m[2]="ssl://".$m[2];}if($m[3]=="")$m[3]=($m[1]=="http"?80:443);if($m[4]=="")$m[4]="/";$f=fsockopen($m[2],$m[3],$n,$e,$T);if(!$f){self::log("E","$u #$n $e","http");return($s&&strpos($e,'"ssl"')?file_get_contents($u):"");}$P=a($p)?http_build_query($p,"_"):"";$o=($P?"POST":"GET")." ".$m[4]." HTTP/1.0\r\nHost: ".$m[2]."\r\nAccept-Language: ".self::$client->lang.";q=0.8\r\n".($C?"Cookie: ".http_build_query($C,"",";")."\r\n":"").($P?"Content-Type: application/x-www-form-urlencoded\r\nContent-Length: ".u($P)."\r\n":"")."Connection: close;\r\n\r\n".$P;fwrite($f,$o);$d=$H=$n="";$h="-";$t=0;stream_set_timeout($f,$T);while(!feof($f)&&r($h)!=""){$h=r((fgets($f,4096)));if(!empty($h))$H=t($h);if(z($H,0,8)=="location"){$n=r(w($h,9));}if(z($H,0,12)=="content-type"&&strpos($h,"text/"))$t=1;if(z($H,0,10)=="set-cookie"){$c=x("=",x(";",r(w($h,11)))[0]);@$C[$c[0]]=$c[1];}}if($n&&$n!=$u)return self::get($n,$p,$T,$l+1);if($H)while(!feof($f))$d.=fread($f,65535);else self::log("E","$u. timed out $T","http");fclose($f);return$t?s($d,"\r",""):$d;}}static function si($i){$v=r(ini_get($i));$l=t($v[u($v)-1]);switch($l){case 't':$v*=1024;case 'g':$v*=1024;case 'm':$v*=1024;case 'k':$v*=1024;}return$v;}static function validate($f,$v,$r=0,$a=[],$t=[]){if(q(A.$v,"validate"))self::$v[$f][$v]=[!empty($r),$a,$t];}static function req2arr($p,$V=[]){return self::req2obj($p,$V,1);}static function req2obj($p,$V=[],$a=0){if($a)$o=array();else$o=new\stdClass();if(!empty(self::$v))$V+=self::$v;$R=$_REQUEST;$E="error";foreach($V as$K=>$v){if(z($K,0,u($p)+1)==$p."."){$d=w($K,u($p)+1);$r=$p."_".$d;foreach($v as$T=>$C){if(($T=="check"||!empty($C[0]))&&empty($R[$r]))$R[$r]=$T=="check"?false:"";elseif(($T=="date"||$T=="time")&&!empty($R[$r.":y"]))list($R[$r])=AddOn\date::validate($K,$r,$C[1],$C[2]);elseif($T=="file"){$f=empty($_FILES[$r])?[]:$_FILES[$r];if(!empty($f[$E])&&$f[$E]!=4)self::error(L(ucfirst($d))." ".L("failed to upload file."),$K);$R[$r]=isset($f[$E])&&$f[$E]==0?$f:[];}}}}ksort($R);foreach($R as$k=>$v){if(z($k,0,u($p)+1)==$p."_"&&$k[u($k)-2]!=":"){$d=w($k,u($p)+1);$K=$p.".".$d;if(isset($V[$K])){foreach($V[$K] as$T=>$C){$t=A.$T;if($T=="num")$v+=0.0;if($T=="check")$v=$v?($v==1||$v=='1'?true:$v):false;if(!empty($C[0])&&empty($v))self::error(L(ucfirst($d))." ".L("is a required field."),$K);elseif(!empty($v)&&q($t,"validate")){list($r,$m)=$t::validate($K,$v,$C[1],$C[2]);if(!$r&&$m){list($O,$f)=x(".",$K);self::error(L(ucfirst(!empty($f)?$f:$O))." ".L($m),$K);}}}}if($a)$o[$d]=$v;else$o->$d=$v;}}return$o;}static function arr2str($o,$s="",$c=" "){return self::obj2str($o,$s,$c);}static function obj2str($o,$s="",$c=" "){if(!a($s))$s=x(",",$s);$r="";$d=Core::db();foreach($o as$k=>$v){if(!in_array($k,$s))$r.=($r?$c:"").$k."=".($c==","&&!empty($d)?$d->quote($v):"'".str_replace(["\r","\n","\t","\x1a"],["\\r","\\n","\\t","\\x1a"],addslashes($v))."'");}return$r;}static function val2arr($s,$c=","){if(a($s))return$s;elseif($s!=""){$v=self::getval($s);if(a($v))return$v;return x($c,$v);}return null;}static function tre2arr($t,$p="  ",$s="",$P="",$S="",&$d=null){foreach($t as$v){$i=count($d);foreach($v as$k=>$w){if($k!="_"){$c=t($k)=="name"&&!$s?$P.$w.$S:$w;if(a($v))$d[$i][$k]=$c;elseif(is_object($v))$d[$i]->$k=$c;}}if(a($v)&&!empty($v["_"])||is_object($v)&&!empty($v->_)){if($s){$c="\n".sprintf($p,$i);if(a($d[$i])&&isset($d[$i]["name"]))$d[$i]["name"].=$c;elseif(is_object($d[$i])&&isset($d[$i]->name))$d[$i]->name.=$c;}$d=self::tre2arr(a($v)?$v["_"]:$v->_,$p,$s,$P.($s?"":$p),($s?"":$s).$S,$d);if($s){$c="\n".$s;if(a($d[count($d)-1])&&isset($d[count($d)-1]["name"]))$d[count($d)-1]["name"].=$c;elseif(is_object($d[count($d)-1])&&isset($d[count($d)-1]->name))$d[count($d)-1]->name.=$c;}}}return$d;}static function dbInit($u,$O=null){$S=microtime(1);try{if(!p("/^(.*)@([^@:]+)?:?([^:]*)$/",$u,$d))$d[1]=$u;if(!a(self::$db))self::$db=[];self::$sel=count(self::$db);self::$db[]=is_object($O)?$O:new\PDO($d[1],!empty($d[2])?$d[2]:"",!empty($d[3])?$d[3]:"",[\PDO::ATTR_ERRMODE=>\PDO::ERRMODE_EXCEPTION,\PDO::ATTR_EMULATE_PREPARES=>0]);if(!isset(self::$db[self::$sel]))throw new\Exception();$d=&self::$db[self::$sel];$d->id=count(self::$db);$d->name=is_object($O)?get_class($O):$d->getAttribute(\PDO::ATTR_DRIVER_NAME);if(!isset(self::$core->libs["DS"])){self::lib("DS","DataSource");self::$core->libs["DS"]->primary=$d->name;}$c=x(";",g(P."sql/_init.".$d->name.".sql").";".g("app/sql/_init.".$d->name.".sql"));foreach($c as$n=>$C)if(!empty(r($C)))$d->exec(r($C));}catch(\Exception$e){self::log(self::$sel?"E":"C","Unable to init: $u, ".$e->getMessage(),"phppe");throw$e;}self::$bill+=microtime(1)-$S;return self::$sel;}static function dbClose(){$S=microtime(1);if(!empty(self::$db))foreach(self::$db as$d)if(q($d,"close"))$d->close();self::$sel=0;self::$db=[];self::$bill+=microtime(1)-$S;}static function ds($s=-1){if($s>=0&&$s<count(self::$db)&&!empty(self::$db[$s]))self::$sel=$s;return self::$sel;}static function db($s=-1){if($s==-1)$s=self::$sel;if($s>=0&&$s<count(self::$db)&&!empty(self::$db[$s]))return self::$db[$s];return null;}static function like($s){return pr("/[%_]+/","%","%".pr("/[^a-z0-9\%]/i","_",pr("/[\ \t]+/","%",s(r($s),"%","")))."%");}static function exec($q,$a=[]){if(empty(self::$db[self::$sel])||empty($q)||!a($a))throw new\Exception("Invalid ds");self::log("D",$q." ".json_encode($a),"db");$t=microtime(1);$r=null;$h=self::$db[self::$sel];try{$i=t(z(r($q),0,6))=="select";$s=$h->prepare($q);$s->execute($a);$r=$i?$s->fetchAll(\PDO::FETCH_ASSOC):$s->rowCount();}catch(\Exception$e){$E=$e->getMessage();if((p("/able:?\ [\'\"]?([a-z0-9_\.]+)/mi",s($E,"le or v",""),$d)||p("/([a-z0-9_\.]+)[\'\"] does\ ?n/mi",$E,$d)||p("/name:?\ [\'\"]?([a-z0-9_\.]+)/mi",$E,$d))&&!empty($d[1])){$c="";$m=".".t($h->name);$d=x(".",$d[1]);$d=r(!empty($d[1])?$d[1]:$d[0]);list($D)=x("_",$d);foreach(["app/sql/$d",self::$p?self::$p."/sql/$d":"",N."$D/sql/$d",N.ucfirst($D)."/sql/$d",P."sql/$d",N.self::$core->app."/sql/$d"] as$f){if($f&&f("$f$m.sql")){$c=g("$f$m.sql");break;}if($f&&f("$f.sql")){$c=g("$f.sql");break;}}if(empty($c)){self::log("C",$E,"db");throw$e;}$c=x(";",$c);foreach($c as$n=>$C){try{if(!empty(r($C)))$h->exec(r($C));}catch(\Exception$e){self::log("C","creating $d line:".($n+1)." ".$e->getMessage(),"db");}}self::log("A","$d created.","db");$s=$h->prepare($q);$s->execute($a);$r=$i?$s->fetchAll(\PDO::FETCH_ASSOC):$s->rowCount();}else{self::log("E",$q." ".json_encode($a)." ".$E,"db");$r=null;throw$e;}}self::$bill+=microtime(1)-$t;return$r;}static function query($f,$t,$w="",$g="",$o="",$s=0,$l=0,$a=[]){$q="SELECT ".$f.($t?" FROM ".$t:"").($w?" WHERE ".$w:"").($g?" GROUP BY ".$g:"").($o?" ORDER BY ".$o:"").($l?(" LIMIT ".($s?$s.",":"").$l):"").";";return self::exec($q,$a);}static function fetch($f,$t="",$w="",$g="",$o="",$a=[]){$r=self::query($f,$t,$w,$g,$o,0,1,$a);return empty($r[0])?[]:$r[0];}static function field($f,$t="",$w="",$g="",$o="",$a=[]){return reset(self::fetch($f,$t,$w,$g,$o,$a));}static function tree($q,$p=0){$r=self::exec($q,[$p]);if(empty($r))return[];foreach($r as$k=>$v){$i=isset($v['id'])?$v['id']:-1;if(!empty($i)&&$i!=$p){$c=self::tree($q,$i);if(!empty($c))$r[$k]["_"]=$c;}}return$r;}static function css($c=""){if(empty($c))return self::$core->css;$a=n(d(1));if(in_array(m($a),["ctrl","libs","js","css","addons"]))$a=n($a);$a.="/css/".$c;if(!f($a))$a.=".php";if(!isset(self::$core->css[$c])&&f($a))self::$core->css[$c]=realpath($a);}static function jslib($l="",$i=""){if(empty($l))return self::$core->jslib;$a=n(d(1));if(in_array(m($a),["ctrl","libs","js","css","addons"]))$a=n($a);$a.="/js/".$l;if(!f($a))$a.=".php";if(!isset(self::$core->jslib[$l]))self::$core->jslib[$l]=realpath($a);if(!empty($i)&&(empty(self::$core->js["init()"])||strpos(self::$core->js["init()"],r($i))===false)){$i=r($i);self::js("init()",$i.($i[u($i)-1]!=";"?";":""),true);}}static function js($f="",$c="",$a=0){$C=r($c);$C.=($C[u($C)-1]!=";"?";":"");if($a){if(!isset(self::$core->js[$f]))self::$core->js[$f]="";if(strpos(self::$core->js[$f],$C)===false)self::$core->js[$f].=$C;}else self::$core->js[$f]=$C;}static function menu($t="",$l=""){if(is_string($l)||a($l))self::$core->menu[$t]=$l;}static function picture($o,$n,$w,$h,$c=0,$l=1,$W="",$s=8192,$m=5){$d=g($o);if(!y("gd_info")||empty($d)||!($i=@imagecreatefromstring($d))){Core::log('W',"no php-libgd or bad image: $o","picture");if(f($o))@copy($o,$n);return false;}$x=imagesx($i);$y=imagesy($i);$q=9;$m=($m>0&&$m<10?$m:5);$s=($s>64?$s:64)*1024;$j="imagepng";if(!$l){$j="imagejpeg";$m*=10;$q=99;}Core::log('D',$o."($x,$y) -> ".$n."($w,$h,".($c?"crop":"resize").",$j,$s,$q) $W","picture");if(!$c){$X=$x<$y?floor(($h/$y)*$x):$w;$Y=$x<$y?$h:floor(($w/$x)*$y);$c=$d=0;$e=$x;$f=$y;}else{$X=$w;$Y=$h;$c=$x>$y?floor(abs($x-$y)/2):0;$d=$x>$y?0:floor(abs($y-$x)/2);$e=$x>$y?floor($w*$y/$h):$x;$f=$x>$y?$y:floor($w*$x/$h);}$N=imagecreatetruecolor($X,$Y);if($l){imagealphablending($N,0);$a=imagecolorallocatealpha($N,255,255,255,255);imagesavealpha($N,1);}else$a=imagecolorallocate($N,255,255,255);imagefill($N,0,0,$a);imagecopyresampled($N,$i,0,0,$c,$d,$X,$Y,$e,$f);if(!empty($W)&&f("data/".$W.".png")){$g=imagecreatefrompng("data/".$W.".png");$a=imagesx($g);$b=imagesy($g);for($y=0;$y<$Y;$y+=$a)for($x=0;$x<$X;$x+=$a)imagecopyresampled($N,$g,$x,$y,0,0,$a,$b,$a,$b);}@unlink($n);while(!f($n)||(filesize($n)>$s&&$q>=$m)){@unlink($n);if(!$j($N,$n,$q--)){@copy($o,$n);return false;}}return true;}static function template($n){if($n=="403"||$n=="404")header("HTTP/1.1 $n ".($n=="403"?"Access Denied":"Not Found"));$d=self::_gt($n);if(empty($d))return "";self::$n=-1;self::$c=[];return self::_t($d);}static function getval($x){if(strpos($x,"$")!==false||p("/[^!=]=[^=]/",$x))return self::e("W","BADINP",$x);$l=$r="";$d=$x;for($i=0;$i<u($d);$i++){$c=$d[$i];if($c=='"'||$c=="'"){$r.=$c;$i++;$b="";while($i<u($d)&&$b!=$c){if($b=="\\")$b.=$d[++$i];$r.=$b;$b=$d[$i++];}$r.=$c;$l="";}if((ctype_alpha($c)||$c=="_")&&!ctype_alnum($l)&&$l!="."&&$l!="_"){$j=$i;$b=$d[$j];while($b&&(ctype_alnum($b)||$b=="_")){$j++;$b=isset($d[$j])?$d[$j]:"";}if($b!="("&&$b!=":"){$v=z($d,$i,$j-$i);switch($v){case "KEY":case "IDX":case "VALUE":if(isset(self::$c[self::$n]->$v))$v=self::$c[self::$n]->$v;if(a($v))return$v;@$r.="'".$v."'";$i=$j;break;case "ODD":$r.=self::$c[self::$n]->IDX%2;$i=$j;break;case "parent":$Y=self::$n-1;while(z($d,$j,7)==".parent"){$j+=7;$Y--;}$n=z($d,$j+1,3);$j+=4+($n=="VAL"?2:0);if($n=="ODD")$v=self::$c[$Y]->IDX%2;elseif(isset(self::$c[$Y]->$n))$v=self::$c[$Y]->$n;elseif(isset(self::$c[$Y]->VALUE->$n))$v=self::$c[$Y]->VALUE->$n;elseif(isset(self::$c[$Y]->VALUE[$n]))$v=self::$c[$Y]->VALUE[$n];else$v="";$r.="'".$v."'";$i=$j;break;case "true":case "false":case "null":break;default:if(isset(self::$c[self::$n])&&a(self::$c[self::$n]->VALUE)){@$r.="'".self::$c[self::$n]->VALUE[$v]."'";$i=$j;}elseif(isset(self::$c[self::$n]->VALUE->$v)){@$r.="'".self::$c[self::$n]->VALUE->$v."'";$i=$j;}else{$r.="\$";$f[$v]=1;}}}elseif($b=="("&&($j-$i!=1||$d[$i]!="L")&&z($d,$i,5)!="core."&&z($d,$i,$j-$i)!="array"&&!empty(self::$core->allowed)&&!in_array(z($d,$i,$j-$i),self::$core->allowed))return self::e("E","BADFNC",$x);}$r.=($c=="."?"->":(isset($d[$i])?$d[$i]:""));$l=$c;}$r=s($r,["+'"=>".'","+\""=>".\"","'+"=>"'.","\"+"=>"\"."]);if(!empty($f)){foreach($f as$k=>$v){if(!isset($$k)&&isset(self::$o[$k]))$$k=self::$o[$k];elseif(!isset($$k)&&isset(self::$o["app"]->$k))$$k=self::$o["app"]->$k;}}try{$e=e();e($e&~E_NOTICE);ob_start();$R=eval("return ".$r.";");$o=o();e($e);if(self::$core->runlevel>2||!empty($o))self::log(!empty($o)?"E":"D",$x." => ".$r." = ".serialize($R),"php");}catch(\Exception$E){self::log("E",$E->getMessage()." ".$r,"php");}return$R;}static function assign($n,&$o){self::$o[$n]=&$o;}static function _r(){$_SESSION['pe_r']="http".(self::$core->sec?"s":"")."://".$_SERVER["SERVER_NAME"].$_SERVER["REQUEST_URI"];}static function _cf($c){if(!a($c))$c=x(",",$c);if(!empty($c))foreach($c as$F){$F=r($F);$G="filter_$F";if(!empty($F)&&(($F[0]=='@'&&!self::$user->has(w($F,1)))||($F[0]!='@'&&(!y($G)||!$G())))){return false;}}return true;}static function _tc(){return++self::$tc;}function _gt($n){$t="";$m=[];$M="meta";$V="views";$e=".tpl";if(!empty(self::$mc)){$C='t_'.sha1(self::$core->base."_".$n);$p=self::$mc->get($C);if(a($p)){if(a($p['m']))$m=$p['m'];if(!empty($p['d']))$t=$p['d'];}}if(!$t){if(!empty(self::$db[0])&&f(P."sql/$V.sql")){$d=self::$sel;self::ds(0);try{foreach([self::$core->app."/".$n,$n] as$v){$p=self::fetch("*",$V,"id=?","","",[$v]);if(!empty($p['data'])){foreach(["css","jslib"] as$c){$t=jd($p[$c]);if(a($t))foreach($t as$v)${self::$core->$c}[m($v)]=$v;}$t=$p['data'];if(!empty($p[$M]))$m=jd($p[$M],1);break;}}}catch(\Exception$e){}self::ds($d);}if(!$t)foreach(["app/$V/$n$e",self::$p?self::$p."/$V/$n$e":"",N.self::$core->app."/$V/$n$e",P."$V/$n$e"] as$F)if($F&&$t=g($F)){while(p("/^[\r\n\ \t]*<$M name='([^']+)' content='([^']+)'>/m",$t,$r)){$t=w($t,u($r[0]));$m[$r[1]]=$r[2];}break;}$t=pr("/<!-.*?->[\r\n]*/ms","",pr("/<\?.*?\?\>[\r\n]*/ms","",$t));if(!empty(self::$mc)&&!empty($t))self::$mc->set($C,["m"=>$m,"d"=>$t],MEMCACHE_COMPRESSED);}self::$core->meta+=$m;return$t;}static function _t($x,$re=0){$L=self::e("W","TOOMNY",L("recursion limit exceeded"));if($re>=64)return$L;$CM=self::$core->app=="cms"&&q(C."CMS","icon");if(preg_match_all("/<!([^\[\-][^>]+)>[\r\n]*/ms",$x,$T,PREG_OFFSET_CAPTURE|PREG_SET_ORDER)){$o=[];$I=0;foreach($T as$k=>$v){$T[$k][0][2]=u($v[0][0]);$t=t(z($v[1][0],0,4));if(z($t,0,2)=="if"||$t=="fore"||$t=="temp")$o[$I++]=$k;elseif($t=="else")$T[$o[$I-1]][4]=$k;elseif(z($t,0,3)=="/if"||$t=="/for"||$t=="/tem")$T[$o[--$I]][3]=$k;}if($I)return self::e("W","UNCLS",L("unclosed tag"));unset($o);$C=0;for($k=0;$k<count($T)&&$m=$T[$k];$k++){$ta=r($m[1][0]);$w="";$a="";if($ta[0]=="=")$t="=";else$t=t(strstr($ta,' ',true));if(empty($t))$t=$ta;else$a=r(w($ta,u($t)));$A=x(" ",$a);$oo=$m[0][1];$os=$m[0][2];switch($t){case "app":$w="<!app>";break;case "include":$c=self::_gt($a);if(!$c)$c=self::_gt(self::getval($a));$w=self::_t($c,$re+1);break;case "=":$w=self::getval($a);break;case "template":$w=self::_t(s(self::_t(z($x,$m[0][1]+$m[0][2]+$C,$T[$m[3]][0][1]-$m[0][1]-$m[0][2]),$re),"<%","<!"),$re+1);$k=$m[3];$os=$T[$m[3]][0][1]-$m[0][1]+$T[$m[3]][0][2];break;case "foreach":$d=self::getval($a);self::$n++;self::$c[self::$n]=(object)['IDX'=>1];$t=z($x,$m[0][1]+$m[0][2]+$C,$T[$m[3]][0][1]-$m[0][1]-$m[0][2]);if((a($d)&&count($d)>0)||is_object($d))foreach($d as$k=>$v){self::$c[self::$n]->KEY=$k;self::$c[self::$n]->VALUE=$v;$w.=self::_t($t,$re+1);self::$c[self::$n]->IDX++;}$k=$m[3];$os=$T[$m[3]][0][1]-$m[0][1]+$T[$m[3]][0][2];unset(self::$c[self::$n]);self::$n--;break;case "if":$os=$T[$m[3]][0][1]+$T[$m[3]][0][2]-$m[0][1];$w=self::_t(($a!="cms"&&!empty(self::getval($a)))||($a=="cms"&&$CM)?z($x,$oo+$C+$m[0][2],!empty($m[4])?$T[$m[4]][0][1]-$m[0][1]-$m[0][2]:$os-$m[0][2]-$T[$m[3]][0][2]):(!empty($m[4])?z($x,$T[$m[4]][0][1]+$C+$T[$m[4]][0][2],$T[$m[3]][0][1]-$T[$m[4]][0][1]-$T[$m[4]][0][2]):""),$re+1);$k=$m[3];break;case "form":self::$tc=0;$c=self::$core->app.".".self::$core->action;$n=!empty($A[0])&&$A[0]!="-"?urlencode($A[0]):"form";$w="<form name='".$n."' action='".url(!empty($A[1])&&$A[1]!="-"?$A[1]:"")."' method='post' enctype='multipart/form-data'".(!empty($A[2])&&$A[2]!="-"?" onsubmit=\"".s($A[2],"\"","\\\"")."\"":"")."><input type='hidden' name='MAX_FILE_SIZE' value='".self::$fm."'><input type='hidden' name='pe_s' value='".@$_SESSION["pe_s"][$c]."'><input type='hidden' name='pe_f' value='".$n."'>".(!empty(self::$core->item)?"<input type='hidden' name='item' value='".h(self::$core->item)."'>":"");break;case "time":case "date":$v=self::getval($A[0]);$w=!empty($v)?date((!empty(self::$l['dateformat'])?self::$l['dateformat']:"Y-m-d").($t=="time"?" H:i:s":""),$v):(!empty($A[1])?"":L("Epoch"));break;case "difftime":$w="";$v=self::getval($A[0]);if($v<0){$w="- ";$v=-$v;}$c=floor($v/86400);$b=floor(($v-$c*86400)/3600);$a=floor(($v-$c*86400-$b*3600)/60);$w.=$c?"$c ".L("day".($c>1?"s":"")):($b?"$b ".L("hour".($b>1?"s":"")):"").($a||!$b?($b?", ":"")."$a ".L("min".($a>1?"s":"")):"");break;case "l":$w=isset(self::$l[$a])?L($a):"NA_".$a;break;case "dump":$l=self::$core->runlevel;if($l<1)$w="";else{ob_start();$s=null;if($A[0]=="_SESSION"){$s=$_SESSION;unset($s["pe_u"]);unset($s["pe_s"]);unset($s["pe_v"]);}else$s=self::getval($A[0]);if($l>1){var_dump($s);$n=o();if($n[0]!="<")$n="<pre>".$n."</pre>";}else{print_r($s);$n="<pre>".h(o())."</pre>";}$w="<b style='font-family:monospace;'>".$A[0].":</b>".s($n,"<pre","<pre style='margin:0;'");}break;case "cms":{if($CM)$w=CMS::icon($A)."<span>";}case "widget":case "var":case "field":$Z=$R=$m=false;if($A[0][0]=='@'){$Z=w($A[0],1);array_shift($A);}if($A[0][0]=='*'){$R=true;$A[0]=w($A[0],1);}$f=$A[0];if(p("/^([^\(]+)[\(]?([^\)]*)/",$A[0],$ma)&&!empty($ma[1])){$f=$ma[1];if($f=="submit")$f="update";$a=self::getval("[".$ma[2]."]");array_shift($A);$n=!empty($A[0])?$A[0]:"";array_shift($A);if($f!="update"&&$f!="cancel"&&$f!="button")$v=self::getval($n);$d=A.$f;if(!ce($d)&&$D=@glob(N."*/addons/".$f.PE)[0])i($D);if(ce($d)&&is_subclass_of($d,C."AddOn")){$F=new$d($a,$n,$v,$A,$R);if(empty(self::$core->addons[$f])&&q($F,"init"))$F->init();if($R||$f=="check"||$f=="file"||q(A.$f,"validate"))$_SESSION["pe_v"][$n][$f]=[$R,$a,$A];$m=$t!="cms"&&($t=="field"||!empty($_SESSION[$t=="var"?"pe_e":"pe_c"]))&&q($F,"edit")?"edit":"show";$w.=q($F,$m)&&(!$Z||self::$user->has($Z))?$F->$m():$v;unset($F);break;}}$w.=($t=="cms"||($t=="var"&&empty($_SESSION['pe_e']))?(is_scalar($v)?$v."":$v&&json_encode($v)):self::e("W","UNKADDON",$f)).($t=="cms"?"</span>":"");break;default:$w=self::e("W","UNKTAG",$t);}$D=$oo+$C&&$x[$oo+$C-1]=="\n"?1:0;$E=isset($x[$oo+$os+$C])&&$x[$oo+$os+$C]=="\n"?1:0;$x=z($x,0,$oo+$C-$D).$w.w($x,$oo+$os+$C+$E);$C+=@u($w)-$os-$D-$E;}}return$x;}function __toString(){return __CLASS__;}}}namespace PHPPE\AddOn{use\PHPPE\Core as Core;use\PHPPE\AddOn as AddOn;class hidden extends AddOn{function show(){return "";}function edit(){return "<input type='hidden' name='".s($this->name,".","_")."' value='".h(r($this->value))."'>";}}class button extends AddOn{function show(){return$this->edit();}function edit(){return "<input class='".(!empty($this->attrs[1])&&$this->attrs[1]!="-"?$this->attrs[1]:"button")."' type='button' value=\"".h(L(!empty($this->name)?$this->name:"Press me"))."\" onclick=\"".s(!empty($this->attrs[0])&&$this->attrs[0]!="-"?$this->attrs[0]:"alert('".L("No action")."');","\"","\\\"")."\">";}}class update extends AddOn{function show(){return "";}function edit(){return "<input class='".(!empty($this->attrs[1])&&$this->attrs[1]!="-"?$this->attrs[1]:"button")."' name='pe_try".Core::_tc()."' type='submit' value=\"".h(L(!empty($this->name)?$this->name:"Okay"))."\"".(!empty($this->attrs[0])&&$this->attrs[0]!="-"?" onclick=\"return ".s($this->attrs[0],"\"","\\\"")."\"":"").">";}}class cancel extends AddOn{function show(){return "";}function edit(){return "<input class='".(!empty($this->attrs[0])&&$this->attrs[0]!="-"?$this->attrs[0]:"button")."' name='pe_cancel' type='submit' value=\"".h(L(!empty($this->name)?$this->name:"Cancel"))."\">";}}class text extends AddOn{function show(){return h($this->value);}function edit(){$v=r($this->value);if($v=="null")$v="";if(!empty($this->args[2])&&$this->args[2]>0){if($this->args[1]>0)Core::js("pe_mt(e,m)","var c,o;if(!e)e=window.event;o=e.target;c=e.keyCode?e.keyCode:e.which;return(c==8||c==46||o.value.length<=m);");return "<textarea".@v($this->css,$this->attrs[1],$this->err,$this->name,$this->attrs[0]).($this->args[0]>0?" cols='".$this->args[0]."'":"")." rows='".$this->args[2]."'".($this->args[1]>0?" onkeypress='return pe_mt(event,".$this->args[1].");'":"")." wrap='soft' onfocus='this.style.background=\"\";'>".$v."</textarea>";}return "<input".@v($this->css,$this->attrs[1],$this->err,$this->name,$this->attrs[0],$this->args)." type='text'".(!empty($this->attrs[2])&&$this->attrs[2]!="-"?" onkepup='".$this->attrs[2]."'":"")." onfocus='this.style.background=\"\";'".(!empty($this->attrs[3])?" placeholder=\"".h(r($this->attrs[3]))."\"":"")."' value=\"".h($v)."\">";}}class pass extends AddOn{function show(){return "******";}function edit(){return "<input".@v($this->css,$this->attrs[0],$this->err,$this->name,"",$this->arrs)." type='password' value=\"".h(r($this->value))."\" onfocus='this.style.background=\"\";'>";}static function validate($n,&$v,$a,$t){if(y(C."pass"))return\PHPPE\pass($n,$v,$a,$t);$r=p("/[0-9]/",$v)&&p("/[a-z]/i",$v)&&t($v)!=$v&&k($v)!=$v&&u($v)>=6;return[$r,"not a valid password! [a-zA-Z0-9] * 6"];}}class num extends AddOn{function show(){return h($this->value);}function edit(){Core::js("pe_on(e)","var c,o;if(!e)e=window.event;o=e.target;c=e.keyCode?e.keyCode:e.which;o.style.background='';if(c==8||c==37||c==39||c==46)return true;c=String.fromCharCode(c);if(c.match(/[0-9\\b\\t\\r\\-\\.\\,]/)!=null)return true;else{o.style.background='".Core::$ec."';setTimeout(function(){o.style.background='';},200);return false;}");return "<input".@v($this->css,$this->attrs[1],"",$this->name,$this->attrs[0],$this->args)." style='text-align:right;".(!empty($this->err)?"background:".Core::$ec.";":"")."' type='text' onkeypress='return pe_on(event);' onkeyup='this.value=this.value.replace(\",\",\".\");' onfocus='this.style.background=\"\";this.select();'".(isset($this->args[3])?" onblur='if(this.value<".$this->args[2].")this.value=".$this->args[2].";if(this.value>".$this->args[3].")this.value=".$this->args[3].";'":"")." value=\"".h(r($this->value))."\">";}static function validate($n,&$v,$a,$t){$r=p("/^[0-9\-][0-9\.]+$/",$v);if(!$r)$m="not a valid number!";if($r&&isset($a[3])){if($v<$a[2]){$r=0;$m="not enough!";$v=$a[2];}if($v>$a[3]){$r=0;$m="too much!";$v=$a[3];}}return[$r,$m];}}class select extends AddOn{function show(){return h(a($this->value)?implode(", ",$this->value):$this->value);}function edit(){$opts=!empty($this->attrs[0])&&$this->attrs[0]!="-"?Core::getval($this->attrs[0]):[];if(is_string($opts))$opts=x(",",$opts);$skip=!empty($this->attrs[1])&&$this->attrs[1]!="-"?Core::getval($this->attrs[1]):[];if(is_string($skip))$skip=x(",",$skip);if(!a($skip))$skip=[];else$skip=array_flip($skip);$r="<select".@v($this->css,$this->attrs[3],$this->err,$this->name.(!empty($this->args[1])?"[]":""),$this->attrs[2]).(!empty($this->args[1])?" multiple":"").(!empty($this->args[0])&&$this->args[0]>0?" size='".intval($this->args[0])."'":"")." onfocus='this.style.background=\"\";'>";if(a($opts))foreach($opts as$k=>$v){$o=a($v)&&isset($v['id'])?$v['id']:(is_object($v)&&isset($v->id)?$v->id:$k);$n=a($v)&&!empty($v['name'])?$v['name']:(is_object($v)&&!empty($v->name)?$v->name:(is_string($v)?$v:$k));if(!isset($skip[$o])&&!empty($n))$r.="<option value=\"".h($o)."\"".((a($this->value)&&in_array($o."",$this->value))||$o==$this->value?" selected":"").">".$n."</option>";}$r.="</select>";return$r;}}class check extends AddOn{function show(){if(empty(Core::$core->output)||Core::$core->output!="html")return "[".(!empty($this->value)?"X":" ")."]".(!empty($this->attrs[0])?L($this->attrs[0]):$this->value);return h($this->value);}function edit(){return(!empty($this->err)?"<span ".$this->err.">":"")."<input".@v($this->css,$this->attrs[2],"",$this->name,$this->attrs[1])." id='".$this->name."' type='checkbox'".(!empty($this->value)?" checked":"")." value=\"".h(r(!empty($this->args[0])?$this->args[0]:"1"))."\">".(!empty($this->attrs[0])?"<label for='".$this->name."'>".L($this->attrs[0])."</label>":"").(!empty($this->err)?"</span>":"");}}class radio extends AddOn{function show(){if(empty(Core::$core->output)||Core::$core->output!="html")return "(".($this->value==$this->args[0]?"X":" ").") ".(!empty($this->attrs[0])?L($this->attrs[0]):$this->value);return h($this->value);}function edit(){return "<input".@v($this->css,$this->attrs[2],$this->err,$this->name,$this->attrs[1])." id='".$this->name."_".sha1($this->args[0])."' type='radio'".($this->value==$this->args[0]?" checked":"")." value=\"".h(r(!empty($this->args[0])?$this->args[0]:"1"))."\">".(!empty($this->attrs[0])?"<label for='".$this->name."_".sha1($this->args[0])."'>".L($this->attrs[0])."</label>":"");}}class phone extends AddOn{function show(){return h($this->value);}function edit(){Core::js("pe_op(e)","var c,o;if(!e)e=window.event;o=e.target;c=e.keyCode?e.keyCode:e.which;o.style.background='';if(c==8||c==37||c==39||c==46)return true;c=String.fromCharCode(c);if(c.match(/[0-9\\b\\t\\r\\-\\ \\+\\(\\)\\/]/)!=null)return true;else{o.style.background='".Core::$ec."';setTimeout(function(){o.style.background='';},200);return false;}");return "<input".@v($this->css,$this->attrs[1],$this->err,$this->name,$this->attrs[0],$this->args)." type='text' onfocus='this.style.background=\"\";' onkeypress='return pe_op(event);' value=\"".h(r($this->value))."\">";}static function validate($n,&$v,$a,$t){$r=p("/^[0-9\+][0-9\ \(\)\-]+$/",$v);return[$r,"invalid phone number"];}}class email extends AddOn{function show(){if(empty(Core::$core->output)||Core::$core->output!="html")return$this->value;return s(h($this->value),["@"=>"&#64;","."=>"&#46;"]);}function edit(){Core::js("pe_oe(o)","o.style.background='';if(o.value!=''&&o.value.match(/^.+\@(\[?)[a-zA-Z0-9\-\.]+\.([a-zA-Z]{2,3}|[0-9]{1,3})(\]?)$/)==null)o.style.background='".Core::$ec."';");return "<input".@v($this->css,$this->attrs[1],$this->err,$this->name,"",$this->args)." type='text' onfocus='this.style.background=\"\";' onchange='pe_oe(this);".(!empty($this->attrs[0])&&$this->attrs[0]!="-"?$this->attrs[0]:"")."' value=\"".h(r($this->value))."\">";}static function validate($n,&$v,$a,$t){$r=p("/^.+\@(\[?)[a-zA-Z0-9\-\.]+\.([a-zA-Z]{2,3}|[0-9]{1,3})(\]?)$/",$v);return[$r,"invalid email address"];}}class file extends AddOn{function show(){return "";}function edit(){return(!empty($this->err)?"<span ".$this->err.">":"")."<input".@v($this->css,$this->attrs[0],"",$this->name,"",$this->args)." type='file'>&nbsp;(".round(Core::$fm/1048576)."Mb)".(!empty($this->err)?"</span>":"");}}class date extends AddOn{function show(){return$this->show2(0);}function show2($time=0){return!empty($this->value)?date((!empty(Core::$l['dateformat'])?Core::$l['dateformat']:"Y-m-d").($time?" H:i":""),$this->value):(!empty($this->attrs[0])?"":"Epoch");}function edit(){return$this->edit2(0);}function edit2($time=0){Core::js("pe_cd(o,f)","var d=new Date(Date.UTC(o[f+':y'].value,o[f+':m'].value-1,o[f+':d'].value,o[f+':h']?o[f+':h'].value:0,o[f+':i']?o[f+':i'].value:0,0));o[f+':y'].style.background='';o[f+':m'].style.background='';o[f+':d'].style.background='';if(o[f+':h'])o[f+':h'].style.background='';if(o[f+':i'])o[f+':i'].style.background='';if(!d||d.getUTCDate()!=o[f+':d'].value){o[f+':y'].style.background='".Core::$ec."';o[f+':m'].style.background='".Core::$ec."';o[f+':d'].style.background='".Core::$ec."';}");$n=s($this->name,".","_");$sel="<select".@v($this->css,$this->attrs[1],$this->err,"","")." onfocus='pe_cd(this.form,\"".$n."\");' onchange='pe_cd(this.form,\"".$n."\");".(!empty($this->attrs[0])&&$this->attrs[0]!="-"?$this->attrs[0]:"")."' name='".$n;$d=x(",",date("Y,m,d,H,i,s",!empty($this->value)?$this->value:Core::$core->now));$oy=$sel.":y'>";for($i=date("Y",Core::$core->now)-(!empty($this->args[0])?$this->args[0]:5);$i<=date("Y",Core::$core->now)+(!empty($this->args[0])?$this->args[0]:5);$i++)$oy.="<option value='".$i."'".($i==$d[0]?" selected":"").">".$i."</option>";$oy.="</select>";$om=$sel.":m'>";for($i=1;$i<=12;$i++){$t="month".($i<10?"0":"").$i;$om.="<option value='".$i."'".($i==intval($d[1])?" selected":"").">".(!empty(Core::$l[$t])?Core::$l[$t]:($i<10?"0":"").$i)."</option>";}$om.="</select>";$od=$sel.":d'>";for($i=1;$i<=31;$i++)$od.="<option value='".$i."'".($i==intval($d[2])?" selected":"").">".($i<10?"0":"").$i."</option>";$od.="</select>";$f=(!empty(Core::$l["dateformat"])?Core::$l["dateformat"]:"Y-m-d")."@";if($time){$f.=" H:i".(!empty($this->args[3])?":s":"");$oh=$sel.":h'>";for($i=0;$i<=23;$i++)$oh.="<option value='".$i."'".($i==intval($d[3])?" selected":"").">".(($i<10?"0":"").$i)."</option>";$oh.="</select>";$oi=$sel.":i'>";for($i=0;$i<=59;$i+=(!empty($this->args[2])&&$this->args[2]>0&&$this->args[2]<=30?$this->args[2]:1))$oi.="<option value='".$i."'".($i==intval($d[4])?" selected":"").">".(($i<10?"0":"").$i)."</option>";$oi.="</select>";if(!empty($this->args[3])){$os=$sel.":s'>";for($i=0;$i<=59;$i++)$os.="<option value='".$i."'".($i==intval($d[5])?" selected":"").">".(($i<10?"0":"").$i)."</option>";$os.="</select>";}else$os="";}else$oh=$oi=$os="";if(f(P."js/core.js".PE)){list($o,$d)=x(".",$this->name);$c="&nbsp;<img src='images/calendar.png' class='calendar_icon' style='cursor:pointer;vertical-align:middle;' onclick='if(document.forms[\"".$o."\"])calendar_open(this,document.forms[\"".$o."\"],\"".$o."_".$d."\");' alt='[...]'>";}else$c="";return s($f,["Y"=>$oy,"m"=>$om,"d"=>$od,"H"=>$oh,"i"=>$oi,"s"=>$os,"@"=>$c]);}static function validate($n,&$v,$a,$t){return[mktime(!empty($_REQUEST[$v.":h"])?$_REQUEST[$v.":h"]:0,!empty($_REQUEST[$v.":i"])?$_REQUEST[$v.":i"]:0,!empty($_REQUEST[$v.":s"])?$_REQUEST[$v.":s"]:0,!empty($_REQUEST[$v.":m"])?$_REQUEST[$v.":m"]:0,!empty($_REQUEST[$v.":d"])?$_REQUEST[$v.":d"]:0,!empty($_REQUEST[$v.":y"])?$_REQUEST[$v.":y"]:0),"bad date"];}}class time extends date{function show(){return parent::show2(1);}function edit(){return parent::edit2(1);}static function validate($n,&$v,$a,$t){return parent::validate($n,$v,$a,$t);}}}namespace{function LANG_INIT($c=""){return\PHPPE\Core::langInit($c);}function L($s){return isset(\PHPPE\Core::$l[$s])?\PHPPE\Core::$l[$s]:strtr($s,["_"=>" "]);}function url($m=NULL,$p=NULL){return\PHPPE\Core::url($m,$p);}function filter_get(){return$_SERVER['REQUEST_METHOD']=="GET";}function filter_post(){return$_SERVER['REQUEST_METHOD']=="POST";}function filter_loggedin(){if(\PHPPE\Core::$user->id)return true;\PHPPE\Core::redirect("/login",true);}function filter_csrf(){return\PHPPE\Core::istry();}function a($a){return is_array($a);}function h(&$s){return htmlspecialchars($s);}function s($s,$f,$t=""){return a($f)?strtr($s,$f):strtr($s,[$f=>$t]);}function e($e=0){return error_reporting($e);}function f($f){return file_exists($f);}function g($f){return f($f)?file_get_contents($f):"";}function i($f){return include_once($f);}function t($s){return strtolower($s);}function k($s){return strtoupper($s);}function c($m){header("Pragma:cache");header("Cache-Control:cache,public,max-age=86400");header("Content-Type:".$m.";charset=utf-8");header("Connection:close");}function d($n){return debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS)[$n]['file'];}function r($s){return trim($s);}function n($s){return dirname($s);}function m($a){return basename($a);}function p($p,&$s,&$r=null,$f=0){return preg_match($p,$s,$r,$f);}function pr($a,$b,$c){return preg_replace($a,$b,$c);}function x($a,$b){return explode($a,$b);}function q($a,$b){return method_exists($a,$b);}function y($a){return function_exists($a);}function w(&$a,$b){return substr($a,$b);}function z(&$a,$b,$c){return substr($a,$b,$c);}function v($a,$b,$c,$d,$e="",$f=[]){return " class='".$a.(!empty($b)&&$b!="-"?" ".$b:"")."'".($c?" ".$c:"").($d?" name='".s($d,".","_")."'":"").($e&&$e!="-"?" onchange='".$e."'":"").(!empty($f[0])&&$f[0]>0?" size='".$f[0]."'":"").(!empty($f[1])&&$f[1]>0?" maxlength='".$f[1]."'":"");}function u($a){return strlen($a);}function j($a,$b,$c=""){return sha1($a."|".$b."|".$c);}function o(){return ob_get_clean();}function jd(&$a){return @json_decode($a,1);}function ce($c){return class_exists($c);}function cc($c){return(ce($c)&&is_subclass_of($c,C."App"))||(ce($c."_Ctrl")&&is_subclass_of($c."_Ctrl",C."App"));}if(empty(\PHPPE\Core::$core))new\PHPPE\Core(!empty(debug_backtrace()));return\PHPPE\Core::$core;}                                 
?>
