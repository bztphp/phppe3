<?php
/*
 *  PHP Portal Engine v3.0.0
 *  https://github.com/bztsrc/phppe3/
 *
 *  Copyright LGPL 2016 bzt
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU Lesser General Public License as published
 *  by the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Lesser General Public License for more details.
 *
 *   <http://www.gnu.org/licenses/>
 *
 *  PHPPE Core - Use as is
 */
namespace PHPPE{define("VERSION","3.0.0");class AddOn{public$args;public$name;public$fld;public$value;public$attrs;public$css;final function __construct($a,$n,&$v,$t=[],$r=0){$this->args=$a;$this->name=$n;$this->fld=s($n,".","_");$this->value=$v;$this->attrs=$t;$this->css=((!empty($r)?"req":"")."input").(Core::isError($n)?" errinput":"");}function show(){return "";}}class Filter{}class App{}class Ctrl extends App{}class Model{public$id;public$name;protected static$_table;final function find($s=[],$w="",$o=""){if(empty(static::$_table))throw new\Exception("no _table");return Core::query("*",static::$_table,$w?$w:($s?"id=?":""),"",$o,0,0,a($s)?$s:[$s]);}final function load($i=0,$w="",$o=""){if(empty(static::$_table))throw new\Exception("no _table");$r=Core::fetch("*",static::$_table,$w?$w:"id=?","",$o,a($i)?$i:[$i?$i:$this->id]);if($r){foreach($this as$k=>$v)if($k[0]!='_')$this->$k=is_string($r[$k])&&($r[$k][0]=='{'||$r[$k][0]=='[')?jd($r[$k]):$r[$k];return true;}return false;}final function save($f=0){if(empty(static::$_table))throw new\Exception("no _table");$d=Core::db();if(empty($d))throw new\Exception("no ds");$a=[];foreach($this as$k=>$v)if($k[0]!='_'&&($f||$k!='id')&&$k!='created')$a[$k]=is_scalar($v)?$v:json_encode($v);if(!Core::exec(($this->id&&!$f?"UPDATE ".static::$_table." SET ".implode("=?,",array_keys($a))."=? WHERE id=".$d->quote($this->id):"INSERT INTO ".static::$_table." (".implode(",",array_keys($a)).") VALUES (?".str_repeat(",?",count($a)-1).")"),array_values($a)))return false;if(!$this->id)$this->id=$d->lastInsertId();return$this->id;}}class Client{public$ip;public$agent;public$user;public$tz;public$lang;public$screen=[];public$geo=[];}class User extends Model{public$id=0;public$name="Anonymous";public$data=[];private$acl=[];final function has($l){foreach(a($l)?$l:x("|",$l) as$a){$a=r($a);if(!empty($this->id)&&($this->id==-1||$a=="loggedin"||!empty($this->acl[$a])||!empty($this->acl["$a:".self::$core->item])))return 1;}return 0;}final function grant($l){foreach(a($l)?$l:x("|",$l) as$a){$a=r($a);if(!empty($this->id)&&!empty($a))$this->acl[$a]=1;}}final function clear($l=""){if(empty($l))$this->acl=[];else{foreach(a($l)?$l:x("|",$l) as$a){$a=r($a);unset($this->acl[$a]);foreach($this->acl as$k=>$v)if(z($k,0,u($a)+1)==$a.":")unset($this->acl[$k]);}}}}define('M',"vendor/");define('N',M."phppe/");define('P',N."core/");define('PE',".php");define('C',"\\PHPPE\\");define('A',C."AddOn\\");define('I',"index");define('T',"CURRENT_TIMESTAMP");class Core{private$id;public$base;public$site;public$runlevel=2;public$app;public$action;public$item;public$form;public$now;public$syslog=false;public$timeout;public$output;public$template;public$mailer;public$cache;public$cachettl=600;public static$core;public static$user;public static$client;public static$l=[];public static$fm;private$meta=[];private$try;private$started;private$error;private$libs;private$addons;private$disabled;private$js;private$jslib;private$css;private$menu;private static$r;private static$n;private static$c;private static$o;private static$p;private static$mc;private static$tc;private static$db;private static$s;private static$b;private static$w;private static$v;static$g;function __construct($islib=true){$this->started=microtime(1);set_exception_handler(function(\Exception$e){self::log('C',"Exception: ".$e->getMessage().(empty(self::$core->trace)?"":"\n\t".s($e->getTraceAsString(),"\n","\n\t")));});ini_set("error_log",n(__DIR__)."/".P."log/php.log");ini_set("log_errors",1);if(version_compare(PHP_VERSION,"5.5")<0)self::log("C","PHP 5.5.0 required, found ".PHP_VERSION);ini_set("file_uploads",1);ini_set("upload_tmp_dir",n(__DIR__)."/.tmp");ini_set("uploadprogress.file.filename_template",n(__DIR__)."/.tmp/upd_%s.txt");if(y("mb_internal_encoding"))mb_internal_encoding("utf-8");if(get_magic_quotes_gpc()){foreach($_REQUEST as$k=>$v)if(is_string($v))$_REQUEST[$k]=stripslashes($v);elseif(a($v))foreach($v as$K=>$V)if(is_string($V))$_REQUEST[$k][$K]=stripslashes($V);}$c=__FILE__;if(filesize($c)!=65535||'db6ba6bf93ee899efd3c1e33bfb15ba198716643'!=sha1(pr("/\'([^\']+)\'\!\=sha1/","''!=sha1",g($c))))self::log("C","Corrupted ".m($c));chdir(n(__DIR__));$S=$_SERVER;$core=self::$core=&$this;$c=P."config".PE;$this->disabled=[];if(f($c))@require_once($c);$this->id="PHPPE".VERSION;if($this->runlevel<0||$this->runlevel>3)$this->runlevel=0;if($this->timeout<60)$this->timeout=7*24*3600;if($this->cachettl<10)$this->cachettl=10;if(!empty($this->allowed)&&!a($this->allowed))$this->allowed=x(",",$this->allowed);if(!a($this->disabled))$this->disabled=x(",",$this->disabled);ini_set("display_errors",$this->runlevel>1?1:0);$this->now=time();$this->error=$this->js=$this->jslib=$this->css=$this->libs=[];$this->sec=(t(getenv("HTTPS"))=="on")?1:0;self::$w=isset($S['REQUEST_METHOD'])?1:0;$this->output=self::$w?"html":"tty";$this->try=self::$tc=0;$c=$S['SCRIPT_NAME'];$C=n($c);if($C!="/")$C.="/";$d="SERVER_NAME";$this->base=(!empty($this->base)?$this->base:(!empty($S[$d])?$S[$d]:"localhost").($C[0]!="/"?"/":"").$C);list($d)=x("?",@$S['REQUEST_URI']);foreach([$c,n($c)] as$C)if($C!="/"&&z($d,0,u($C))==$C){$d=w($d,u($C));break;}$D="--dump";$A="argv";$a="action";$d=x("/",!empty($d)?$d:"//");$R=$_REQUEST;foreach([1=>"app",2=>$a,3=>"item"] as$c=>$v)$this->$v=!empty($d[$c])?t($d[$c]):(!empty($R[$v])?r(t($R[$v])):(!self::$w&&!empty($S[$A][$c])&&$S[$A][$c]!=$D?r(t($S[$A][$c])):($c<3?($c==1?I:$a):"")));$c=$this->app."_".$this->$a;if(strpos($c,"..")!==false||strpos($c,"/")!==false||w($this->app,-4)==PE||w($this->$a,-4)==PE)$this->redirect("403");$this->template=$c;$c=self::si("post_max_size");$d=self::si("upload_max_filesize");$v=self::si("memory_limit");if($c>$d&&$d)$c=$d;self::$fm=($c>$v&&$v?$v:$c);if(!self::$w&&!$islib){if(ia("--version",$S[$A]))die(VERSION."\n");if(empty($S[$A][1])||ia("--help",$S[$A])){$c="php ".$S[$A][0];die("PHP Portal Engine ".VERSION.", LGPL 2016 bzt\n\n $c --help\n $c --version\n $c --diag [--gid=x]\n $c [application [$a [item]]] ) [ $D ]\n\n");}}$v="libs/pass".PE;$c="app/$v";if(f($c))io($c);else{$c=P.$v;io($c);}$c=P."libs/minify".PE;if(empty($this->nominify))io($c);if(!y(C."minify")){function minify($t,$T){return$t;}}$c=M."autoload".PE;if(f($c))@io($c);self::$r=[];$d=@glob(N."*/*_*".PE,GLOB_NOSORT);usort($d,function($a,$b){return strcmp(m($a),m($b));});foreach($d as$f){if(p("/([^\/]+)\/([0-9]{2}_([^\.]+)\.php)$/",$f,$m)&&$m[1]==$m[3]&&!ia($m[3],$this->disabled)){$c=C.$m[1];io($f);if(ce($c)&&t($c)!=t("\\".__CLASS__)){$C=new$c();if($m[1]!="DS"&&empty($this->libs[$m[1]]))$this->libs[$m[1]]=$C;}}}if(!self::$w&&((!f(P."config".PE)&&!$islib)||(!empty($S[$A][1])&&$S[$A][1]=="--diag")))$this->bootdiag();else{$this->bootstrap();if(!$islib)$this->run();}}private function bootdiag(){if(!extension_loaded("posix")&&y("dl"))@dl((PHP_SHLIB_SUFFIX=="dll"?"php_":"")."posix.".PHP_SHLIB_SUFFIX);if(!empty($_SERVER['argv'][2])&&z($_SERVER['argv'][2],0,6)=="--gid=")$g["g"]=intval(w($_SERVER['argv'][2],6));elseif(y("posix_getpwnam"))foreach(["www","_www","www-data","http","httpd","apache","nginx"] as$n){$g=posix_getpwnam($n);if(!empty($g["gid"])){$g["g"]=$g["gid"];break;}}if(empty($g["g"]))self::$g=33;else self::$g=$g["g"];$U=fileowner(__FILE__);if($this->runlevel)echo("DIAG-I: uid $U gid ".self::$g."\n");function i($c,$r,$f=0,$a=0640){if(!f($c)||$f){if(!f($c))echo("DIAG-A: $c\n");file_put_contents($c,$r);}if(f($c)&&(!@chgrp($c,\PHPPE\Core::$g)||!@chown($c,fileowner(__FILE__))))echo("DIAG-E: chown/chgrp $c\n");return!@chmod($c,$a);}$E="";$C=0750;$W=0775;if(y("posix_getuid")&&posix_getuid()!=0)echo("DIAG-W: not root or no php-posix, chown/chgrp may fail!\n");$o=umask(0);@symlink(N."core","phppe");$D=[".tmp"=>$W,"data"=>$W,"app"=>0,M=>0755,M."bin"=>0,N=>0,N."core"=>0,P."log"=>$W,P."views"=>0,P."ctrl"=>0,P."lang"=>0,P."libs"=>0,P."out"=>0,P."sql"=>0,"public/images"=>0,"public/css"=>0,"public/js"=>0,"app/ctrl"=>0,"app/lang"=>0,"app/libs"=>0,"app/views"=>0];$A=["*","*/*","*/*/*","*/*/*/*","*/*/*/*/*"];foreach(["data/",M] as$d)foreach($A as$v)$D+=array_fill_keys(@glob($d.$v),0);foreach($D as$d=>$p){if(!$p)$p=$C;$x=ia(substr($d,0,4),[".tmp","data"])||substr($d,0,21)==P."log";if(is_file($d)){$P=fileperms($d)&0777;$p=$x?0660:0640;}else{if($x)$p=$W;if(!is_dir($d)&&!is_file($d)){echo("DIAG-A: $d\n");if(!mkdir($d,$p))self::log("C","creating $d","diag");}$P=fileperms($d)&0777;}if($P!=$p){$E.=sprintf("\t%03o?\t%03o ",$P,$p)."$d\n";@chmod($d,$p);}if(!@chgrp($d,self::$g)||!@chown($d,$U))echo("DIAG-E: chown/chgrp $d\n");}@symlink("../../app",N."app");foreach(["images","css","js"] as$v){if(!f("app/$v"))echo("DIAG-A: app/$v\n");@symlink("../public/$v","app/$v");}umask(0027);i("app/config".PE,"");i("public/favicon.ico","");i(P."config".PE,"");$U="http://phppe.org/";$D=P."views/";$e=".tpl";$c="<!dump core.req2arr('obj')>";i($D."403$e","<h1>403</h1><!=L('Access denied')>");i($D."404$e","<h1>404</h1><!=L('Not found')>: <b><!=core.app></b>");i($D."frame$e","<div id='content'><!app></div>");i($D.I.$e,"<h1>PHPPE works!</h1>Next step: install <a href='".$U."phppe3.html#install:1956' target='_new'>PHPPE Pack</a>.<br/><br/><!if core.istry()><div style='display:none;'>$c</div><!/if><div style='background:#F0F0F0;padding:3px;'><b>Test form</b></div><!form obj>Text<!field text(6) obj.f0> Pass<!field pass(6) obj.f1> Num(100..999)<!field *num(6,6,100,999) obj.f2><!field check obj.f3 Check>  File<!field file obj.f4> <!field cancel>  <!field submit></form><table width='100%'><tr><td valign='top' width='50%'><!dump _REQUEST><!dump _FILES></td><td valign='top'>$c</td></tr></table>\n");i($D."login$e","<!form login><!field text id><!field pass pass><!field submit></form>");i("composer.json","{\n\t\"name\":\"phppe3\",\n\t\"version\":\"1.0.0\",\n\t\"keywords\":[\"phppe3\",\"\"],\n\t\"license\":[\"LGPL-3.0+\"],\n\n\t\"type\":\"project\",\n\t\"repositories\":[\n\t\t{\"type\":\"composer\",\"url\":\"$U\"}\n\t],\n\t\"require\":{\"phppe\":\"3.*\"},\n\n\t\"scripts\":{\"post-update-cmd\":\"sudo php public/index.php --diag\"}\n}\n");i(".gitignore",".tmp\nphppe\nvendor\n");if($E)self::log("E","Wrong permissions:\n$E","diag");$D=[];$c="/sql/upd_*.";$d=self::lib("ds");foreach($A as$v)foreach($d?["",$d->primary]:[""] as$s)$D+=array_fill_keys(@glob(M.$v.$c.$s.".sql"),0);if(count($D))echo("DIAG-I: db update\n");foreach($D as$f=>$v){$s=x(";",g($f));@unlink($f);foreach($s as$q)self::exec($q);}if(!y("posix_getuid")||posix_getuid()!=0)$this->_eh("diag");umask($o);die("DIAG-I: OK\n");}private function bootstrap(){$S=$_SERVER;$R=$_REQUEST;session_name(!empty($this->sessionvar)?$this->sessionvar:"pe_sid");session_start();if(ini_get("session.use_cookies"))setcookie(session_name(),session_id(),time()+$this->timeout,"/",$S["SERVER_NAME"],!empty($this->secsession)?1:0,1);self::$client=new Client;if(self::$w){$L='HTTP_IF_MODIFIED_SINCE';if(!$this->runlevel&&isset($S[$L])&&$S[$L]+$this->cachettl<$this->now){header('HTTP/1.1 304 Not Modified');die;}if(isset($R["pe_cancel"]))$this->redirect();if(isset($R['clear'])){$L='pe_u';$u=$_SESSION[$L];$_SESSION=[];$_SESSION[$L]=$u;$this->redirect();}$L="pe_tz";if($this->app==I&&empty($_SESSION[$L])&&!isset($R['nojs'])&&empty($R['cache'])){$c=L("Enable JavaScript");if(empty($R['n'])){$_SESSION['pe_n']=sha1(rand());$this->_r();$g="getTimezoneOffset()";$d="var d%=new Date();d%.setDate(1);d%.setMonth(@);d%=parseInt(d%.$g);";die("<html><script type='text/javascript'>var now=new Date();".s($d,['%'=>'1','@'=>'1']).s($d,['%'=>'2','@'=>'7'])."txt=now.toString().replace(/[^\(]+\(([^\)]+)\)/,\"$1\");document.location.href=\"".$_SESSION["pe_r"].(strpos($S['REQUEST_URI'],"?")===false?"?":"&")."n=".$_SESSION['pe_n']."&t=\"+(-now.$g*60)+\"&d=\"+(d1==d2||(d1<d2&&d1==parseInt(now.$g))||(d1>d2&&d2==parseInt(now.$g))?\"1\":\"0\")+\"&w=\"+screen.availWidth+\"&h=\"+screen.availHeight;</script>$c</html>");}elseif($R['n']==$_SESSION['pe_n']){unset($_SESSION['pe_n']);$_SESSION[$L]=timezone_name_from_abbr("",$R['t']+0,$R['d']+0);$_SESSION['pe_w']=floor($R['w']);$_SESSION['pe_h']=floor($R['h']);$this->redirect();}else die($c);}$d='HTTP_X_FORWARDED_FOR';self::$client->ip=$i=!empty($S[$d])?$S[$d]:$S['REMOTE_ADDR'];self::$client->screen=!empty($_SESSION['pe_w'])?[$_SESSION['pe_w'],$_SESSION['pe_h']]:[0,0];$d='HTTP_USER_AGENT';self::$client->agent=!empty($S[$d])?$S[$d]:"browser";$d='PHP_AUTH_USER';self::$client->user=!empty($S[$d])?$S[$d]:"";}else{$T=getenv("TZ");$d=x("/",$T?$T:@readlink("/etc/localtime"));$c=count($d);$_SESSION[$L]=$c>1?$d[$c-2]."/".$d[$c-1]:"UTC";self::$client->ip="CLI";$c=exec("tput cols")+0;$d=exec("tput lines")+0;self::$client->screen=[$c<1?80:$c,$d<1?25:$d];$d=getenv("TERM");self::$client->agent=!empty($d)?$d:"term";$d=getenv("USER");self::$client->user=!empty($d)?$d:"";$this->noframe=1;}date_default_timezone_set(self::$client->tz=!empty($_SESSION[$L])?$_SESSION[$L]:"UTC");$c=C."User";$u=$c."s";if(!ce($u)||!is_subclass_of($u,$c))$u=$c;$L="pe_u";if(!empty($_SESSION[$L])&&is_object($_SESSION[$L]))self::$user=$_SESSION[$L];else self::$user=$_SESSION[$L]=new$u();if(!empty(self::$user->id)){foreach(["edit","conf"] as$v){if(isset($R[$v])&&self::$user->has($v)){$_SESSION['pe_'.z($v,0,1)]=!empty($R[$v]);$this->redirect();}}}$L='pe_l';$a="";$d=[];if(empty($_SESSION[$L])){$i='HTTP_ACCEPT_LANGUAGE';$d=x(",",s(!empty($S[$i])?$S[$i]:(getenv('LANG')||"en"),"/",""));}if(!empty($R['lang']))$d=[s(r($R['lang']),"/","")];foreach($d as$v){list($a)=x(";",t($v));if(!empty($a)&&(f(P."lang/$a".PE)||f("app/lang/$a".PE))){$_SESSION[$L]=$a;break;}}if(empty($_SESSION[$L]))$_SESSION[$L]="en";self::$client->lang=$v=$_SESSION[$L];$i=x("_",s($v,"-","_"));setlocale(LC_ALL,t($i[0])."_".k(!empty($i[1])?$i[1]:$i[0]).".UTF8");$C="core";if(self::isInst($C)){$this->jslib["$C.$v.js"]=P."js/$C.js".PE;$this->css["$C.css"]=P."css/$C.css";}if(!empty($this->db)){@self::db($this->db);try{$t=@strtotime(@self::field(T));if($t>0)$this->now=$t;}catch(\Exception$e){}}self::$l=[];LANG_INIT($C,$i);foreach($this->libs as$k=>$v){LANG_INIT($k,$i);$c=N.$k."/config".PE;if(q($v,"init")&&!$v->init(t($k)!="core"&&f($c)?io($c):[]))unset($this->libs[$k]);}LANG_INIT("app",$i);if(!empty($this->cache)){$C="cache";$c=P."libs/$C".PE;if(f($c))self::$mc=require_once($c);if(!is_object(self::$mc)){$M="\\Mem$C";if(!ce($M))self::log('C',"no php-memcached",$C);$m=x(":",$this->$C);if($m[0]=="unix"){$p=0;$h=$m[1];}else{$p=$m[1]+0;$h=$m[0];}self::$mc=new$M;if(!@self::$mc->pconnect($h,$p,1)){usleep(100);if(!@self::$mc->pconnect($h,$p,1))self::$mc=null;}}self::lib("mc",L(ucfirst($C)),"",self::$mc);}}function run($n="",$ac=""){list($c)=x("?",@$_SERVER['REQUEST_URI']);$s=$_SERVER['SCRIPT_NAME'];$u=w($c,(z($c,0,u($s))==$s?u($s):u(n($s)))+1);if($u[0]=="/")$u=w($c,1);if($u[u($u)-1]=="/")$u=z($u,0,u($u)-1);$C="cache";$a="action";if(!empty($_GET[$C])){$d=r($_GET[$C]);switch($d){case "logo":c("image/png");$c=P."images/.phppe";die(f($c)?g($c):base64_decode("R0lGODlhKgAYAMIHAAACAAcAABYAAygBDD4BEFwAGGoBGwWYISH5BAEKAAcALAAAAAAqABgAAAOxeLrcCsDJSSkIoertYOSgBmXh5p3MiT4qJGIw9h3BFZP0LVceU0c91sy1uMwkwQfmYEzhiCwc8sh0QQ+FrMFQIAgY2cIWuUx9LoutWsxNs9udaxDKDb+7Wzth+huRRmlcJANrW148NjJDdF2Db2t7EzUUkwpqAx8EaoWRUyCXgVx5L1QUeQQDBGwFhIYDAxNNHJubBQqPBiWmeWqdWG+6EmrBxJZwxbqjyMnHy87P0BMJADs="));case "css":c("text/css");$p="position:fixed;top:";$s="text-shadow:2px 2px 2px #FFF;";$c="rgba(136,146,191";die("#pe_p{".$p."0;z-index:999;left:0;width:100%;padding:0 2px 0 32px;background-color:$c,0.9);background:linear-gradient($c,0.4),$c,0.6),$c,0.8),$c,0.9),$c,1) 90%,rgba(0,0,0,1));height:31px !important;font-family:helvetica;font-size:14px !important;line-height:20px !important;}#pe_p SPAN{margin:0 5px 0 0;cursor:pointer;}#pe_p UL{list-style-type:none;margin:3px;padding:0;}#pe_p IMG{border:0;vertical-align:middle;padding-right:4px;}#pe_p A{text-decoration:none;color:#000;".$s."}#pe_p .menu {position:fixed;top:8px;left:90px;}#pe_p .stat SPAN{display:inline-block;".$s."}#pe_p LI{cursor:pointer;}#pe_p LI:hover{background:#F0F0F0;}#pe_p .stat{".$p."6px;right:48px;}#pe_p .sub{".$p."28px;display:inline;background:#FFF;border:solid 1px #808080;box-shadow:2px 2px 6px #000;z-index:1000;}#pe_p .menu_i{padding:5px 6px 5px 6px;".$s."}#pe_p .menu_a{padding:4px 5px 5px 5px;border-top:solid #000 1px;border-left:solid #000 1px;border-right:solid #000 1px;background:#FFF;}@media print{#pe_p{display:none;}}");default:if(!empty(self::$mc)){$c=self::$mc->get("c_$d");if(self::$w&&a($c)&&!empty($c['d'])){c((!empty($c['m'])?$c['m']:"text/plain"));die($c['d']);}}die(k($C)."-E: ".$d);}}$B=self::$client->lang;if(ia($this->app,["css","js","images"])){function b($a,$b){c($a=="css"?"text/css":($a=="js"?"text/javascript":"image/png"));die(minify($b,$a));}$N='a_'.sha1($this->base.$u."_".self::$user->id."_$B");$d="";if(!empty(self::$mc))$d=self::$mc->get($N);if($d)b($this->app,$d);else{foreach([$this->$a,pr("/^core\.[^\.]+\.js/","core.js",$this->$a).PE,$this->$a.($this->item?"/".$this->item:"")] as$p){$A=N."*/".$this->app."/".s($p,["*"=>"",".."=>""]);$c=@glob($A,GLOB_NOSORT)[0];if($c){if(f($c)&&w($c,-4)!=PE){$d=g($c);$this->cachettl*=10;}else{ob_start();io($c);$d=o();}}if($d){if(!empty(self::$mc)&&empty($this->nocache))$this->_ms($N,$d);b($this->app,$d);}}}$c="404 Not Found";header("HTTP/1.1 $c");die;}self::$o=[];self::$o["core"]=&$this;self::$o["user"]=&self::$user;self::$o["client"]=&self::$client;$this->meta["viewport"]="width=device-width,initial-scale=1.0";$A=P."ctrl/";$X=[];$w=0;if(!empty($n)){$this->app=$n;$this->$a=!empty($ac)?$ac:$a;$f="";}elseif(!empty($c)&&!empty(self::$r)){uasort(self::$r,function($a,$b){return strcmp($b[0],$a[0]);});foreach(self::$r as$v){if(p("!^".s($v[0],"!","")."!i",$u,$X)){if(!self::_cf($v[3])){$w=1;continue;}array_shift($X);$d=$v[1];$f=$v[2];break;}}}if(empty($d))$d=$w?"403":$this->app;$R=$_REQUEST;if(self::$w){$c=$this->app.".".$this->$a;$S=!empty($_SESSION["pe_s"][$c])?$_SESSION["pe_s"][$c]:"";for($i=1;$i<=9;$i++)if(isset($R["pe_try".$i])&&!empty($R["pe_s"])&&$R["pe_s"]==$S){$this->try=$i;$this->form=!empty($R['pe_f'])?r($R['pe_f']):"";$_SESSION["pe_s"][$c]=0;break;}if(empty($_SESSION["pe_s"][$c]))$_SESSION["pe_s"][$c]=sha1(uniqid().$this->id);}if(empty($f))$f=$a."_".t($this->$a);if($this->app=="login"||$d=="login"){$A="admin";if($this->istry()&&!empty($R['id'])&&$R['id']==$A){if(!empty($this->masterpasswd)&&empty(self::$user->id)&&password_verify($_POST['pass'],$this->masterpasswd)){self::log("A","Login ".L($A),"users");$_SESSION["pe_u"]->id=-1;$_SESSION["pe_u"]->name=L($A);$this->redirect();}}if($_SESSION["pe_u"]->id)$this->redirect("/");}elseif($this->app=="logout"||$d=="logout"){$i=self::$user->id;if($i){self::log("A","Logout ".self::$user->name,"users");if($i!=-1&&q(self::$user,"logout"))self::$user->logout();}session_destroy();$this->redirect("/");}$A=!empty(self::$mc)&&empty($this->nocache);if(!cc($d)){if($d[0]=="\\")$d=w($d,1);$C=t($d);$E=$this->$a;$F=t($E);$P="app/ctrl/";$H=N."*/ctrl/";foreach(array_unique(["$P$d"."_$E".PE,"$P$C"."_$F".PE,"$P$d".PE,"$P$C".PE,"$H$d"."_$E".PE,"$H$C"."_$F".PE,"$H$d".PE,"$H$C".PE]) as$v){$c=@glob($v);if(!empty($c[0])){$D=count(gc());try{@io($c[0]);}catch(\Exception$e){}$P=gc();for($G=$D;!empty($P[$G]);$G++)if(cc($P[$G])){$d=$P[$G];break;}self::$p=n(n($c[0]));break;}}}$G=f(P."sql/pages.sql");$P=C."App";$D="Ctrl\\";$V="pe_v";if(cc(C.$d))$d=C.$d;elseif(cc(C.$D.$d))$d=C.$D.$d;list($d,$f)=$this->_eh("app",[$d,$f]);$D=$o=[];if(!cc($d)){if(!self::$w)die($d=="cron"?$this->_eh("cron_".$this->action,0):"PHPPE-C: ".L($d."_$a not found!")."\n");$d=$P;if(!empty(Core::db(0))&&$G){try{$T="template";$C='d_'.sha1($this->base.$u."_$B");if($A)$D=self::$mc->get($C);if(empty($D[$T])){Core::ds(0);$D=Core::fetch("*","pages","(id=? OR ? LIKE id||'/%') AND (lang='' OR lang=?) AND pubd<=".T." AND (expd=0 OR expd>".T.")","","id DESC,created DESC",[$u,$u,$B]);if($A&&!empty($D[$T]))$this->_ms($C,$D);}if(!empty($D[$T])){if(!self::_cf($D['filter'])){$this->$T="403";throw new\Exception();}array_unshift($X,$D);$d=C."Content";$f=$a;Core::$core->template=$D[$T];$o=@jd($D['data']);if(!a($o))$o=[];$c=w($u,u($D['id'])+1);$o['params']=x("/",$c);}}catch(\Exception$e){$D=[];}}}$p=s($d,["PHPPE\\App\\"=>"","PHPPE\\Ctrl\\"=>""]);foreach([self::$p,N.$p,N.$this->app] as$C)if($C){$c=@include("$C/config".PE);if(a($c))break;}if(!empty($_SESSION[$V]))self::$v=$_SESSION[$V];self::$o["app"]=$app=new$d(a($c)?$c:[]);if(!q($app,$f))$f=$a;self::log("D",$this->app."/".$this->$a." ->$d::$f ".$this->template,"routes");$A&=empty($this->nocache);$m="maintenance";if(empty($this->$m)||!self::$w){$C='p_'.sha1($this->base.$u."_".self::$user->id."_$B");$T="";if($A&&!self::isTry()){$p=self::$mc->get($C);if(a($p)){foreach(['m'=>'meta','c'=>'css','j'=>'js','J'=>'jslib'] as$k=>$v)if(a($p[$k]))$this->$v=array_merge($this->$v,$p[$k]);$T=$p['d'];}}if(!$T){$p=[];$d="dds";if($G){try{$F=self::fetch("*","pages","id='frame'");$E=@jd($F['data']);self::$o['frame']=$E;$E=@jd($F[$d]);if(a($E))$p+=$E;}catch(\Exception$e){}}if(!empty($D)){$e=jd($D[$d]);if(a($e))$p+=$e;$this->site=$D['name'];foreach(["id","name","template","lang","modifyd"] as$v)$o[$v]=$D[$v];}if(a($p)){foreach($p as$k=>$c)if(!ia($k,[$d,"id"])){try{$o[$k]=@self::query($c[0],$c[1],s(@$c[2],"@ID",$k),@$c[3],@$c[4],@$c[5],self::getval(@$c[6]));}catch(\Exception$e){self::log("E",$D['id']." ".$e->getMessage()." ".implode(" ",$c),$d);}}}foreach($o as$k=>$v)if($k!=$d)$app->$k=$v;$this->_eh("ctrl",[$d,$f]);if(q($app,$f))!empty($X)?call_user_func_array([$app,$f],$X):$app->$f($this->item);if(!empty($app->_meta))$this->meta=array_merge($this->meta,$app->_meta);$_SESSION[$V]=[];$d=!empty($app->_template)?$app->_template:$this->template;if(!empty($d)){$T=$this->template($d);if(!$T)$T=$this->template($this->app);if(!$T&&self::$w)$T=$this->template("404");}if(empty($this->noframe)){$d=$this->template("frame");if(p("/<!app>/ims",$d,$m,PREG_OFFSET_CAPTURE))$T=z($d,0,$m[0][1]).$T.w($d,$m[0][1]+6);}if($A&&$T)$this->_ms($C,["m"=>$this->meta,"c"=>$this->css,"j"=>$this->js,"J"=>$this->jslib,"d"=>$T]);}}else{$T=$this->template($m);if(empty($T))$T=L(ucfirst($m));}if((@ia("--dump",$_SERVER['argv'])||isset($R['--dump']))&&$this->runlevel>1){c("text/plain");print_r($_SERVER);print_r(self::$o);die;}if(!empty(self::$db))foreach(self::$db as$d)if(q($d,"close"))$d->close();self::$db=[];self::$s=0;$T=$this->_eh("view",$T);$o=isset($app->_output)?$app->_output:$this->output;if(self::$w){header("Pragma:no-cache");header("Cache-Control:no-cache,no-store,private,must-revalidate,max-age=0");header("Content-Type:".(!empty($app->_mimetype)?$app->_mimetype:"text/".($o?$o:"html")).";charset=utf-8");}if($o){$c=@glob(N."*/out/".$o."_header".PE);if(!empty($c[0]))io($c[0]);elseif($o=="html"){$P=empty($this->nopanel)&&self::$user->has("panel");$I=m(__FILE__)."/";if($I==I.".php/")$I="";$d="http".($this->sec?"s":"")."://".$this->base;$O="<!DOCTYPE HTML>\n<html lang='$B'".(!empty(self::$l['rtl'])?" dir='rtl'":"")."><head><title>".(!empty($this->site)?$this->site:$this->id)."</title><base href='$d'/><meta charset='utf-8'/>\n<meta name='Generator' content='http://phppe.org/'/>\n";foreach($this->meta as$k=>$m)if($m)$O.="<meta name='$k' content='".h($m)."'/>\n";$O.="<link rel='shortcut icon' href='".(empty($app->_favicon)?'favicon.ico':$app->_favicon)."'/>\n";$O.="<style media='all'>\n";$d="@import url('%s');\n";$N=$this->base."_".$this->app.".".$this->$a."_".self::$user->id."_$B";if($P)$O.=sprintf($d,$I."css/?cache=css");if(!empty($this->css)){if(!empty(self::$mc)&&empty($this->noaggr)){$n=sha1($N."_css");if(empty(self::$mc->get("c_$n"))){$da="";foreach($this->css as$u=>$v)if($v&&w($v,-3)!="php"&&$u[0]!="?")$da.=minify(r(g($v)),"css")."\n";$this->_ms("c_$n",["m"=>"text/css","d"=>$da]);}$O.=sprintf($d,$I."css/?cache=$n");foreach($this->css as$u=>$v)if($v&&($u[0]=="?"||w($v,-3)=="php"))$O.=sprintf($d,($u[0]=="?"?"":$I."css/").$u);}else{foreach($this->css as$u=>$v)if($v)$O.=sprintf($d,($u[0]=="?"?"":$I."css/").$u);}}$O.="</style>\n";$d="<script type='text/javascript'";$e="</script>\n";$a=" async src='".$I."js/";if(!empty($this->jslib)){if(!empty(self::$mc)&&empty($this->noaggr)){$n=sha1($N."_js");if(empty(self::$mc->get("c_$n"))){$da="";foreach($this->jslib as$u=>$v)if($v&&w($v,-3)!="php")$da.=minify(r(g($v)),"js")."\n";$this->_ms("c_$n",["m"=>"text/javascript","d"=>$da]);}$O.="$d async src='${I}js/?cache=$n'>$e";foreach($this->jslib as$u=>$v)if($v&&($u[0]=="?"||w($v,-3)=="php"))$O.="$d$a$u'>$e";}else{foreach($this->jslib as$u=>$v)if($v)$O.="$d$a$u'>$e";}}$c="users.js";if($P&&!isset($this->jslib[$c])&&f(N."users/js/".$c.PE))$O.="$d$a$c'>$e";$c=$this->js;$a="";if($P&&empty($this->css["core.css"])){$x="document.getElementById(";$y=".style.visibility";$a="pe_t=setTimeout(function(){pe_p('');},2000)";$c["L(t)"]="return t.replace(/_/g,' ');";$c['pe_p(i)']="var o=i?${x}i):i;if(pe_t!=null)clearTimeout(pe_t);if(pe_c&&pe_c!=i)${x}pe_c)$y='hidden';pe_t=pe_c=null;if(o!=null){if(o$y=='visible')o$y='hidden';else{o$y='visible';pe_c=i;$a;}}return false;";$c['pe_w()']="if(pe_t!=null)clearTimeout(pe_t);$a;return false;";$a=",pe_t,pe_c";}if(!empty($c)){$O.=$d.">\nvar pe_ot=".($P?31:0)."$a;\n";foreach($c as$fu=>$co)$O.="function $fu {".$co."}\n";$O.=$e;}$O.="</head>\n<body".(!empty($this->js["init()"])?" onload='init();'":"").">\n";if($P){$H=" class='sub' style='visibility:hidden;' onmousemove='return pe_w();'";$O.="<div id='pe_p'><a href='".url("/")."'><img src='$I?cache=logo' alt='".$this->id."' style='margin:3px 10px -3px 10px;float:left;'></a><div class='menu'>";$x=0;if(!empty($this->menu)){foreach($this->menu as$e=>$L){@list($ti,$a)=x("@",$e);if($a&&!self::$user->has($a))continue;$a=0;if(a($L))$l=$L[array_keys($L)[0]];else$l=$L;$U=$_SERVER['REQUEST_URI'];if(z($l,0,u($U))==$U||"/".z($l,0,u($U))==$U)$a=1;else{$d=x("/",$l);if(empty($d[0]))$d=array_shift($d);if($this->app==(!empty($d[0])?$d[0]:I))$a=1;unset($d);}if(a($L)){$O.="<div id='pe_m$x'$H><ul>";foreach($L as$t=>$l)if($t){@list($Y,$A)=x("@",$t);if($A||self::$user->has($A))$O.="<li onclick=\"document.location.href='".$I."$l';\"><a href='".$I."$l'>".h(L($Y))."</a></li>";}$O.="</ul></div><span class='menu_".($a?"a":"i")."' onclick='return pe_p(\"pe_m$x\");'>".h(L($ti))."</span>";$x++;}else$O.="<span class='menu_".($a?"a":"i")."'><a href='".$I."$L'>".h(L($ti))."</a></span>";}}$O.="</div><div class='stat'>";foreach($this->libs as$d)if(q($d,"stat"))$O.="<span>".$d->stat()."</span>";$O.="<div id='pe_l'$H><ul>";if(!empty($_SESSION['pe_ls']))$d=$_SESSION['pe_ls'];else{$D=array_unique(@scandir("app/lang")+@scandir(P."lang"));$d=[];foreach($D as$f)if(w($f,-4)==".php")$d[z($f,0,u($f)-4)]=1;$_SESSION['pe_ls']=$d;}foreach($d as$k=>$v)if($k)$O.="<li><a href='".url()."?lang=$k'><img src='images/lang_$k.png' alt='$k' title='$k'>".($k!=L($k)?"&nbsp;".L($k):"")."</a></li>";$O.="</ul></div>";$k=$B;$f="images/lang_$k.png";$c=!empty($_SESSION['pe_c']);$O.="<span onclick='return pe_p(\"pe_l\");'>".(f(P.$f)?"<img src='$f' height='10' alt='$k' title='$k'>":$k)."</span><div id='pe_u'$H><ul><li onclick='pe_p(\"\");if(typeof users_profile==\"function\")users_profile(this);else alert(\"".L("Install PHPPE Pack")."\");'>".L("Profile")."</li>".(self::$user->has("conf")?"<li><a href='".url()."?conf=".(1-$c)."'>".L(($c?"Lock":"Unlock"))."</a></li>":"")."<li><a href='".url("logout")."'>".L("Logout")."</a></li></ul></div><span onclick='return pe_p(\"pe_u\");'>".(!empty(self::$user->name)?self::$user->name:"#".self::$user->id)."</span></div></div><div style='height:32px !important;'></div>\n";}echo$O;}}echo($T);if($o){$c=@glob(N."*/out/".$o."_footer".PE);if(!empty($c[0]))io($c[0]);elseif($o=="html"){$D=count($this->error);$d='REQUEST_TIME_FLOAT';$T=!empty($_SERVER[$d])?$_SERVER[$d]:$this->started;echo("\n<!-- MONITORING: ".($D>0?"ERROR":($this->runlevel>0?"WARNING":"OK")).", page ".sprintf("%.4f sec, db %.4f sec, server %.4f sec, mem %.4f mb%s -->\n</body>\n</html>\n",microtime(1)-$T,self::$b,$this->started-$T,memory_get_peak_usage()/1024/1024,!empty(self::$mc)?", mc":""));}}session_write_close();}static function langInit($c="",$i=[]){if($c=="")$c=m(n(n(d(2))));$L=empty(self::$client->lang)?"en":self::$client->lang;if(empty($i[0]))$i=x("_",s($L,"-","_"));$la="";$c=N."$c/lang/";foreach([$L,$i[0],"en"] as$l){if(f($c.$l.PE)){$la=io($c.$l.PE);break;}}if(a($la))self::$l+=$la;}static function log($w,$m,$n=null){if(!is_string($m)||self::$core->runlevel<3&&$w=="D")return;$w=k($w);if(!ia($w,["D","I","A","W","E","C"]))$w="A";if(empty($n))$n=!empty(self::$core->app)?self::$core->app:"core";$m=r(s($m,n(n(__FILE__))."/",""));$g=!empty(self::$l[$m])?L($m):$m;$t="";if(!empty(self::$core->trace)){$s=debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS);foreach($s as$d)$t.="\t".w($d['file'],u(n(__DIR__))+1).":".@$d['line'].":".$d['function']."\n";}$e=e(0);date_default_timezone_set("UTC");$p=date("Y-m-d")."T".date("H:i:s")."Z-$w-".k($n).": ";if($w=="A"||$w=="C"||self::$core->syslog)syslog($w=="C"?LOG_ERR:LOG_NOTICE,self::$core->base.":PHPPE-$w-".k($n).": ".s($m,["\n"=>"\\n","\r"=>"\\r"]).s($t,"\n",""));$l=P."log/".$n.".log";if(!self::$core->syslog&&!file_put_contents($l,$p.s($m,["\n"=>"\\n","\r"=>"\\r"])."\n".$t,FILE_APPEND|LOCK_EX)){$w="C";$g.=(!self::$w?"\nLOG-C":"<br/>\n".date("Y-m-d")."T".date("H:i:s")."Z-C-LOG").": ".L("unable to write")." $l";}@chmod($l,0660);if($w=="C"){if(self::$core->output!="html")die(k("$n-C").": ".$g."\n".$t);die("\n<html><body style='margin:8px;background:#000000;color:#A00000;'><div style='text-align:center;font-size:28px;color:#ff0000;'>PHPPE".VERSION." - ".L("Developer Console")."</div><br/><br/>\n$p".nl2br(s("$g\n$t","\t","&nbsp;&nbsp;"))."</body></html>\n");}elseif(!self::$w&&$w!="D"&&$w!="I")fwrite(STDERR,k("$n-$w").": ".$g."\n");date_default_timezone_set($_SESSION['pe_tz']);e($e);return true;}static function lib($n="",$l="",$D="",&$o=null){$L=&self::$core->libs;if($l==""&&empty($D)&&!$o)return empty($n)?$L:(empty($L[$n])?null:$L[$n]);$d="";if(empty($n)){$n=m(d(1));if(p("/([0-9]+\_)?([^\/\_]+)([^\/]*)\.php$/i",$n,$m))$n=$m[2];unset($m);}if($D){if(!a($D))$D=x(",",$D);foreach($D as$v)if(!self::isInst($v))$d.=($d?",":"").$v;if($d)self::log("C","$n depends on: $d");}if(!$d&&$n){if(empty($L[$n]))$L[$n]=$o?$o:new\StdClass();$L[$n]->name=L(empty($l)?$n:$l).(!empty($o->version)?" (".$o->version.")":"");}}static function addon($n="",$l="",$D="",$c=""){if(empty($n)){$S=[self::$core->addons,self::$core->js,self::$core->jslib,self::$core->css];$d=@glob(N."*/addons/*".PE);foreach($d as$f){$F=m($f);$d=io($f);$w=z($F,0,u($F)-4);$W=A.$w;if(ce($W)){self::addon($w,"addon $w");if(q($W,"init")){$W=new$W([],$w,$w);$W->init();unset($W);}}}$r=self::$core->addons;list(self::$core->addons,self::$core->js,self::$core->jslib,self::$core->css)=$S;return$r;}$d="";if($D){if(!a($D))$D=x(",",$D);foreach($D as$v)if(!self::isInst($v))$d.=($d?",":"").$v;}if(empty($d)){self::$core->addons[$n]=(object)['name'=>L(empty($l)?"addon $n":$l),'conf'=>$c];LANG_INIT($n);}else self::log("E","$n depends on: $d");}static function isInst($n){return(isset(self::$core->libs[$n])||isset(self::$core->addons[$n])||ce(C.$n)||ce(A.$n)||!empty(@glob(N."*/addons/".$n.PE)[0]));}static function e($w,$c,$m){if(!is_string($m))$m=json_encode($m);return!empty(self::$core->output)&&self::$core->output=="html"?"<span style='background:#F00000;color:#FEA0A0;padding:3px;'>".($w?"$w-":"").($c?"$c:&nbsp;":"").h($m)."</span>":"$c-$w: ".s($m,["\r"=>"","\n"=>"\\n"])."\n";}static function error($m="",$f=""){if(empty($m))return self::$core->error;if(!isset(self::$core->error[$f]))self::$core->error[$f]=[];self::$core->error[$f][r($m)]=r($m);if(self::$core->runlevel>1)self::log("E",$f."@".$_SERVER['REQUEST_URI']." ".$m,"validate");}static function isError($f=""){return!empty($f)?isset(self::$core->error[$f]):!empty(self::$core->error);}static function route($u="",$n="",$a="",$f=[]){if(empty($u))return self::$r;$A="action";$F="filters";$U="url";$N="name";if(is_string($u)&&!empty($n)){if(!a($f))$f=x(",",$f);self::$r[j($u,$n,$a)]=[$u,$n,$a,$f];}elseif(a($u)&&!empty($u[$U])&&!empty($u[$N])){$f=!empty($u[$F])?$u[$F]:[];$a=!empty($u[$A])?$u[$A]:"";self::$r[j($u[$U],$u[$N],$a)]=[$u[$U],$u[$N],$a,a($f)?$f:x(",",$f)];}elseif(a($u)&&!empty(current($u)[0])){foreach($u as$v)self::$r[j($v[0],$v[1],(!empty($v[2])?$v[2]:""))]=$v;}elseif(is_object($u)&&!empty($u->$U)&&!empty($u->$N)){$f=!empty($u->$F)?$u->$F:[];$a=!empty($u->$A)?$u->$A:"";self::$r[j($u->$U,$u->$N,$a)]=[$u->$U,$u->$N,$a,a($f)?$f:x(",",$f)];}else self::log("W","bad route: ".serialize($u));if(count(self::$r)>=512)self::log("C","too many routes");}static function isTry($f=""){return empty($f)||$f==self::$core->form?self::$core->try:0;}static function mc(){return self::$mc;}static function ic($n){$m=self::$mc;if($m){$b=sha1(self::$core->base."_$n");$m->set("t_$b","");$m->set("p_".$b."_".self::$user->id."_".self::$client->lang,"");}}static function url($m="",$p=""){$c=self::$core->base;$A=self::$core->app;$f=m(__FILE__);if(empty($m)&&!empty($A))$m=$A;if(empty($p)&&!empty($A)&&$A==$m)$p=self::$core->action;$a=($m!="/"?($m.$p!=I."action"?$m."/":"").(!empty($p)&&$p!="action"?$p."/":""):"");return "http".(self::$core->sec?"s":"")."://".$c.($c[u($c)-1]!="/"?"/":"").($f!=I.PE?$f.($a?"/":""):"").$a;}static function redirect($u="",$s=0){if($s)self::_r();if(empty($u)&&!empty($_SESSION["pe_r"])){$u=$_SESSION["pe_r"];unset($_SESSION["pe_r"]);}session_write_close();header("HTTP/1.1 302 Found");$f=m(__FILE__);header("Location:".(!empty($u)?(strpos($u,"://")?$u:"http".(self::$core->sec?"s":"")."://".self::$core->base.($f!=I.PE?$f."/":"").($u!="/"?$u:"")):self::url().self::$core->item));exit();}static function get($u,$p="",$T=3,$l=0){static$C;if($l>7)return;if(p("/^([^\:]+)\:\/\/([^\/\:]+)\:?([0-9]*)(.*)$/",$u,$m)){$s=0;if($m[1]!="http"&&$m[1]!="https")return;if($m[1]=="https"){$s=1;$m[2]="ssl://".$m[2];}if($m[3]=="")$m[3]=($m[1]=="http"?80:443);if($m[4]=="")$m[4]="/";$f=fsockopen($m[2],$m[3],$n,$e,$T);if(!$f){self::log("E","$u #$n $e","http");return($s&&strpos($e,'"ssl"')?file_get_contents($u):"");}$P=a($p)?http_build_query($p,"_"):"";$o=($P?"POST":"GET")." ".$m[4]." HTTP/1.0\r\nHost: ".$m[2]."\r\nAccept-Language: ".self::$client->lang.";q=0.8\r\n".($C?"Cookie: ".http_build_query($C,"",";")."\r\n":"").($P?"Content-Type: application/x-www-form-urlencoded\r\nContent-Length: ".u($P)."\r\n":"")."Connection: close;\r\n\r\n".$P;fwrite($f,$o);$d=$H=$n="";$h="-";$t=0;stream_set_timeout($f,$T);while(!feof($f)&&r($h)!=""){$h=r((fgets($f,4096)));if(!empty($h))$H=t($h);if(z($H,0,8)=="location")$n=r(w($h,9));if(z($H,0,12)=="content-type"&&strpos($h,"text/"))$t=1;if(z($H,0,10)=="set-cookie"){$c=x("=",x(";",r(w($h,11)))[0]);@$C[$c[0]]=$c[1];}}if($n&&$n!=$u)return self::get($n,$p,$T,$l+1);if($H){while(!feof($f))$d.=fread($f,65535);self::log("D","$u ".strlen($d),"http");}else self::log("E","$u timed out $T","http");fclose($f);return$t?s($d,"\r",""):$d;}}static function si($i){$v=r(ini_get($i));$l=t($v[u($v)-1]);switch($l){case 't':$v*=1024;case 'g':$v*=1024;case 'm':$v*=1024;case 'k':$v*=1024;}return$v;}static function validate($f,$v,$r=0,$a=[],$t=[]){if(q(A.$v,"validate"))self::$v[$f][$v]=[!empty($r),$a,$t];}static function req2arr($p,$V=[]){return self::req2obj($p,$V,1);}static function req2obj($p,$V=[],$a=0){if($a)$o=array();else$o=new\stdClass();if(!empty(self::$v))$V+=self::$v;$R=$_REQUEST;$E="error";foreach($V as$K=>$v){if(z($K,0,u($p)+1)==$p."."){$d=w($K,u($p)+1);$r=$p."_".$d;foreach($v as$T=>$C){if(($T=="check"||!empty($C[0]))&&empty($R[$r]))$R[$r]=$T=="check"?false:"";elseif(($T=="date"||$T=="time")&&!empty($R[$r.":y"]))list($R[$r])=AddOn\date::validate($K,$r,$C[1],$C[2]);elseif($T=="file"){$f=empty($_FILES[$r])?[]:$_FILES[$r];if(!empty($f[$E])&&$f[$E]!=4)self::error(L(ucfirst($d))." ".L("failed to upload file."),$K);$R[$r]=isset($f[$E])&&$f[$E]==0?$f:[];}}}}ksort($R);foreach($R as$k=>$v){if(z($k,0,u($p)+1)==$p."_"&&$k[u($k)-2]!=":"){$d=w($k,u($p)+1);$K=$p.".".$d;if(isset($V[$K])){foreach($V[$K] as$T=>$C){$t=A.$T;if($T=="num")$v+=0.0;if($T=="check")$v=$v?($v==1||$v=='1'?true:$v):false;if(!empty($C[0])&&empty($v)){$v=null;self::error(L(ucfirst($d))." ".L("is a required field."),$K);}elseif(!empty($v)&&q($t,"validate")){list($r,$m)=$t::validate($K,$v,$C[1],$C[2]);if(!$r&&$m){list($O,$f)=x(".",$K);self::error(L(ucfirst(!empty($f)?$f:$O))." ".L($m),$K);}}}}$v=$v=="true"?true:($v=="false"?false:$v);if($a)$o[$d]=$v;else$o->$d=$v;}}return$o;}static function arr2str($o,$s="",$c=" "){return self::obj2str($o,$s,$c);}static function obj2str($o,$s="",$c=" "){if(!a($s))$s=x(",",$s);$r="";$d=Core::db();if(is_string($o))$o=[$o];foreach($o as$k=>$v){if(!ia($k,$s))$r.=($r?$c:"").$k."=".($c==","&&!empty($d)?$d->quote($v):"'".str_replace(["\r","\n","\t","\x1a"],["\\r","\\n","\\t","\\x1a"],ad($v))."'");}return$r;}static function val2arr($s,$c=","){if(a($s))return$s;elseif($s!=""){$v=self::getval($s);if(a($v))return$v;return x($c,$v);}return null;}static function tre2arr($t,$p="  ",$s="",$P="",$S="",&$d=null){foreach($t as$v){$i=count($d);foreach($v as$k=>$w){if($k!="_"){$c=t($k)=="name"&&!$s?$P.$w.$S:$w;if(a($v))$d[$i][$k]=$c;elseif(is_object($v))$d[$i]->$k=$c;}}if(a($v)&&!empty($v["_"])||is_object($v)&&!empty($v->_)){if($s){$c="\n".sprintf($p,$i);if(a($d[$i])&&isset($d[$i]["name"]))$d[$i]["name"].=$c;elseif(is_object($d[$i])&&isset($d[$i]->name))$d[$i]->name.=$c;}$d=self::tre2arr(a($v)?$v["_"]:$v->_,$p,$s,$P.($s?"":$p),($s?"":$s).$S,$d);if($s){$c="\n".$s;if(a($d[count($d)-1])&&isset($d[count($d)-1]["name"]))$d[count($d)-1]["name"].=$c;elseif(is_object($d[count($d)-1])&&isset($d[count($d)-1]->name))$d[count($d)-1]->name.=$c;}}}return$d;}static function db($u=null,$O=null){if(empty($u))return self::$db[self::$s];$S=microtime(1);$I="init";try{if(!p("/^(.*)@([^@:]+)?:?([^:]*)$/",$u,$d))$d[1]=$u;if(!a(self::$db))self::$db=[];self::$s=count(self::$db);self::$db[]=is_object($O)?$O:new\PDO($d[1],!empty($d[2])?$d[2]:"",!empty($d[3])?$d[3]:"",[\PDO::ATTR_ERRMODE=>\PDO::ERRMODE_EXCEPTION,\PDO::ATTR_EMULATE_PREPARES=>0]);if(!isset(self::$db[self::$s]))throw new\Exception();$d=&self::$db[self::$s];$d->id=count(self::$db);$d->name=is_object($O)?get_class($O):$d->getAttribute(\PDO::ATTR_DRIVER_NAME);$d->s=@include(@glob(N."*/libs/ds_".$d->name.PE)[0]);if(!isset(self::$core->libs["ds"])){self::lib("ds","DataSource");self::$core->libs["ds"]->primary=$d->name;}if(!empty($d->s[$I])){$c=x(";",$d->s[$I]);foreach($c as$n=>$C)if(!empty(r($C)))$d->exec(r($C));}}catch(\Exception$e){self::log(self::$s?"E":"C","Unable to $I: $u, ".$e->getMessage(),"db");throw$e;}self::$b+=microtime(1)-$S;return self::$s;}static function ds($s=-1){if($s>=0&&$s<count(self::$db)&&!empty(self::$db[$s]))self::$s=$s;return self::$s;}static function like($s){return pr("/[%_]+/","%","%".pr("/[^a-z0-9\%]/i","_",pr("/[\ \t]+/","%",s(r($s),"%","")))."%");}static function exec($q,$a=[]){self::log("D",$q." ".json_encode($a),"db");if(!a($a))$a=[$a];if(empty(self::$db[self::$s]))throw new\Exception(L("Invalid ds")." #".self::$s);$q=r($q);if(empty($q)||$q[0]=='-'||$q[0]=='/')return 1;$t=microtime(1);$r=null;$h=self::$db[self::$s];try{if(a($h->s))foreach($h->s as$k=>$v)$q=pr($k,$v,$q);$i=t(z($q,0,6))=="select";$s=$h->prepare($q);$s->execute($a);$r=$i?$s->fetchAll(\PDO::FETCH_ASSOC):$s->rowCount();}catch(\Exception$e){$E=$e->getMessage();if((p("/able:?\ [\'\"]?([a-z0-9_\.]+)/mi",s($E,"le or v",""),$d)||p("/([a-z0-9_\.]+)[\'\"] does\ ?n/mi",$E,$d)||p("/name:?\ [\'\"]?([a-z0-9_\.]+)/mi",$E,$d))&&!empty($d[1])){$c="";$m=".".t($h->name);$d=x(".",$d[1]);$d=r(!empty($d[1])?$d[1]:$d[0]);list($D)=x("_",$d);foreach(["app/sql/$d",self::$p?self::$p."/sql/$d":"",N."$D/sql/$d",N.ucfirst($D)."/sql/$d",P."sql/$d",N.self::$core->app."/sql/$d"] as$f){if($f&&f("$f$m.sql")){$c=g("$f$m.sql");break;}if($f&&f("$f.sql")){$c=g("$f.sql");break;}}if(empty($c)){self::log("E",$E,"db");throw$e;}$c=x(";",$c);foreach($c as$n=>$C){try{if(!empty(r($C)))$h->exec(r($C));}catch(\Exception$e){self::log("C","creating $d line:".($n+1)." ".$e->getMessage(),"db");}}self::log("A","$d created.","db");$s=$h->prepare($q);$s->execute($a);$r=$i?$s->fetchAll(\PDO::FETCH_ASSOC):$s->rowCount();}else{self::log("E",$q." ".json_encode($a)." ".$E,"db");$r=null;throw$e;}}self::$b+=microtime(1)-$t;return$r;}static function query($f,$t,$w="",$g="",$o="",$s=0,$l=0,$a=[]){$q="SELECT ".$f.($t?" FROM ".$t:"").($w?" WHERE ".$w:"").($g?" GROUP BY ".$g:"").($o?" ORDER BY ".$o:"").($l?(" LIMIT ".($s?$s.",":"").$l):"").";";return self::exec($q,$a);}static function fetch($f,$t="",$w="",$g="",$o="",$a=[]){$r=self::query($f,$t,$w,$g,$o,0,1,$a);return empty($r[0])?[]:$r[0];}static function field($f,$t="",$w="",$g="",$o="",$a=[]){return reset(self::fetch($f,$t,$w,$g,$o,$a));}static function tree($q,$p=0){$r=self::exec($q,[$p]);if(empty($r))return[];foreach($r as$k=>$v){$i=isset($v['id'])?$v['id']:-1;if(!empty($i)&&$i!=$p){$c=self::tree($q,$i);if(!empty($c))$r[$k]["_"]=$c;}}return$r;}static function css($c=""){if(empty($c))return self::$core->css;$a=n(d(1));if(ia(m($a),["ctrl","libs","js","css","addons"]))$a=n($a);$a.="/css/".@x("?",$c)[0];if(!f($a))$a.=".php";if(!isset(self::$core->css[$c])&&f($a))self::$core->css[$c]=realpath($a);}static function jslib($l="",$i=""){if(empty($l))return self::$core->jslib;$a=n(d(1));if(ia(m($a),["ctrl","libs","js","css","addons"]))$a=n($a);$a.="/js/".@x("?",$l)[0];if(!f($a))$a.=".php";if(!isset(self::$core->jslib[$l]))self::$core->jslib[$l]=realpath($a);if(!empty($i)&&(empty(self::$core->js["init()"])||strpos(self::$core->js["init()"],r($i))===false)){$i=r($i);self::js("init()",$i.($i[u($i)-1]!=";"?";":""),true);}}static function js($f="",$c="",$a=0){if($c){$C=minify($c,"js");$C.=($C[u($C)-1]!=";"?";":"");if($a){if(!isset(self::$core->js[$f]))self::$core->js[$f]="";if(strpos(self::$core->js[$f],$C)===false)self::$core->js[$f].=$C;}else self::$core->js[$f]=$C;}}static function menu($t="",$l=""){if(is_string($l)||a($l))self::$core->menu[$t]=$l;}static function picture($o,$n,$w,$h,$c=0,$l=1,$W="",$s=8192,$m=5){$d=g($o);if(!y("gd_info")||empty($d)||!($i=@imagecreatefromstring($d))){Core::log('W',"no php-libgd or bad image: $o","picture");if(f($o))@copy($o,$n);return false;}$x=imagesx($i);$y=imagesy($i);$q=9;$m=($m>0&&$m<10?$m:5);$s=($s>64?$s:64)*1024;$j="imagepng";if(!$l){$j="imagejpeg";$m*=10;$q=99;}Core::log('D',$o."($x,$y) -> ".$n."($w,$h,".($c?"crop":"resize").",$j,$s,$q) $W","picture");if(!$c){$X=$x<$y?floor(($h/$y)*$x):$w;$Y=$x<$y?$h:floor(($w/$x)*$y);$c=$d=0;$e=$x;$f=$y;}else{$X=$w;$Y=$h;$c=$x>$y?floor(abs($x-$y)/2):0;$d=$x>$y?0:floor(abs($y-$x)/2);$e=$x>$y?floor($w*$y/$h):$x;$f=$x>$y?$y:floor($w*$x/$h);}$N=imagecreatetruecolor($X,$Y);if($l){imagealphablending($N,0);$a=imagecolorallocatealpha($N,255,255,255,255);imagesavealpha($N,1);}else$a=imagecolorallocate($N,255,255,255);imagefill($N,0,0,$a);imagecopyresampled($N,$i,0,0,$c,$d,$X,$Y,$e,$f);$T="data/".$W.".png";if(!empty($W)&&f($T)){$g=imagecreatefrompng($T);$a=imagesx($g);$b=imagesy($g);for($y=0;$y<$Y;$y+=$a)for($x=0;$x<$X;$x+=$a)imagecopyresampled($N,$g,$x,$y,0,0,$a,$b,$a,$b);}@unlink($n);while(!f($n)||(filesize($n)>$s&&$q>=$m)){@unlink($n);if(!$j($N,$n,$q--)){@copy($o,$n);return false;}}return true;}static function template($n){if($n=="403"||$n=="404")header("HTTP/1.1 $n ".($n=="403"?"Access Denied":"Not Found"));$d=self::_gt($n);if(empty($d))return "";self::$n=-1;self::$c=[];return self::_t($d);}static function getval($x){if(!is_string($x))return$x;if(strpos($x,"$")!==false||p("/[^!=]=[^=]/",$x))return self::e("W","BADINP",$x);$l=$r="";$d=$x;for($i=0;$i<u($d);$i++){$c=$d[$i];if($c=='"'||$c=="'"){$r.=$c;$i++;$b="";while($i<u($d)&&$b!=$c){if($b=="\\")$b.=$d[++$i];$r.=$b;$b=$d[$i++];}$r.=$c;$l="";}if((ctype_alpha($c)||$c=="_")&&!ctype_alnum($l)&&$l!="."&&$l!="_"){$j=$i;$b=$d[$j];while($b&&(ctype_alnum($b)||$b=="_")){$j++;$b=isset($d[$j])?$d[$j]:"";}if($b!="("&&$b!=":"){$v=z($d,$i,$j-$i);switch($v){case "KEY":case "IDX":case "VALUE":if(isset(self::$c[self::$n]->$v))$v=self::$c[self::$n]->$v;if(a($v))return$v;@$r.="'".ad($v)."'";$i=$j;break;case "ODD":$r.=self::$c[self::$n]->IDX%2;$i=$j;break;case "parent":$Y=self::$n-1;while(z($d,$j,7)==".parent"){$j+=7;$Y--;}$n=z($d,$j+1,3);$j+=4+($n=="VAL"?2:0);if($n=="ODD")$v=self::$c[$Y]->IDX%2;elseif(isset(self::$c[$Y]->$n))$v=self::$c[$Y]->$n;elseif(isset(self::$c[$Y]->VALUE->$n))$v=self::$c[$Y]->VALUE->$n;elseif(isset(self::$c[$Y]->VALUE[$n]))$v=self::$c[$Y]->VALUE[$n];else$v="";$r.="'".ad($v)."'";$i=$j;break;case "true":case "false":case "null":break;default:if(isset(self::$c[self::$n])&&a(self::$c[self::$n]->VALUE)){@$r.="'".ad(self::$c[self::$n]->VALUE[$v])."'";$i=$j;}elseif(isset(self::$c[self::$n]->VALUE->$v)){@$r.="'".ad(self::$c[self::$n]->VALUE->$v)."'";$i=$j;}else{$r.="\$";$f[$v]=1;}}}elseif($b=="("&&($j-$i!=1||$d[$i]!="L")&&z($d,$i,5)!="core."&&z($d,$i,$j-$i)!="array"&&!empty(self::$core->allowed)&&!ia(z($d,$i,$j-$i),self::$core->allowed))return self::e("E","BADFNC",$x);}$r.=($c=="."?"->":(isset($d[$i])?$d[$i]:""));$l=$c;}$r=s($r,["+'"=>".'","+\""=>".\"","'+"=>"'.","\"+"=>"\"."]);if(!empty($f)){foreach($f as$k=>$v){if(!isset($$k)&&isset(self::$o[$k]))$$k=self::$o[$k];elseif(!isset($$k)&&isset(self::$o["app"]->$k))$$k=self::$o["app"]->$k;}}try{$e=e();e($e&~E_NOTICE);ob_start();$R=eval("return ".$r.";");$o=o();e($e);if(self::$core->runlevel>2||!empty($o))self::log(!empty($o)?"E":"D",$x." => ".$r." = ".serialize($R),"php");}catch(\Exception$E){self::log("E",$E->getMessage()." ".$r,"php");}return$R;}static function assign($n,&$o){self::$o[$n]=&$o;}static function _r(){$_SESSION['pe_r']="http".(self::$core->sec?"s":"")."://".$_SERVER["SERVER_NAME"].$_SERVER["REQUEST_URI"];}static function _cf($c){if(!a($c))$c=x(",",$c);if(!empty($c))foreach($c as$F){$F=r($F);$G=C."Filter\\$F";if(!empty($F)&&(($F[0]=='@'&&!self::$user->has(w($F,1)))||($F[0]!='@'&&!@$G::filter()))){return false;}}return true;}static function _tc(){return++self::$tc;}static function _gt($n){$t="";$m=[];$M="meta";$V="views";$e=".tpl";if(!empty(self::$mc)){$C='t_'.sha1(self::$core->base."_".$n);$p=self::$mc->get($C);if(a($p)){if(a($p['m']))$m=$p['m'];if(!empty($p['d']))$t=$p['d'];}}if(!$t){if(!empty(self::$db[0])&&f(P."sql/$V.sql")){$d=self::$s;self::ds(0);try{foreach([self::$core->app."/".$n,$n] as$v){$p=self::fetch("*",$V,"id=?","","",[$v]);if(!empty($p['data'])){foreach(["css","jslib"] as$c){$t=jd($p[$c]);if(a($t))foreach($t as$v)${self::$core->$c}[m($v)]=$v;}$t=$p['data'];if(!empty($p[$M]))$m=jd($p[$M],1);break;}}}catch(\Exception$e){}self::ds($d);}if(!$t)foreach(["app/$V/$n$e",self::$p?self::$p."/$V/$n$e":"",N.self::$core->app."/$V/$n$e",P."$V/$n$e"] as$F)if($F&&$t=g($F)){while(p("/^[\r\n\ \t]*<$M name='([^']+)' content='([^']+)'>/m",$t,$r)){$t=w($t,u($r[0]));$m[$r[1]]=$r[2];}break;}$t=pr("/<!-.*?->[\r\n]*/ms","",pr("/<\?.*?\?\>[\r\n]*/ms","",$t));if(!empty(self::$mc)&&!empty($t))self::$core->_ms($C,["m"=>$m,"d"=>$t]);}self::$core->meta+=a($m)?$m:[$m];return$t;}static function _t($x,$re=0){$L=self::e("W","TOOMNY",L("recursion limit exceeded")."!");if($re>=64)return$L;$J=self::$core->app=="cms"&&self::$core->action=="pages"&&q(C."CMS","icon");if(preg_match_all("/<!([^\[\-][^>]+)>[\r\n]*/ms",$x,$T,PREG_OFFSET_CAPTURE|PREG_SET_ORDER)){$o=[];$I=0;foreach($T as$k=>$v){$T[$k][0][2]=u($v[0][0]);$t=t(z($v[1][0],0,4));if(z($t,0,2)=="if"||$t=="fore"||$t=="temp")$o[$I++]=$k;elseif($t=="else")$T[$o[$I-1]][4]=$k;elseif(z($t,0,3)=="/if"||$t=="/for"||$t=="/tem")$T[$o[--$I]][3]=$k;}if($I)return self::e("W","UNCLS",L("unclosed tag"));unset($o);$C=0;for($k=0;$k<count($T)&&$m=$T[$k];$k++){$H=r($m[1][0]);$w="";$a="";if($H[0]=="=")$t="=";else$t=t(strstr($H,' ',true));if(empty($t))$t=$H;else$a=r(w($H,u($t)));$A=x(" ",$a);$N=$m[0][1];$M=$m[0][2];switch($t){case "app":$w="<!app>";break;case "include":$c=self::_gt($a);if(!$c)$c=self::_gt(self::getval($a));$w=self::_t($c,$re+1);break;case "=":$w=self::getval($a);break;case "template":$w=self::_t(s(self::_t(z($x,$m[0][1]+$m[0][2]+$C,$T[$m[3]][0][1]-$m[0][1]-$m[0][2]),$re),"<%","<!"),$re+1);$k=$m[3];$M=$T[$m[3]][0][1]-$m[0][1]+$T[$m[3]][0][2];break;case "foreach":$d=self::getval($a);self::$n++;self::$c[self::$n]=(object)['IDX'=>1];$t=z($x,$m[0][1]+$m[0][2]+$C,$T[$m[3]][0][1]-$m[0][1]-$m[0][2]);if((a($d)&&count($d)>0)||is_object($d))foreach($d as$k=>$v){self::$c[self::$n]->KEY=$k;self::$c[self::$n]->VALUE=$v;$w.=self::_t($t,$re+1);self::$c[self::$n]->IDX++;}$k=$m[3];$M=$T[$m[3]][0][1]-$m[0][1]+$T[$m[3]][0][2];unset(self::$c[self::$n]);self::$n--;break;case "if":$M=$T[$m[3]][0][1]+$T[$m[3]][0][2]-$m[0][1];$w=self::_t(($a!="cms"&&!empty(self::getval($a)))||($a=="cms"&&$J)?z($x,$N+$C+$m[0][2],!empty($m[4])?$T[$m[4]][0][1]-$m[0][1]-$m[0][2]:$M-$m[0][2]-$T[$m[3]][0][2]):(!empty($m[4])?z($x,$T[$m[4]][0][1]+$C+$T[$m[4]][0][2],$T[$m[3]][0][1]-$T[$m[4]][0][1]-$T[$m[4]][0][2]):""),$re+1);$k=$m[3];break;case "form":self::$tc=0;$c=self::$core->app.".".self::$core->action;$n=!empty($A[0])&&$A[0]!="-"?urlencode($A[0]):"form";$w="<form name='".$n."' action='".url(!empty($A[1])&&$A[1]!="-"?$A[1]:"")."' method='post' enctype='multipart/form-data'".(!empty($A[2])&&$A[2]!="-"?" onsubmit=\"".s($A[2],"\"","\\\"")."\"":"")."><input type='hidden' name='MAX_FILE_SIZE' value='".self::$fm."'><input type='hidden' name='pe_s' value='".@$_SESSION["pe_s"][$c]."'><input type='hidden' name='pe_f' value='".$n."'>".(!empty(self::$core->item)?"<input type='hidden' name='item' value='".h(self::$core->item)."'>":"");break;case "time":case "date":$v=self::getval($A[0]);$w=!empty($v)?date((!empty(self::$l['dateformat'])?self::$l['dateformat']:"Y-m-d").($t=="time"?" H:i:s":""),ts($v)):(!empty($A[1])?"":L("Epoch"));break;case "difftime":$w="";$v=self::getval($A[0]);if(!empty($A[1])){if(!$v){$w="-";break;}$v-=ts(self::getval($A[1]));}if($v<0){$w="- ";$v=-$v;}$c=floor($v/86400);$b=floor(($v-$c*86400)/3600);$a=floor(($v-$c*86400-$b*3600)/60);$w.=$c?"$c ".L("day".($c>1?"s":"")):($b?"$b ".L("hour".($b>1?"s":"")):"").($a||!$b?($b?", ":"")."$a ".L("min".($a>1?"s":"")):"");break;case "l":$w=isset(self::$l[$a])?L($a):"NA_".$a;break;case "dump":$l=self::$core->runlevel;if($l<1)$w="";else{ob_start();$s=null;if($A[0]=="_SESSION"){$s=$_SESSION;unset($s["pe_u"]);unset($s["pe_s"]);unset($s["pe_v"]);}else$s=self::getval($A[0]);if($l>1){var_dump($s);$n=o();if($n[0]!="<")$n="<pre>".$n."</pre>";}else{print_r($s);$n="<pre>".h(o())."</pre>";}$w="<b style='font-family:monospace;'>".$A[0].":</b>".s($n,"<pre","<pre style='margin:0;'");}break;case "cms":case "widget":case "var":case "field":$Z=$R=$m=false;$G=$t=="cms";$V=$t=="var";if($A[0][0]=='@'){$Z=w($A[0],1);array_shift($A);}$Z=!$Z||self::$user->has($Z);if($G&&$J&&$Z)$w=CMS::icon($A);if($A[0][0]=='*'){$R=true;$A[0]=w($A[0],1);}$f=$A[0];if(p("/^([^\(]+)[\(]?([^\)]*)/",$A[0],$B)&&!empty($B[1])){$f=$B[1];if($f=="submit")$f="update";$a=self::getval("[".$B[2]."]");array_shift($A);$n=!empty($A[0])?$A[0]:"";array_shift($A);if(!ia($f,["update","cancel","button"]))$v=self::getval($n);$d=A.$f;if(!ce($d)&&$D=@glob(N."*/addons/".$f.PE)[0])io($D);if(ce($d)&&is_subclass_of($d,C."AddOn")){$F=new$d($a,$n,$v,$A,$R);if(empty(self::$core->addons[$f])&&q($F,"init"))$F->init();if($R||$f=="check"||$f=="file"||q(A.$f,"validate"))$_SESSION["pe_v"][$n][$f]=[$R,$a,$A];$m=!$G&&($t=="field"||!empty($_SESSION[$V?"pe_e":"pe_c"]))&&q($F,"edit")?"edit":"show";$w.=q($F,$m)&&$Z?$F->$m():$v;unset($F);break;}}$w.=$G||($V&&empty($_SESSION['pe_e']))?(is_scalar($v)?$v."":$v&&json_encode($v)):self::e("W","UNKADDON",$f);break;default:$w=self::e("W","UNKTAG",$t);}$D=$N+$C&&$x[$N+$C-1]=="\n"?1:0;$E=isset($x[$N+$M+$C])&&$x[$N+$M+$C]=="\n"?1:0;$x=z($x,0,$N+$C-$D).$w.w($x,$N+$M+$C+$E);$C+=@u($w)-$M-$D-$E;}}return$x;}function _ms($k,$v){self::$mc->set($k,$v,MEMCACHE_COMPRESSED,$this->cachettl);}function _eh($e,$c=[]){foreach($this->libs as$k=>$v)if(q($v,$e)){$d=$v->$e($c);if($d!=null)$c=$d;}return$c;}}}namespace PHPPE\Filter{use\PHPPE\Filter as X;class get extends X{function filter(){return$_SERVER['REQUEST_METHOD']=="GET";}}class post extends X{function filter(){return$_SERVER['REQUEST_METHOD']=="POST";}}class loggedin extends X{function filter(){if(\PHPPE\Core::$user->id)return true;\PHPPE\Core::redirect("login",1);}}class csrf extends X{function filter(){return\PHPPE\Core::isTry();}}}namespace PHPPE\AddOn{use\PHPPE\Core as Core;use\PHPPE\AddOn as X;class hidden extends X{function edit(){return "<input type='hidden' name='".$this->fld."' value='".h(r($this->value))."'>";}}class button extends X{function show(){return$this->edit();}function edit(){$t=$this;$a=$t->attrs;return "<button class='".(!empty($a[1])&&$a[1]!="-"?$a[1]:"button")."' onclick=\"".s(!empty($a[0])&&$a[0]!="-"?$a[0]:"alert('".L("No action")."');","\"","\\\"")."\">".L(!empty($t->name)?$t->name:"Press me")."</button>";}}class update extends X{function edit(){$t=$this;$a=$t->attrs;return "<input class='".(!empty($a[1])&&$a[1]!="-"?$a[1]:"button")."' name='pe_try".Core::_tc()."' type='submit' value=\"".h(L(!empty($t->name)?$t->name:"Okay"))."\"".(!empty($a[0])&&$a[0]!="-"?" onclick=\"return ".s($a[0],"\"","\\\"")."\"":"").">";}}class cancel extends X{function edit(){$t=$this;$a=$t->attrs;return "<input class='".(!empty($a[0])&&$a[0]!="-"?$a[0]:"button")."' name='pe_cancel' type='submit' value=\"".h(L(!empty($t->name)?$t->name:"Cancel"))."\">";}}class text extends X{function edit(){$t=$this;$a=$t->args;$b=$t->attrs;$v=r($t->value);$D=(!empty($a[3])?" dir='ltr'":"");if($v=="null")$v="";if(!empty($a[2])&&$a[2]>0){if($a[1]>0)Core::js("pe_mt(e,m)","var c,o;if(!e)e=window.event;o=e.target;c=e.keyCode?e.keyCode:e.which;return(c==8||c==46||o.value.length<=m);");return "<textarea".@v($t,$b[1],$b[0]).($a[0]>0?" cols='".$a[0]."'":"")." rows='".$a[2]."'".($a[1]>0?" onkeypress='return pe_mt(event,".$a[1].");'":"")."$D wrap='soft' onfocus='this.className=this.className.replace(\" errinput\",\"\")'>".$v."</textarea>";}return "<input".@v($t,$b[1],$b[0],$a)." type='text'".(!empty($b[2])&&$b[2]!="-"?" onkepup='".$b[2]."'":"")." onfocus='this.className=this.className.replace(\" errinput\",\"\")'".(!empty($b[3])?" placeholder=\"".h(L(r($b[3])))."\"":"")."$D value=\"".h($v)."\">";}}class pass extends X{function show(){return "******";}function edit(){$t=$this;return "<input".@v($t,$t->attrs[0],"",$t->args)." type='password' value=\"".h(r($t->value))."\" onfocus='this.className=this.className.replace(\" errinput\",\"\")'>";}static function validate($n,&$v,$a,$t){if(y(C."pass"))return\PHPPE\pass($n,$v,$a,$t);$r=p("/[0-9]/",$v)&&p("/[a-z]/i",$v)&&t($v)!=$v&&k($v)!=$v&&u($v)>=6;return[$r,"not a valid password! [a-zA-Z0-9]*6"];}}class num extends X{function show(){return h($this->value);}function edit(){$a=$this->args;$t="this.value";$b='o.className=o.className.replace(" errinput","")';$C=isset($a[3])?"if($t<".$a[2].")$t=".$a[2].";if($t>".$a[3].")$t=".$a[3].";":"";$r="return";Core::js("pe_on(e)","var c,o;if(!e)e=window.event;o=e.target;c=e.keyCode?e.keyCode:e.which;$b;if(c==8||c==37||c==39||c==46)$r true;c=String.fromCharCode(c);if(c.match(/[0-9\\b\\t\\r\\-\\.\\,]/)!=null)$r true;else{o.className+=' errinput';setTimeout(function(){{$b};},200);$r false;}");return "<input".@v($this,$this->attrs[1],$this->attrs[0],$a)." style='text-align:right;' type='number' onkeypress='$r pe_on(event);' onkeyup='$t=$t.replace(\",\",\".\");' onfocus='".$C."if($t==\"\")$t=0;".s($b,"o.","this.").";this.select();'".(isset($a[3])?" onblur='$C' min='".$a[2]."' max='".$a[3]."'":"")." value=\"".h(r($this->value))."\">";}static function validate($n,&$v,$a,$t){$r=floatval($v)==$v;if(!$r)$m="not a valid number!";if($r&&isset($a[3])){if($v<$a[2]){$r=0;$m="not enough!";$v=$a[2];}if($v>$a[3]){$r=0;$m="too much!";$v=$a[3];}}return[$r,$m];}}class select extends X{function show(){return h(a($this->value)?implode(", ",$this->value):$this->value);}function edit(){$t=$this;$a=$t->attrs;$b=$t->args;$opts=!empty($a[0])&&$a[0]!="-"?Core::getval($a[0]):[];if(is_string($opts))$opts=x(",",$opts);$skip=!empty($a[1])&&$a[1]!="-"?Core::getval($a[1]):[];if(is_string($skip))$skip=x(",",$skip);if(!a($skip))$skip=[];else$skip=array_flip($skip);if(!empty($b[1]))$t->name.="[]";$r="<select".@v($t,$a[3],$a[2]).(!empty($b[1])?" multiple":"").(!empty($b[0])&&$b[0]>0?" size='".intval($b[0])."'":"")." onfocus='this.className=this.className.replace(\" errinput\",\"\")'>";if(a($opts))foreach($opts as$k=>$v){$o=a($v)&&isset($v['id'])?$v['id']:(is_object($v)&&isset($v->id)?$v->id:$k);$n=a($v)&&!empty($v['name'])?$v['name']:(is_object($v)&&!empty($v->name)?$v->name:(is_string($v)?$v:$k));if(!isset($skip[$o])&&!empty($n))$r.="<option value=\"".h($o)."\"".((a($t->value)&&ia($o."",$t->value))||$o==$t->value?" selected":"").">".$n."</option>";}$r.="</select>";return$r;}}class check extends X{function show(){$t=$this;if(empty(Core::$core->output)||Core::$core->output!="html")return "[".(!empty($t->value)?"X":" ")."]".(!empty($t->attrs[0])?L($t->attrs[0]):$t->value);return h($t->value);}function edit(){$t=$this;$a=$t->attrs;$e=Core::isError($t->name);return($e?"<span class='errinput'>":"")."<input".@v($t,$a[2],$a[1])." id='".$t->name."' type='checkbox'".(!empty($t->value)?" checked":"")." value=\"".h(r(!empty($t->args[0])?$t->args[0]:"1"))."\">".(!empty($a[0])?"<label for='".$t->name."'>".L($a[0])."</label>":"").($e?"</span>":"");}}class radio extends X{function show(){$t=$this;return Core::$core->output!="html"?("(".($t->value==$t->args[0]?"X":" ").") ".(!empty($t->attrs[0])?L($t->attrs[0]):$t->value)):h($t->value);}function edit(){$t=$this;$a=$t->args;$b=$t->attrs;return "<input".@v($t,$b[2],$b[1])." id='".$t->name."_".sha1($a[0])."' type='radio'".($t->value==$a[0]?" checked":"")." value=\"".h(r(!empty($a[0])?$a[0]:"1"))."\">".(!empty($b[0])?"<label for='".$t->name."_".sha1($a[0])."'>".L($b[0])."</label>":"");}}class phone extends X{function show(){return h($this->value);}function edit(){$t=$this;$b='o.className=o.className.replace(" errinput","")';Core::js("pe_op(e)","var c,o;if(!e)e=window.event;o=e.target;c=e.keyCode?e.keyCode:e.which;$b;if(c==8||c==37||c==39||c==46)return true;c=String.fromCharCode(c);if(c.match(/[0-9\\b\\t\\r\\-\\ \\+\\(\\)\\/]/)!=null)return true;else{o.className+=' errinput';setTimeout(function(){{$b};},200);return false;}");return "<input".@v($t,$t->attrs[1],$t->attrs[0],$t->args)." type='text' onfocus='".s($b,"o.","this.")."' onkeypress='return pe_op(event);' value=\"".h(r($t->value))."\">";}static function validate($n,&$v,$a,$t){$r=p("/^[0-9\+][0-9\ \(\)\-]+$/",$v);return[$r,"invalid phone number"];}}class email extends X{function show(){if(empty(Core::$core->output)||Core::$core->output!="html")return$this->value;return s(h($this->value),["@"=>"&#64;","."=>"&#46;"]);}function edit(){$t=$this;$a=$t->attrs;$b='o.className=o.className.replace(" errinput","")';Core::js("pe_oe(o)","$b;if(o.value!=''&&o.value.match(/^.+\@(\[?)[a-z0-9\-\.]+\.([a-z]{2,3}|[0-9]{1,3})(\]?)$/i)==null)o.className+=' errinput';");return "<input".@v($t,$a[1],"",$t->args)." type='email' onfocus='".s($b,"o.","this.")."' onchange='pe_oe(this);".(!empty($a[0])&&$a[0]!="-"?$a[0]:"")."' value=\"".h(r($t->value))."\">";}static function validate($n,&$v,$a,$t){$r=p("/^.+\@(\[?)[a-z0-9\-\.]+\.([a-z]{2,3}|[0-9]{1,3})(\]?)$/i",$v);return[$r,"invalid email address"];}}class file extends X{function edit(){$t=$this;$e=Core::isError($t->name);return($e?"<span class='errinput'>":"")."<input".@v($t,$t->attrs[0],$t->attrs[1],$t->args)." type='file'>&nbsp;(".round(Core::$fm/1048576)."Mb)".($e?"</span>":"");}}class date extends X{function show(){return$this->show2(0);}function show2($T=0){$d='dateformat';$t=$this;return!empty($t->value)?date((!empty(Core::$l[$d])?Core::$l[$d]:"Y-m-d").($T?" H:i":""),$t->value):(!empty($t->attrs[0])?"":"Epoch");}function edit(){return$this->edit2(0);}function edit2($T=0){$B='o.className=o.className.replace(" errinput,"")';Core::js("pe_cs(n,e)","if(n!=null){n.className=n.className.replace(' errinput','');if(e!=null)n.className+=' errinput';}");Core::js("pe_cd(o,f)","var d=new Date(Date.UTC(o[f+':y'].value,o[f+':m'].value-1,o[f+':d'].value,o[f+':h']?o[f+':h'].value:0,o[f+':i']?o[f+':i'].value:0,0));pe_cs(o[f+':y']);pe_cs(o[f+':m']);pe_cs(o[f+':d']);pe_cs(o[f+':h']);pe_cs(o[f+':i']);if(!d||d.getUTCDate()!=o[f+':d'].value){pe_cs(o[f+':y'],1);pe_cs(o[f+':m'],1);pe_cs(o[f+':d'],1);}");$t=$this;$a=$t->args;$b=$t->attrs;$n=$t->fld;$t->name="";$s="<select".@v($t,$b[1])." onfocus='pe_cd(this.form,\"".$n."\");' onchange='pe_cd(this.form,\"".$n."\");".(!empty($b[0])&&$b[0]!="-"?$b[0]:"")."' name='".$n;$d=x(",",date("Y,m,d,H,i,s",!empty($t->value)?$t->value:Core::$core->now));$oy=$s.":y'>";for($i=date("Y",Core::$core->now)-(!empty($a[0])?$a[0]:5);$i<=date("Y",Core::$core->now)+(!empty($a[0])?$a[0]:5);$i++)$oy.="<option value='".$i."'".($i==$d[0]?" selected":"").">".$i."</option>";$oy.="</select>";$om=$s.":m'>";for($i=1;$i<=12;$i++){$X="month".($i<10?"0":"").$i;$om.="<option value='".$i."'".($i==intval($d[1])?" selected":"").">".(!empty(Core::$l[$X])?Core::$l[$X]:($i<10?"0":"").$i)."</option>";}$om.="</select>";$od=$s.":d'>";for($i=1;$i<=31;$i++)$od.="<option value='".$i."'".($i==intval($d[2])?" selected":"").">".($i<10?"0":"").$i."</option>";$od.="</select>";$f=(!empty(Core::$l["dateformat"])?Core::$l["dateformat"]:"Y-m-d")."@";if($T){$f.=" H:i".(!empty($a[3])?":s":"");$oh=$s.":h'>";for($i=0;$i<=23;$i++)$oh.="<option value='".$i."'".($i==intval($d[3])?" selected":"").">".(($i<10?"0":"").$i)."</option>";$oh.="</select>";$oi=$s.":i'>";for($i=0;$i<=59;$i+=(!empty($a[2])&&$a[2]>0&&$a[2]<=30?$a[2]:1))$oi.="<option value='".$i."'".($i==intval($d[4])?" selected":"").">".(($i<10?"0":"").$i)."</option>";$oi.="</select>";if(!empty($a[3])){$os=$s.":s'>";for($i=0;$i<=59;$i++)$os.="<option value='".$i."'".($i==intval($d[5])?" selected":"").">".(($i<10?"0":"").$i)."</option>";$os.="</select>";}else$os="";}else$oh=$oi=$os="";if(Core::isInst("Core")){@list($o,$d)=x("_",$n);$c="&nbsp;<img src='images/cal.png' class='cal_icon' style='vertical-align:middle;' onclick='if(document.forms[\"".$o."\"])cal_open(this,document.forms[\"".$o."\"],\"".$n."\");' alt='[☰]'>";}else$c="";return s($f,["Y"=>$oy,"m"=>$om,"d"=>$od,"H"=>$oh,"i"=>$oi,"s"=>$os,"@"=>$c]);}static function validate($n,&$v,$a,$t){return[mktime(!empty($_REQUEST[$v.":h"])?$_REQUEST[$v.":h"]:0,!empty($_REQUEST[$v.":i"])?$_REQUEST[$v.":i"]:0,!empty($_REQUEST[$v.":s"])?$_REQUEST[$v.":s"]:0,!empty($_REQUEST[$v.":m"])?$_REQUEST[$v.":m"]:0,!empty($_REQUEST[$v.":d"])?$_REQUEST[$v.":d"]:0,!empty($_REQUEST[$v.":y"])?$_REQUEST[$v.":y"]:0),"bad date"];}}class time extends date{function show(){return parent::show2(1);}function edit(){return parent::edit2(1);}static function validate($n,&$v,$a,$t){return parent::validate($n,$v,$a,$t);}}}namespace{function LANG_INIT($c=""){return\PHPPE\Core::langInit($c);}function L($s){return isset(\PHPPE\Core::$l[$s])?\PHPPE\Core::$l[$s]:strtr($s,["_"=>" "]);}function url($m=NULL,$p=NULL){return\PHPPE\Core::url($m,$p);}function a($a){return is_array($a);}function h(&$s){return htmlspecialchars($s);}function s($s,$f,$t=""){return a($f)?strtr($s,$f):strtr($s,[$f=>$t]);}function e($e=0){return error_reporting($e);}function f($f){return file_exists($f);}function g($f){return f($f)?file_get_contents($f):"";}function io($f){return f($f)?include_once($f):null;}function t($s){return strtolower($s);}function k($s){return strtoupper($s);}function c($m){@header("Pragma:cache");@header("Cache-Control:cache,public,max-age=".\PHPPE\Core::$core->cachettl);@header("Content-Type:$m;charset=utf-8");@header("Connection:close");}function d($n){return debug_backtrace()[$n]['file'];}function r($s){return trim($s);}function n($s){return dirname($s);}function m($a){return basename($a);}function p($p,&$s,&$r=null,$f=0){return preg_match($p,$s,$r,$f);}function pr($a,$b,$c){return preg_replace($a,$b,$c);}function x($a,$b){$r=[];$q='';for($l=$i=0;$i<=u($b);$i++){$c=@$b[$i];if($q){if($c==$q)$q="";if($c=='\\')$i++;}elseif($c=='"'||$c=="'")$q=$c;elseif($c==$a||$c==''){while(@$b[$l]==$a)$l++;$r[]=z($b,$l,$i-$l);$l=$i+1;}}return$r;}function q($a,$b){return method_exists($a,$b);}function y($a){return function_exists($a);}function w(&$a,$b){return substr($a,$b);}function z(&$a,$b,$c){return substr($a,$b,$c);}function v($a,$b,$e="",$f=[]){return(@$a->css[0]=="r"?" required":"")." class='".$a->css.(!empty($b)&&$b!="-"?" ".$b:"")."'".($a->name?" name='".$a->fld."'":"").($e&&$e!="-"?" onchange='".$e."'":"").(!empty($f[0])&&$f[0]>0?" size='".$f[0]."'":"").(!empty($f[1])&&$f[1]>0?" maxlength='".$f[1]."'":"");}function u($a){return strlen($a);}function j($a,$b,$c=""){return sha1($a."|".$b."|".$c);}function o(){return ob_get_clean();}function jd(&$a){return @json_decode($a,1);}function ad($a){return addslashes($a);}function ia($a,$b){return @in_array($a,$b);}function ce($c){return class_exists($c);}function cc($c){return ce($c)&&is_subclass_of($c,C."App");}function gc(){return get_declared_classes();}function ts($v){return p("|^[0-9]+$|",$v)?$v:strtotime($v);}if(empty(\PHPPE\Core::$core))new\PHPPE\Core(!empty(debug_backtrace()));return\PHPPE\Core::$core;}     
?>
