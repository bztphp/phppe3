<?php
/*
 *  PHP Portal Engine v3.0.0
 *  https://github.com/bztsrc/phppe3/
 *
 *  Copyright LGPL 2016 bzt
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU Lesser General Public License as published
 *  by the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Lesser General Public License for more details.
 *
 *   <http://www.gnu.org/licenses/>
 *
 *  PHPPE Core - Use as is
 */
namespace PHPPE{define('VERSION','3.0.0');class Extension{function __toString(){return get_class($this);}}class AddOn{public$name;public$args;public$fld;public$value;public$attrs;public$css;final public function __construct($a,$n,&$v,$t=[],$r=0){$this->args=$a;$this->name=$n;$this->fld=strtr($n,['.'=>'_']);$this->value=$v;$this->attrs=$t;$this->css=((!empty($r)?'req':'').'input').(Core::isError($n)?' errinput':'');}public function show(){return htmlspecialchars($this->value);}function __toString(){return get_class($this)."(".$this->name.")";}}class Filter{function __toString(){return __CLASS__;}}class Client extends Extension{public$ip;public$agent;public$user;public$tz;public$lang;public$screen=[];public$geo=[];public function __construct(){Core::$client=$this;session_name(!empty(Core::$core->sessionvar)?Core::$core->sessionvar:'pe_sid');@session_start();if(ini_get('session.use_cookies')){@setcookie(session_name(),session_id(),Core::$core->now+Core::$core->timeout,'/',Core::$core->base,!empty(Core::$core->secsession)?1:0,1);}if(isset($_REQUEST['clear'])){$d='pe_u';$u=@$_SESSION[$d];$_SESSION=[];$_SESSION[$d]=$u;Http::redirect();}}public function init($cfg=[]){Core::$l=[];View::assign('client',$this);$L='pe_l';$a='';$d=[];if(empty($_SESSION[$L])){$i='HTTP_ACCEPT_LANGUAGE';$d=explode(',',strtr(!empty($_SERVER[$i])?$_SERVER[$i]:(getenv('LANG')||'en'),['/'=>'']));}if(!empty($_REQUEST['lang'])){$d=[strtr(trim($_REQUEST['lang']),['/'=>''])];}foreach($d as$v){list($a)=explode(';',strtolower(str_replace('-','_',$v)));if(!empty($a)&&(file_exists("vendor/phppe/Core/lang/$a.php")||file_exists("app/lang/$a.php")||$a=='en')){$_SESSION[$L]=$a;break;}}if(empty($_SESSION[$L])){$_SESSION[$L]='en';}$this->lang=$v=$_SESSION[$L];$i=explode('_',$v);setlocale(LC_ALL,strtolower($i[0]).'_'.strtoupper(!empty($i[1])?$i[1]:$i[0]).'.UTF8');Core::lang('Core');$L='pe_tz';if(Core::$w){if(Core::$core->app=='index'&&empty($_SESSION[$L])&&!isset($_REQUEST['nojs'])&&empty($_REQUEST['cache'])){$c=L('Enable JavaScript');if(empty($_REQUEST['n'])){$_SESSION['pe_n']=sha1(rand());Http::_r();$g='getTimezoneOffset()';$d="var d%=new Date();d%.setDate(1);d%.setMonth(@);d%=parseInt(d%.$g);";die("<html><script type='text/javascript'>var now=new Date();".strtr($d,['%'=>'1','@'=>'1']).strtr($d,['%'=>'2','@'=>'7'])."txt=now.toString().replace(/[^\(]+\(([^\)]+)\)/,\"$1\");document.location.href=\"".$_SESSION['pe_r'].(strpos($_SERVER['REQUEST_URI'],'?')===false?'?':'&').'n='.$_SESSION['pe_n']."&t=\"+(-now.$g*60)+\"&d=\"+(d1==d2||(d1<d2&&d1==parseInt(now.$g))||(d1>d2&&d2==parseInt(now.$g))?\"1\":\"0\")+\"&w=\"+screen.availWidth+\"&h=\"+screen.availHeight;</script>$c</html>");}elseif($_REQUEST['n']==$_SESSION['pe_n']){unset($_SESSION['pe_n']);$_SESSION[$L]=timezone_name_from_abbr('',$_REQUEST['t']+0,$_REQUEST['d']+0);$_SESSION['pe_w']=floor($_REQUEST['w']);$_SESSION['pe_h']=floor($_REQUEST['h']);Http::redirect();}else{die($c);}}$d='HTTP_X_FORWARDED_FOR';$this->ip=$i=!empty($_SERVER[$d])?$_SERVER[$d]:$_SERVER['REMOTE_ADDR'];$this->screen=!empty($_SESSION['pe_w'])?[$_SESSION['pe_w'],$_SESSION['pe_h']]:[0,0];$d='HTTP_USER_AGENT';$this->agent=!empty($_SERVER[$d])?$_SERVER[$d]:'browser';$d='PHP_AUTH_USER';$this->user=!empty($_SERVER[$d])?$_SERVER[$d]:'';}else{$T=getenv('TZ');$d=explode('/',$T?$T:@readlink('/etc/localtime'));$c=count($d);$_SESSION[$L]=$c>1?$d[$c-2].'/'.$d[$c-1]:'UTC';$this->ip='CLI';$c=exec('tput cols 2>/dev/null')+0;$d=exec('tput lines 2>/dev/null')+0;$this->screen=[$c<1?80:$c,$d<1?25:$d];$d=getenv('TERM');$this->agent=!empty($d)?$d:'term';$d=getenv('USER');$this->user=!empty($d)?$d:'';Core::$core->noframe=1;}date_default_timezone_set($this->tz=!empty($_SESSION[$L])?$_SESSION[$L]:'UTC');}}class Model{public$id;public$name;protected static$_table;function __construct($id=""){if(!empty($id)){$this->id=$id;$this->load($id);}}final public function find($s=[],$w='',$o=''){if(empty(static::$_table)){throw new \Exception('no _table');}return DS::query('*',static::$_table,$w?$w:($s?'id=?':''),'',$o,0,0,is_array($s)?$s:[$s]);}final public function load($i=0,$w='',$o=''){if(empty(static::$_table)){throw new \Exception('no _table');}$r=DS::fetch('*',static::$_table,$w?$w:'id=?','',$o,is_array($i)?$i:[$i?$i:$this->id]);if($r){foreach($this as$k=>$v){if($k[0]!='_'){$this->$k=is_string($r[$k])&&($r[$k][0]=='{'||$r[$k][0]=='[')?json_decode($r[$k],true):$r[$k];}}return true;}return false;}final public function save($f=0){if(empty(static::$_table)){throw new \Exception('no _table');}$d=DS::db();if(empty($d)){throw new \Exception('no ds');}$a=[];foreach($this as$k=>$v){if($k[0]!='_'&&($f||$k!='id')&&$k!='created'){$a[$k]=is_scalar($v)?$v:json_encode($v);}}if(!DS::exec(($this->id&&!$f?'UPDATE '.static::$_table.' SET '.implode('=?,',array_keys($a)).'=? WHERE id='.$d->quote($this->id):'INSERT INTO '.static::$_table.' ('.implode(',',array_keys($a)).') VALUES (?'.str_repeat(',?',count($a)-1).')'),array_values($a))){return false;}if(!$this->id){$this->id=$d->lastInsertId();}return$this->id;}}class User extends Model{public$id=0;public$name='Anonymous';public$data=[];private$acl=[];final public function has($l){foreach(is_array($l)?$l:explode('|',$l)as$a){$a=trim($a);if(!empty($this->id)&&($this->id==-1||$a=='loggedin'||!empty($this->acl[$a])||!empty($this->acl["$a:".Core::$core->item]))){return true;}}return false;}public function grant($l){foreach(is_array($l)?$l:explode('|',$l)as$a){$a=trim($a);if(!empty($this->id)&&!empty($a)){$this->acl[$a]=true;}}}public function clear($l=''){if(empty($l)){$this->acl=[];}else{foreach(is_array($l)?$l:explode('|',$l)as$a){$a=trim($a);unset($this->acl[$a]);foreach($this->acl as$k=>$v){if(substr($k,0,strlen($a)+1)==$a.':'){unset($this->acl[$k]);}}}}}public function init($cfg){$L='pe_u';if(!empty($_SESSION[$L])&&is_object($_SESSION[$L])){Core::$user=$_SESSION[$L];foreach(['id','name','data']as$k){$this->$k=Core::$user->$k;}}else{Core::$user=$_SESSION[$L]=$this;}View::assign('user',Core::$user);}public function route($app,$action){if(!empty(Core::$user->id)){foreach(['edit','conf']as$v){if(isset($_REQUEST[$v])&&Core::$user->has($v)){$_SESSION['pe_'.substr($v,0,1)]=!empty($_REQUEST[$v]);Http::redirect();}}}if($app=='login'){$A='admin';if(Core::isTry()&&!empty($_REQUEST['id'])&&$_REQUEST['id']==$A){if(!empty(Core::$core->masterpasswd)&&empty(Core::$user->id)&&password_verify($_POST['pass'],Core::$core->masterpasswd)){Core::log('A','Login '.L($A),'users');$_SESSION['pe_u']->id=-1;$_SESSION['pe_u']->name=L($A);Http::redirect();}else{Core::error(L('Bad username or password'));}}if(Core::$user->id){Http::redirect('/');}}elseif($app=='logout'){$i=Core::$user->id;if($i){Core::log('A','Logout '.Core::$user->name,'users');if($i!=-1&&method_exists(Core::$user,'logout')){Core::$user->logout();}}session_destroy();Http::redirect('/');}}}class Http extends Extension{public static$r;public static function url($m='',$p=''){$c=Core::$core->base;$A=Core::$core->app;$f=basename(__FILE__);if(empty($m)&&!empty($A)){$m=$A;}if(empty($p)&&!empty($A)&&$A==$m){$p=Core::$core->action;}$a=($m!='/'?($m.$p!='indexaction'?$m.'/':'').(!empty($p)&&$p!='action'?$p.'/':''):'');return'http'.(Core::$core->sec?'s':'').'://'.$c.($c[strlen($c)-1]!='/'?'/':'').($f!='index.php'?$f.($a?'/':''):'').$a;}public static function redirect($u='',$s=0){if($s){self::_r();}if(empty($u)&&!empty($_SESSION['pe_r'])){$u=$_SESSION['pe_r'];unset($_SESSION['pe_r']);}session_write_close();header('HTTP/1.1 302 Found');$f=basename(__FILE__);header('Location:'.(!empty($u)?(strpos($u,'://')?$u:'http'.(Core::$core->sec?'s':'').'://'.Core::$core->base.($f!='index.php'?$f.'/':'').($u!='/'?$u:'')):self::url().Core::$core->item));exit();}public static function _r(){@$_SESSION['pe_r']='http'.(Core::$core->sec?'s':'').'://'.$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'];}public static function mime($m,$c=true){if($c&&empty(Core::$core->nocache)){header('Pragma:cache');header('Cache-Control:cache,public,max-age='.Core::$core->cachettl);header('Connection:close');}else{header('Pragma:no-cache');header('Cache-Control:no-cache,no-store,private,must-revalidate,max-age=0');}header("Content-Type:$m;charset=utf-8");}public static function route($u='',$n='',$a='',$f=[]){if(empty($u)){return self::$r;}$A='action';$F='filters';$U='url';$N='name';if(is_string($u)&&!empty($n)){if(!is_array($f)){$f=Core::x(',',$f);}self::$r[Core::h($u,$n,$a)]=[$u,$n,$a,$f];}elseif(is_array($u)&&!empty($u[$U])&&!empty($u[$N])){$f=!empty($u[$F])?$u[$F]:[];$a=!empty($u[$A])?$u[$A]:'';self::$r[Core::h($u[$U],$u[$N],$a)]=[$u[$U],$u[$N],$a,is_array($f)?$f:explode(',',$f)];}elseif(is_array($u)&&!empty(current($u)[0])){foreach($u as$v){self::$r[Core::h($v[0],$v[1],(!empty($v[2])?$v[2]:''))]=$v;}}elseif(is_object($u)&&!empty($u->$U)&&!empty($u->$N)){$f=!empty($u->$F)?$u->$F:[];$a=!empty($u->$A)?$u->$A:'';self::$r[Core::h($u->$U,$u->$N,$a)]=[$u->$U,$u->$N,$a,is_array($f)?$f:explode(',',$f)];}else{throw new \Exception('bad route: '.serialize($u));}if(count(self::$r)>=512){Core::log('C','too many routes');}}public static function urlMatch($app='',$ac='',$url=''){$X=[];if(empty($app)){$w=0;if(!empty(self::$r)){uasort(self::$r,function($a,$b){return strcmp($b[0],$a[0]);});foreach(self::$r as$v){if(preg_match('!^'.strtr($v[0],['!'=>'']).'!i',$url,$X)){if(!empty($v[3])&&!Core::cf($v[3])){$w=1;continue;}$w=0;array_shift($X);$app=$v[1];$ac=$v[2];break;}}}if($w){$app=Core::$core->template='403';}}if(empty($app))$app=Core::$core->app;if(empty($ac))$ac=Core::$core->action;return[$app,$ac,$X];}public static function get($u,$p='',$T=3,$l=0){static$C;if($l>7){return;}if(preg_match("/^([^\:]+)\:\/\/([^\/\:]+)\:?([0-9]*)(.*)$/",$u,$m)){$s=0;if($m[1]!='http'&&$m[1]!='https')return;if($m[1]=='https'){$s=1;$m[2]='ssl://'.$m[2];}if($m[3]=='')$m[3]=($m[1]=='http'?80:443);if($m[4]=='')$m[4]='/';$f=fsockopen($m[2],$m[3],$n,$e,$T);if(!$f){Core::log('E',"$u #$n $e",'http');return$s&&strpos($e,'"ssl"')?file_get_contents($u,false,is_array($p)?stream_context_create(['http'=>['method'=>'POST','header'=>'Content-type: application/x-www-form-urlencoded','content'=>http_build_query($p),],]):null):'';}$P=is_array($p)?http_build_query($p,'_'):'';$o=($P?'POST':'GET').' '.$m[4]." HTTP/1.0\r\nHost: ".$m[2]."\r\nAccept-Language: ".Core::$client->lang.";q=0.8\r\n".($C?'Cookie: '.http_build_query($C,'',';')."\r\n":'').($P?"Content-Type: application/x-www-form-urlencoded\r\nContent-Length: ".strlen($P)."\r\n":'')."Connection: close;\r\n\r\n".$P;fwrite($f,$o);$d=$H=$n='';$h='-';$t=0;stream_set_timeout($f,$T);while(!feof($f)&&trim($h)!=''){$h=trim((fgets($f,4096)));if(!empty($h)){$H=strtolower($h);if(substr($H,0,8)=='location'){$n=trim(substr($h,9));}if(substr($H,0,12)=='content-type'&&strpos($h,'text/')){$t=1;}if(substr($H,0,10)=='set-cookie'){$c=Core::x('=',Core::x(';',trim(substr($h,11)))[0]);@$C[$c[0]]=$c[1];}}}if($n&&$n!=$u){return self::get($n,$p,$T,$l+1);}if($H){while(!feof($f)){$d.=fread($f,65535);}Core::log('D',"$u ".strlen($d),'http');}else{Core::log('E',"$u timed out $T",'http');}fclose($f);return$t?strtr($d,["\r"=>'']):$d;}}}class DS extends Extension{public$name='';private static$db=[];private static$s=0;private static$b=0;public function __construct($ds=null){if(!empty($ds)){@self::db($ds);if(!empty(self::$db[0])){$this->name=self::$db[0]->name;}try{$t=@strtotime(@self::field('CURRENT_TIMESTAMP'));if($t>0){Core::$core->now=$t;}}catch(\Exception$e){}}}public static function close(){if(!empty(self::$db)){foreach(self::$db as$d){if(method_exists($d,'close')){$d->close();}}}self::$db=[];self::$s=0;}public function diag(){$d=@self::$db[0];if(empty($d)){return;}$D=[];foreach($d?['','.'.$d->name]:['']as$s){$D+=array_fill_keys(@glob('vendor/phppe/*/sql/upd_*'.$s.'.sql'),0);}if(count($D)){echo"DIAG-I: db update\n";}foreach($D as$f=>$v){$s=Core::x(';',file_get_contents($f));@unlink($f);foreach($s as$q){self::exec($q);}}}public static function db($u=null,$O=null){if(empty($u)){return!empty(self::$db[self::$s])?self::$db[self::$s]:null;}$S=microtime(1);try{if(!preg_match('/^(.*)@([^@:]+)?:?([^:]*)$/',$u,$d)){$d[1]=$u;}self::$s=count(self::$db);self::$db[]=is_object($O)?$O:new \PDO($d[1],!empty($d[2])?$d[2]:'',!empty($d[3])?$d[3]:'',[\PDO::ATTR_ERRMODE=>\PDO::ERRMODE_EXCEPTION,\PDO::ATTR_EMULATE_PREPARES=>0]);if(!isset(self::$db[self::$s]))throw new \PDOException();$d=&self::$db[self::$s];$d->id=count(self::$db);$d->name=is_object($O)?get_class($O):$d->getAttribute(\PDO::ATTR_DRIVER_NAME);$d->s=@include@glob('vendor/phppe/*/libs/ds_'.$d->name.'.php')[0];if(!empty($d->s['_init'])){$c=Core::x(';',$d->s['_init']);foreach($c as$n=>$C){if(!empty(trim($C))){$d->exec(trim($C));}}}}catch(\Exception$e){Core::log(self::$s?'E':'C',L('Unable to initialize').": $u, ".$e->getMessage(),'db');throw$e;}self::$b+=microtime(1)-$S;return self::$s;}public static function ds($s=-1){if($s>=0&&$s<count(self::$db)&&!empty(self::$db[$s])){self::$s=$s;}return self::$s;}public static function like($s){return preg_replace('/[%_]+/','%','%'.preg_replace("/[^a-z0-9\%]/i",'_',preg_replace("/[\ \t]+/",'%',strtr(trim($s),['%'=>'']))).'%');}public static function exec($q,$a=[]){Core::log('D',$q.' '.json_encode($a),'db');if(!is_array($a)){$a=[$a];}if(empty(self::$db[self::$s])){throw new \Exception(L('Invalid ds').' #'.self::$s);}$q=trim($q);if(empty($q)||$q[0]=='-'||$q[0]=='/'){return 1;}$t=microtime(1);$r=null;$h=self::$db[self::$s];try{if(is_array($h->s)){foreach($h->s as$k=>$v){if($k[0]!='_'){$q=preg_replace('/'.$k.'/ims',$v,$q);}}}$i=trim(strtolower(substr($q,0,6)))=='select';$s=$h->prepare($q);$s->execute($a);$r=$i?$s->fetchAll(\PDO::FETCH_ASSOC):$s->rowCount();}catch(\Exception$e){$E=$e->getMessage();$c=strtr($E,'le or v','');if(((!empty($h->s['_tablename'])&&preg_match($h->s['_tablename'],$E,$d))||preg_match("/able:?\ [\'\"]?([a-z0-9_\.]+)/mi",$c,$d)||preg_match("/([a-z0-9_\.]+)[\'\"] does\ ?n/mi",$E,$d)||preg_match("/name:?\ [\'\"]?([a-z0-9_\.]+)/mi",$E,$d))&&!empty($d[1])){$c='';$m='.'.trim($h->name);$d=explode('.',$d[1]);$d=trim(!empty($d[1])?$d[1]:$d[0]);list($D)=explode('_',$d);$f=@glob('vendor/phppe/*/sql/'.$d.$m.'.sql')[0];if(empty($f)){$f=@glob('vendor/phppe/*/sql/'.$d.'.sql')[0];}if(!empty($f)&&file_exists($f)){$c=file_get_contents($f);}if(empty($c)){Core::log('E',$E,'db');throw$e;}if(is_array($h->s)){foreach($h->s as$k=>$v){if($k[0]!='_'){$c=preg_replace('/'.$k.'/ims',$v,$c);}}}$c=Core::x(';',$c);foreach($c as$n=>$C){try{if(!empty(trim($C))){$h->exec(trim($C));}}catch(\Exception$e){Core::log('E',"creating $d at line:".($n+1).' '.$e->getMessage(),'db');throw$e;}}Core::log('A',"$d created.",'db');$s=$h->prepare($q);$s->execute($a);$r=$i?$s->fetchAll(\PDO::FETCH_ASSOC):$s->rowCount();}else{Core::log('E',$q.' '.json_encode($a).' '.$E,'db');$r=null;throw$e;}}self::$b+=microtime(1)-$t;return$r;}public static function query($f,$t,$w='',$g='',$o='',$s=0,$l=0,$a=[]){$q='SELECT '.$f.($t?' FROM '.$t:'').($w?' WHERE '.$w:'').($g?' GROUP BY '.$g:'').($o?' ORDER BY '.$o:'').($l?(' LIMIT '.($s?$s.',':'').$l):'').';';return self::exec($q,$a);}public static function fetch($f,$t='',$w='',$g='',$o='',$a=[]){$r=self::query($f,$t,$w,$g,$o,0,1,$a);return empty($r[0])?[]:$r[0];}public static function field($f,$t='',$w='',$g='',$o='',$a=[]){return@reset(self::fetch($f,$t,$w,$g,$o,$a));}public static function tree($q,$p=0){$r=self::exec($q,[$p]);if(empty($r)){return[];}foreach($r as$k=>$v){$i=isset($v['id'])?$v['id']:-1;if(!empty($i)&&$i!=$p){$c=self::tree($q,$i);if(!empty($c)){$r[$k]['_']=$c;}}}return$r;}public static function bill(){return self::$b;}}class Cache extends Extension{public$name;public static$mc;public function __construct($cfg=null){if(!empty($cfg)){$m=explode(':',$cfg);foreach([$m[0],ucfirst($m[0]),strtoupper($m[0])]as$M){$d='\\PHPPE\\Cache\\'.$M;if(ClassMap::has($d)){self::$mc=new$d($cfg);break;}}if(empty(self::$mc)){if($m[0]=='unix'){$p=0;$h=$m[1];}else{$p=!empty($m[1])?$m[1]+0:11211;$h=$m[0];}$M='\\Memcache';self::$mc=new$M();if(!@self::$mc->pconnect($h,$p,1)){usleep(100);if(!@self::$mc->pconnect($h,$p,1)){self::$mc=null;}}}if(is_object(self::$mc)){$this->name=$M;}else{self::$mc=null;}}if(!empty($_GET['cache'])){$d=trim($_GET['cache']);switch($d){case'logo':Http::mime('image/png');$c='vendor/phppe/Core/images/.phppe';die(file_exists($c)?file_get_contents($c):base64_decode('R0lGODlhKgAYAMIHAAACAAcAABYAAygBDD4BEFwAGGoBGwWYISH5BAEKAAcALAAAAAAqABgAAAOxeLrcCsDJSSkIoertYOSgBmXh5p3MiT4qJGIw9h3BFZP0LVceU0c91sy1uMwkwQfmYEzhiCwc8sh0QQ+FrMFQIAgY2cIWuUx9LoutWsxNs9udaxDKDb+7Wzth+huRRmlcJANrW148NjJDdF2Db2t7EzUUkwpqAx8EaoWRUyCXgVx5L1QUeQQDBGwFhIYDAxNNHJubBQqPBiWmeWqdWG+6EmrBxJZwxbqjyMnHy87P0BMJADs='));case'css':Http::mime('text/css');$p='position:fixed;top:';$s='text-shadow:2px 2px 2px #FFF;';$c='rgba(136,146,191';die('#pe_p{'.$p."0;z-index:999;left:0;width:100%;padding:0 2px 0 32px;background-color:$c,0.9);background:linear-gradient($c,0.4),$c,0.6),$c,0.8),$c,0.9),$c,1) 90%,rgba(0,0,0,1));height:31px !important;font-family:helvetica;font-size:14px !important;line-height:20px !important;}#pe_p SPAN{margin:0 5px 0 0;cursor:pointer;}#pe_p UL{list-style-type:none;margin:3px;padding:0;}#pe_p IMG{border:0;vertical-align:middle;padding-right:4px;}#pe_p A{text-decoration:none;color:#000;".$s.'}#pe_p .menu {position:fixed;top:8px;left:90px;}#pe_p .stat SPAN{display:inline-block;'.$s.'}#pe_p LI{cursor:pointer;}#pe_p LI:hover{background:#F0F0F0;}#pe_p .stat{'.$p.'6px;right:48px;}#pe_p .sub{'.$p.'28px;display:inline;background:#FFF;border:solid 1px #808080;box-shadow:2px 2px 6px #000;z-index:1000;}#pe_p .menu_i{padding:5px 6px 5px 6px;'.$s.'}#pe_p .menu_a{padding:4px 5px 5px 5px;border-top:solid #000 1px;border-left:solid #000 1px;border-right:solid #000 1px;background:#FFF;}@media print{#pe_p{display:none;}}');default:$c=self::get("c_$d");if(is_array($c)&&!empty($c['d'])){Http::mime((!empty($c['m'])?$c['m']:'text/plain'));die($c['d']);}die('CACHE-E: '.$d);}}}public static function set($k,$v,$ttl=0){if(!empty(self::$mc)&&empty(Core::$core->nocache)){return@self::$mc->set($k,$v,MEMCACHE_COMPRESSED,$ttl>0?$ttl:Core::$core->cachettl);}return false;}public static function get($k){if(!empty(self::$mc)&&empty(Core::$core->nocache)){return self::$mc->get($k);}return;}public function init($cfg){return!empty(self::$mc);}}class Assets extends Extension{public function route($app,$action){if(in_array($app,['css','js','images','fonts'])){function b($a,$b){Http::mime($a=='css'?'text/css':($a=='js'?'text/javascript':($a=='images'?'image/png':'application/octet-stream')));die($b);}$N='a_'.sha1(url().Core::$user->id.'/'.Core::$client->lang);$d=Cache::get($N);if(!empty($d)){b($app,$d);}else{foreach([Core::$core->url,preg_replace("/^js\/core\.[^\.]+\.js/",'js/core.js',Core::$core->url).'.php',]as$p){$A='vendor/phppe/*/'.strtr($p,['*'=>'','..'=>'']);$c=@glob($A,GLOB_NOSORT)[0];if(empty($c)){$A='public/'.strtr($p,['*'=>'','..'=>'']);$c=@glob($A,GLOB_NOSORT)[0];}if($c){if(substr($c,-4)!='.php'){$d=file_get_contents($c);Core::$core->cachettl*=10;}else{ob_start();include_once$c;$d=ob_get_clean();}}if($d){$d=self::minify($d,$app);Cache::set($N,$d);b($app,$d);}}}header('HTTP/1.1 404 Not Found');die;}}public static function minify(&$d,$t='js'){if(!empty(Core::$core->nominify)||($t!='css'&&$t!='js'&&$t!='php')){return$d;}$d=trim($d);if($t=='css'&&class_exists('CSSMin'))return \CSSMin::minify($d);if($t=='js'&&class_exists('JSMin'))return \JSMin::minify($d);$n='';$i=0;$l=strlen($d);while($i<$l){$c=@substr($n,-1);if(($d[$i]=="'"||$d[$i]=='"')&&$c!='\\'){$s=$d[$i];$j=$i;++$i;while($i<$l&&$d[$i]!=$s){if($d[$i]=='\\')$i++;++$i;}++$i;$n.=substr($d,$j,$i-$j);continue;}if($t!='css'&&($d[$i]=='/'&&$d[$i+1]=='/')){$s=$i;$i+=2;while($i<$l&&$d[$i]!="\n"){$i++;}continue;}if($d[$i]=='/'&&$d[$i+1]=='*'){$s=$i;$i+=2;while($i+1<$l&&($d[$i]!='*'||$d[$i+1]!='/')){$i++;}$i+=2;continue;}if($d[$i]=="\t"||$d[$i]=="\r"||$d[$i]=="\n"){if((($c>='a'&&$c<='z')||($c>='A'&&$c<='Z')||($c>='0'&&$c<='9'))&&($d[$i+1]=='\\'||$d[$i+1]=='/'||$d[$i+1]=='_'||($d[$i+1]>='a'&&$d[$i+1]<='z')||($d[$i+1]>='A'&&$d[$i+1]<='Z')||($d[$i+1]>='0'&&$d[$i+1]<='9')||$d[$i+1]=='#')){$n.=' ';}++$i;continue;}if($d[$i]==' '&&(!(($c>='a'&&$c<='z')||($c>='A'&&$c<='Z')||($c>='0'&&$c<='9'))||!($d[$i+1]=='\\'||$d[$i+1]=='/'||$d[$i+1]=='_'||($d[$i+1]>='a'&&$d[$i+1]<='z')||($d[$i+1]>='A'&&$d[$i+1]<='Z')||($d[$i+1]>='0'&&$d[$i+1]<='9')||$d[$i+1]=='#'||($t=='js'&&$d[$i+1]=='$')))){++$i;continue;}$n.=$d[$i++];}return$n;}}class Content extends Extension{public function __construct(){$C='d_'.sha1(url().'/'.Core::$user->id.'/'.Core::$client->lang);$data=Cache::get($C);try{if(empty($data['id'])){DS::ds(0);$data=DS::fetch('*','pages',"(id=? OR ? LIKE id||'/%') AND "."(lang='' OR lang=?) AND ".'pubd<=CURRENT_TIMESTAMP AND (expd=0 OR expd>CURRENT_TIMESTAMP)','','id DESC,created DESC',[Core::$core->url,Core::$core->url,Core::$client->lang]);if(!empty($data['id'])){Cache::set($C,$data);}else{return;}}if(!empty($data['filter'])&&!Core::cf($data['filter'])){Core::$core->template='403';return;}Core::$core->template=$data['template'];Core::$core->title=$data['name'];$o=json_decode($data['data'],true);if(is_array($o)){foreach($o as$k=>$v){$this->$k=$v;}}foreach(['id','name','lang','modifyd','ctrl']as$k){$this->$k=$data[$k];}$E=json_decode($data['dds'],true);if(is_array($E)){Core::$dds+=$E;}}catch(\Exception$e){}}public function action($item=''){if(!empty(Core::$core->noctrl)||empty($this->ctrl)){return;}ob_start();eval("namespace PHPPE\Ctrl;\nuse PHPPE\Core as PHPPE;\n".$this->ctrl);return ob_get_clean();}public static function getDDS(&$app){try{$F=DS::fetch('data,dds','pages',"id='frame'",'','id DESC,created DESC');$E=json_decode($F['data'],true);View::assign('frame',$E);$E=json_decode($F['dds'],true);if(is_array($E)){Core::$dds+=$E;}}catch(\Exception$e){}$o=[];foreach(Core::$dds as$k=>$c){if(!in_array($k,['dds','id','title','mimetype'])){try{$o[$k]=@DS::query($c[0],@$c[1],strtr(@$c[2],['@ID'=>$k]),@$c[3],@$c[4],@$c[5],View::getval(@$c[6]));foreach($o[$k]as$i=>$v){$d=@json_decode($v['data'],true);if(is_array($d)){$o[$k][$i]+=$d;}unset($o[$k][$i]['data']);}}catch(\Exception$e){Core::log('W',$k.' '.$e->getMessage().' '.implode(' ',$c),'dds');}}}if(!empty($o)){foreach($o as$k=>$v){$app->$k=$v;}}}}class View extends Extension{private static$hdr=['meta'=>[],'link'=>[],'css'=>[],'js'=>[],'jslib'=>[],];private static$menu;private static$n;private static$c;private static$o=[];private static$tc;private static$p;public static$e='';public static function init($core){self::$o['core']=$core;if(!empty(Core::$core->meta)&&is_array(Core::$core->meta)){self::$hdr['meta']=Core::$core->meta;}self::$hdr['meta']['viewport']='width=device-width,initial-scale=1.0';if(!empty(Core::$core->link)&&is_array(Core::$core->link)){self::$hdr['link']=Core::$core->link;}$js='vendor/phppe/Core/js/core.js.php';if(file_exists($js)){self::$hdr['jslib']['core.'.Core::$client->lang.'.js']="01$js";}self::$tc=0;}public static function setPath(&$p){self::$p=&$p;}public static function assign($n,&$o){self::$o[$n]=&$o;}public static function css($c=''){if(empty($c)){return self::$hdr['css'];}if(substr($c,0,4)=='http'){self::$hdr['link'][$c]='stylesheet';}else{$a=self::dir().'/css/'.@explode('?',$c)[0];if(!file_exists($a)){$a.='.php';}if(!isset(self::$hdr['css'][$c])&&file_exists($a)){self::$hdr['css'][$c]=realpath($a);}}}public static function jslib($l='',$i='',$p=9){if(empty($l)){return self::$hdr['jslib'];}if($p<0||$p>99)$p=99;if(substr($l,0,4)=='http'){self::$hdr['jslib'][$l]=sprintf('%02d',$p).$l;}else{$a=self::dir().'/js/'.@explode('?',$l)[0];if(!file_exists($a)){$a.='.php';}if(!isset(self::$hdr['jslib'][$l])&&file_exists($a)){self::$hdr['jslib'][$l]=sprintf('%02d',$p).realpath($a);}}$i=trim($i);if(!empty($i)&&(empty(self::$hdr['js']['init()'])||strpos(self::$hdr['js']['init()'],$i)===false)){self::js('init()',$i.($i[strlen($i)-1]!=';'?';':''),true);}}public static function js($f='',$c='',$a=0){if($c){$C=Assets::minify($c,'js');$C.=($C[strlen($C)-1]!=';'?';':'');if($a){if(strpos(@self::$hdr['js'][$f],$C)===false){@self::$hdr['js'][$f].=$C;}}else{self::$hdr['js'][$f]=$C;}}}public static function menu($t='',$l=''){if(empty($t)){return self::$menu;}if(is_string($l)||is_array($l)){self::$menu[$t]=$l;}}public static function fromCache($N){$d=Cache::get($N);if(is_array($d)){foreach(['m'=>'meta','c'=>'css','j'=>'js','J'=>'jslib']as$k=>$v){if(is_array($d[$k])){self::$hdr[$v]=array_merge(self::$hdr[$v],$d[$k]);}}return$d['d'];}return'';}public static function generate($template,$N=''){$T="";if(!empty($template)){$T=self::template($template);if(empty($T))$T=self::template(Core::$core->app.'_'.Core::$core->action);if(empty($T))$T=self::template(Core::$core->app);if(empty($T))$T=self::template('404');if(empty($T)&&Core::$core->app=='index'){$T='<h1>PHPPE works!</h1>Next step:<pre>php public/'.basename(__FILE__).' --diag</pre>';}}if(empty(Core::$core->noframe)){$d=self::template('frame');if(!$d)$T="<div id='content'>".$T."</div>";elseif(preg_match('/<!app>/ims',$d,$m,PREG_OFFSET_CAPTURE)){$T=substr($d,0,$m[0][1]).$T.substr($d,$m[0][1]+6);}}asort(self::$hdr['jslib'],SORT_FLAG_CASE|SORT_STRING);if(!empty($T)&&!empty($N)){Cache::set($N,['m'=>self::$hdr['meta'],'l'=>self::$hdr['link'],'c'=>self::$hdr['css'],'j'=>self::$hdr['js'],'J'=>self::$hdr['jslib'],'d'=>$T,]);}return$T;}public static function template($n){if($n=='403'||$n=='404'){@header("HTTP/1.1 $n ".($n=='403'?'Access Denied':'Not Found'));}$d=self::get($n);if(empty($d)){return'';}self::$n=-1;self::$c=[];return self::_t($d);}public static function getval($x){if(!is_string($x)){return$x;}if(strpos($x,'$')!==false||preg_match('/[^!=]=[^=]/',$x)){return self::e('W','BADINP',$x);}$l=$r='';$d=$x;for($i=0;$i<strlen($d);++$i){$c=$d[$i];if($c=='"'||$c=="'"){$r.=$c;++$i;$b='';while($i<strlen($d)&&$b!=$c){if($b=='\\'){$b.=$d[$i++];}$r.=$b;$b=$d[$i++];}$r.=$c;$l='';}if((ctype_alpha($c)||$c=='_')&&!ctype_alnum($l)&&$l!='.'&&$l!='_'){$j=$i;$b=$d[$j];while($b&&(ctype_alnum($b)||$b=='_')){++$j;$b=isset($d[$j])?$d[$j]:'';}if($b!='('&&$b!=':'){$v=substr($d,$i,$j-$i);switch($v){case'KEY':case'IDX':case'VALUE':if(isset(self::$c[self::$n]->$v)){$v=self::$c[self::$n]->$v;}if(is_array($v)){return$v;}@$r.="'".addslashes($v)."'";$i=$j;break;case'ODD':$r.=self::$c[self::$n]->IDX%2;$i=$j;break;case'parent':$Y=self::$n-1;while(substr($d,$j,7)=='.parent'){$j+=7;--$Y;}$n=substr($d,$j+1,3);$j+=4+($n=='VAL'?2:0);if($n=='ODD'){$v=self::$c[$Y]->IDX%2;}elseif(isset(self::$c[$Y]->$n)){$v=self::$c[$Y]->$n;}elseif(isset(self::$c[$Y]->VALUE[$n])){$v=self::$c[$Y]->VALUE[$n];}elseif(isset(self::$c[$Y]->VALUE->$n)){$v=self::$c[$Y]->VALUE->$n;}else{$v='';}$r.="'".addslashes($v)."'";$i=$j;break;case'true':case'false':case'null':break;default:if(isset(self::$c[self::$n])&&is_array(self::$c[self::$n]->VALUE)){@$r.="'".addslashes(self::$c[self::$n]->VALUE[$v])."'";$i=$j;}elseif(isset(self::$c[self::$n]->VALUE->$v)){@$r.="'".addslashes(self::$c[self::$n]->VALUE->$v)."'";$i=$j;}else{$r.='$';$f[$v]=1;}}}elseif($b=='('&&($j-$i!=1||$d[$i]!='L')&&substr($d,$i,5)!='core.'&&substr($d,$i,$j-$i)!='array'&&!empty(Core::$core->allowed)&&!in_array(substr($d,$i,$j-$i),Core::$core->allowed)){return self::e('E','BADFNC',$x);}}$r.=($c=='.'?'->':(isset($d[$i])?$d[$i]:''));$l=$c;}$r=strtr($r,["+'"=>".'",'+"'=>'."',"'+"=>"'.",'"+'=>'".']);if(!empty($f)){foreach($f as$k=>$v){if(!isset($$k)&&isset(self::$o[$k])){$$k=self::$o[$k];}elseif(!isset($$k)&&isset(self::$o['app']->$k)){$$k=self::$o['app']->$k;}}}$e=error_reporting();error_reporting($e&~E_NOTICE);ob_start();self::$e=$x.' => '.$r;$R=eval('return '.$r.';');$o=ob_get_clean();error_reporting($e);self::$e='';if(Core::$core->runlevel>2||!empty($o)){Core::log(!empty($o)?'E':'D',$x.' => '.$r.' = '.serialize($R),'view');}return$R;}public static function tc(){return++self::$tc;}public static function e($w,$c,$m){if(!is_string($m)){$m=json_encode($m);}return!empty(Core::$core->output)&&Core::$core->output=='html'?"<span style='background:#F00000;color:#FEA0A0;padding:3px;'>".($w?"$w-":'').($c?"$c:&nbsp;":'').htmlspecialchars($m).'</span>':"$c-$w: ".strtr($m,["\r"=>'',"\n"=>'\\n'])."\n";}public static function _t($x,$re=0){$L=self::e('W','TOOMNY',L('recursion limit exceeded').'!');if($re>=64){return$L;}$J=ClassMap::has("PHPPE\\CMS")&&get_class(self::$o['app'])=="PHPPE\\Content"&&Core::$user->has("siteadm|webadm");if(preg_match_all("/<!([^\[\-][^>]+)>[\r\n]*/ms",$x,$T,PREG_OFFSET_CAPTURE|PREG_SET_ORDER)){$o=[];$I=0;foreach($T as$k=>$v){$T[$k][0][2]=strlen($v[0][0]);$t=strtolower(substr($v[1][0],0,4));if(substr($t,0,2)=='if'||$t=='fore'||$t=='temp'){$o[$I++]=$k;}elseif($t=='else'){@$T[$o[$I-1]][4]=$k;}elseif(substr($t,0,3)=='/if'||$t=='/for'||$t=='/tem'){@$T[$o[--$I]][3]=$k;}}if($I){return self::e('W','UNCLS',L('unclosed tag'));}unset($o);$C=0;for($k=0;$k<count($T)&&$m=$T[$k];++$k){$H=trim($m[1][0]);$w='';$a='';if($H[0]=='='){$t=$g='=';}else{$g=trim(strstr($H,' ',true));$t=trim(strstr($g,'(',true));if(empty($t))$t=$g;}if(empty($t)){$t=$g=$H;}else{$a=trim(substr($H,strlen($g)));}$A=Core::x(' ',$a);$N=$m[0][1];$M=$m[0][2];switch($t){case'app':$w='<!app>';break;case'include':$c=self::get($a);if(!$c){$c=self::get(self::getval($a));}$w=self::_t($c,$re+1);break;case'=':$w=self::getval($a);break;case'template':$w=self::_t(strtr(self::_t(substr($x,$m[0][1]+$m[0][2]+$C,$T[$m[3]][0][1]-$m[0][1]-$m[0][2]),$re),'<%','<!'),$re+1);$k=$m[3];$M=$T[$m[3]][0][1]-$m[0][1]+$T[$m[3]][0][2];break;case'foreach':$d=self::getval($a);++self::$n;self::$c[self::$n]=(object)['IDX'=>1];$t=substr($x,$m[0][1]+$m[0][2]+$C,$T[$m[3]][0][1]-$m[0][1]-$m[0][2]);if((is_array($d)&&count($d)>0)||is_object($d)){foreach($d as$k=>$v){self::$c[self::$n]->KEY=$k;self::$c[self::$n]->VALUE=$v;$w.=@self::_t($t,$re+1);++self::$c[self::$n]->IDX;}}$k=$m[3];$M=$T[$m[3]][0][1]-$m[0][1]+$T[$m[3]][0][2];unset(self::$c[self::$n]);--self::$n;break;case'if':$M=$T[$m[3]][0][1]+$T[$m[3]][0][2]-$m[0][1];$w=self::_t(($a!='cms'&&!empty(self::getval($a)))||($a=='cms'&&$J)?substr($x,$N+$C+$m[0][2],!empty($m[4])?$T[$m[4]][0][1]-$m[0][1]-$m[0][2]:$M-$m[0][2]-$T[$m[3]][0][2]):(!empty($m[4])?substr($x,$T[$m[4]][0][1]+$C+$T[$m[4]][0][2],$T[$m[3]][0][1]-$T[$m[4]][0][1]-$T[$m[4]][0][2]):''),$re+1);$k=$m[3];break;case'form':self::$tc=0;$c=sha1(url());$n=!empty($A[0])&&$A[0]!='-'?urlencode($A[0]):'form';$w='<form'.(!empty($A[4])?" role='form'":'')." name='".$n."' action='".url(!empty($A[2])&&$A[2]!='-'?$A[2]:'')."' class='".(!empty($A[1])&&$A[1]!='-'?$A[1]:'form-vertical')."' method='post' enctype='multipart/form-data'".(!empty($A[3])&&$A[3]!='-'?' onsubmit="'.strtr($A[3],['"'=>'\\"']).'"':'')."><input type='hidden' name='MAX_FILE_SIZE' value='".Core::$fm."'><input type='hidden' name='pe_s' value='".@$_SESSION['pe_s'][$c]."'><input type='hidden' name='pe_f' value='".$n."'>".(!empty(Core::$core->item)?"<input type='hidden' name='item' value='".htmlspecialchars(Core::$core->item)."'>":'');break;case'time':case'date':$v=self::getval($A[0]);$w=!empty($v)?date((!empty(Core::$l['dateformat'])?Core::$l['dateformat']:'Y-m-d').($t=='time'?' H:i:s':''),self::ts($v)):(!empty($A[1])?'':L('Epoch'));break;case'difftime':$w='';$v=self::getval($A[0]);if(!empty($A[1])){if(!$v){$w='-';break;}$v-=self::ts(self::getval($A[1]));}if($v<0){$w='- ';$v=-$v;}$c=floor($v /86400);$b=floor(($v-$c*86400)/3600);$a=floor(($v-$c*86400-$b*3600)/60);$w.=$c?"$c ".L('day'.($c>1?'s':'')):($b?"$b ".L('hour'.($b>1?'s':'')):'').($a||!$b?($b?', ':'')."$a ".L('min'.($a>1?'s':'')):'');break;case'l':case'L':$w=L($a);break;case'dump':$l=Core::$core->runlevel;if($l<1){$w='';}else{ob_start();$s=null;if($A[0]=='_SESSION'){$s=$_SESSION;unset($s['pe_u']);unset($s['pe_s']);unset($s['pe_v']);}else{$s=self::getval($A[0]);}if($l>1){var_dump($s);$n=ob_get_clean();if($n[0]!='<'){$n='<pre>'.$n.'</pre>';}}else{print_r($s);$n='<pre>'.htmlspecialchars(ob_get_clean()).'</pre>';}$w="<div class='dump'><b style='font:monospace;'>".$A[0].':</b>'.preg_replace("/<small>.*?<\/small>\n?/",'',preg_replace("/PRIVATE KEY.*?PRIVATE KEY\n?/ims",'',$n)).'</div>';}break;case'cms':case'widget':case'var':case'field':$Z=$R=$m=false;$w="";$G=$t=='cms';$V=$t=='var';if($A[0][0]=='@'){$Z=substr($A[0],1);array_shift($A);}$Z=empty($Z)||Core::$user->has($Z);if($A[0][0]=='*'){$R=true;$A[0]=substr($A[0],1);}$f=$A[0];if(preg_match("/^([^\(]+)[\(]?([^\)]*)/",$A[0],$B)&&!empty($B[1])){$f=$B[1]=='submit'?'update':$B[1];$a=self::getval('['.$B[2].']');array_shift($A);$n=!empty($A[0])?$A[0]:'';array_shift($A);$v=self::getval($n);$d='\\PHPPE\\Addon\\'.$f;if(ClassMap::has($d)){$F=new$d($a,$n,$v,$A,$R);if(empty(Core::$core->addons[$f])){if(method_exists($F,'init')){$F->init();}else{Core::addon($f,"addon $f");}}if($G){if($J&&$Z)$w=CMS::icon($g,$f,$F);$m=$R?"show":"";}else{if($R||$f=='check'||$f=='file'||method_exists($d,'validate')){$_SESSION['pe_v'][$n][$f]=[$R,$a,$A];}$m=$t=='field'||!empty($_SESSION[$V?'pe_e':'pe_c'])&&method_exists($F,'edit')?'edit':'show';}$w.=$m&&method_exists($F,$m)&&$Z?$F->$m():"";unset($F);break;}}$w.=($V&&empty($_SESSION['pe_e']))?(is_scalar($v)?$v.'':$v&&json_encode($v)):self::e('W','UNKADDON',$f);break;default:$w=self::e('W','UNKTAG',$t);}$D=$N+$C&&$x[$N+$C-1]=="\n"?1:0;$E=isset($x[$N+$M+$C])&&$x[$N+$M+$C]=="\n"?1:0;$x=substr($x,0,$N+$C-$D).$w.substr($x,$N+$M+$C+$E);$C+=@strlen($w)-$M-$D-$E;}}return$x;}public static function output(&$txt){$o=Core::$core->output;Http::mime((!empty(self::$o['app']->mimetype)?self::$o['app']->mimetype:'text/'.($o?$o:'html')),false);if($o){$c=@glob('vendor/phppe/*/out/'.$o.'_header.php');if(!empty($c[0]))include_once$c[0];elseif($o=='html'){$P=empty(Core::$core->nopanel)&&Core::$user->has('panel');$I=basename(__FILE__).'/';if($I=='index.php/')$I='';$d='http'.(Core::$core->sec?'s':'').'://'.Core::$core->base;echo"<!DOCTYPE HTML>\n<html lang='".Core::$client->lang."'".(!empty(Core::$l['rtl'])?" dir='rtl'":'').'>'.'<head><title>'.(!empty(self::$o['app']->title)?self::$o['app']->title:(Core::$core->title?Core::$core->title:'PHPPE'.VERSION)).'</title>'."<base href='$d'/><meta charset='utf-8'/>\n<meta name='Generator' content='PHPPE".VERSION."'/>\n";foreach(array_merge(self::$hdr['meta'],!empty(self::$o['app']->meta)?self::$o['app']->meta:[])as$k=>$m){if($k&&$m){echo"<meta name='$k' content='".htmlspecialchars($m)."'/>\n";}}self::$hdr['link'][!empty(self::$o['app']->favicon)?self::$o['app']->favicon:'favicon.ico']='shortcut icon';foreach(self::$hdr['link']as$k=>$m){if(!empty($m)&&$m!='js'){echo"<link rel='$m' href='".$k."'/>\n";}}$O="<style media='all'>\n";$d="@import url('%s');\n";$N=Core::$core->base.Core::$core->url.'/'.Core::$user->id.'/'.Core::$client->lang;$e='css';if($P){$O.=sprintf($d,$I."?cache=$e");}if(!empty(self::$hdr['css'])){if(!empty(Cache::$mc)&&empty(Core::$core->noaggr)){$n=sha1($N."_$e");if(empty(Cache::get("c_$n"))){$da='';foreach(self::$hdr['css']as$u=>$v){if($v&&substr($v,-3)!='php'&&$u[0]!='?'){$da.=Assets::minify(file_get_contents($v),$e)."\n";}}Cache::set("c_$n",['m'=>"text/$e",'d'=>$da]);}$O.=sprintf($d,$I."?cache=$n");foreach(self::$hdr['css']as$u=>$v){if($v&&($u[0]=='?'||substr($v,-3)=='php')){$O.=sprintf($d,($u[0]=='?'?'':$I."$e/").$u);}}}else{foreach(self::$hdr['css']as$u=>$v){if($v){$O.=sprintf($d,($u[0]=='?'?'':$I."$e/").$u);}}}}$O.="</style>\n";echo"$O</head>\n<body".(!empty(self::$hdr['js']['init()'])?" onload='init();'":'').">\n";if($P){$H=" class='sub' style='visibility:hidden;' onmousemove='return pe_w();'";$O="<div id='pe_p'><a href='".url('/')."'><img src='$I?cache=logo' alt='PHPPE".VERSION."' style='margin:3px 10px -3px 10px;float:left;'></a><div class='menu'>";$x=0;if(!empty(self::$menu)){foreach(self::$menu as$e=>$L){@list($ti,$a)=explode('@',$e);if($a&&!Core::$user->has($a))continue;$a=0;if(is_array($L)){$l=$L[array_keys($L)[0]];}else{$l=$L;}$U=Core::$core->url;if(substr($l,0,strlen($U))==$U){$a=1;}else{$d=explode('/',$l);if(Core::$core->app==(!empty($d[0])?$d[0]:'index')){$a=1;}unset($d);}if(is_array($L)){$O.="<div id='pe_m$x'$H><ul>";foreach($L as$t=>$l){if($t){@list($Y,$A)=explode('@',$t);if(empty($A)||Core::$user->has($A)){$O.="<li onclick=\"document.location.href='".$I."$l';\"><a href='".$I."$l'>".htmlspecialchars(L($Y)).'</a></li>';}}}$O.="</ul></div><span class='menu_".($a?'a':'i')."' onclick='return pe_p(\"pe_m$x\");'>".htmlspecialchars(L($ti)).'</span>';++$x;}else{$O.="<span class='menu_".($a?'a':'i')."'><a href='".$I."$L'>".htmlspecialchars(L($ti)).'</a></span>';}}}$O.="</div><div class='stat'>";foreach(Core::lib()as$d){if(method_exists($d,'stat')){$O.='<span>'.$d->stat().'</span>';}}$O.="<div id='pe_l'$H><ul>";if(!empty($_SESSION['pe_ls'])){$d=$_SESSION['pe_ls'];}else{$D=@scandir('app/lang');if(!is_array($D))$D=[];$d=@scandir('vendor/phppe/Core/lang');if(is_array($d)){$D=array_unique($D+$d);}$d=[];foreach($D as$f){if(substr($f,-4)=='.php'){$d[substr($f,0,strlen($f)-4)]=1;}}$_SESSION['pe_ls']=$d;}foreach($d as$k=>$v){if($k){$O.="<li><a href='".url()."?lang=$k'><img src='images/lang_$k.png' alt='$k' title='$k'>".($k!=L($k)?'&nbsp;'.L($k):'').'</a></li>';}}$O.='</ul></div>';$k=Core::$client->lang;$f="images/lang_$k.png";$c=!empty($_SESSION['pe_c']);$O.="<span onclick='return pe_p(\"pe_l\");'>".(file_exists('vendor/phppe/Core/'.$f)?"<img src='$f' height='10' alt='$k' title='$k'>":$k).'</span>'."<div id='pe_u'$H><ul><li onclick='pe_p(\"\");if(typeof users_profile==\"function\")users_profile(this);else alert(\"".L('Install PHPPE Users')."\");'>".L('Profile').'</li>'.(Core::$user->has('conf')?"<li><a href='".url().'?conf='.(1-$c)."'>".L(($c?'Lock':'Unlock')).'</a></li>':'')."<li><a href='".url('logout')."'>".L('Logout').'</a></li></ul></div>'."<span onclick='return pe_p(\"pe_u\");'>".(!empty(Core::$user->name)?Core::$user->name:'#'.Core::$user->id).'</span></div></div>'."<div style='height:32px !important;'></div>\n";echo$O;}}}echo$txt;if($o){$c=@glob('vendor/phppe/*/out/'.$o.'_footer.php');if(!empty($c[0]))include_once$c[0];elseif($o=='html'){$d='<script';$e="</script>\n";$a=" src='".$I.'js/';$O='';if(!empty(self::$hdr['jslib'])){if(!empty(Cache::$mc)&&empty(Core::$core->noaggr)){$n=sha1($N.'_js');if(empty(Cache::get("c_$n"))){$da='';foreach(self::$hdr['jslib']as$u=>$v){if($v&&substr($v,-3)!='php'&&substr($u,0,4)!='http'){$da.=Assets::minify(file_get_contents(substr($v,2)),'js')."\n";}}Cache::set("c_$n",['m'=>'text/javascript','d'=>$da]);}$O.="$d src='${I}js/?cache=$n'>$e";foreach(self::$hdr['jslib']as$u=>$v){if(substr($u,0,4)=='http'){$O.="$d src='$u'>$e";}elseif($u[0]=='?'||substr($v,-3)=='php'){$O.="$d$a$u'>$e";}}}else{foreach(self::$hdr['jslib']as$u=>$v){if(substr($u,0,4)=='http'){$O.="$d src='$u'>$e";}else{$O.="$d$a$u'>$e";}}}}$c='users.js';$i=file_exists('vendor/phppe/Core/js/'.$c.'.php');if($P&&!isset(self::$hdr['jslib'][$c])&&$i){$O.="$d$a$c'>$e";}$c=self::$hdr['js'];$a='';if($P&&!$i){$x='document.getElementById(';$y='.style.visibility';$a="pe_t=setTimeout(function(){pe_p('');},2000)";$c['L(t)']="return t.replace(/_/g,' ');";$c['pe_p(i)']="var o=i?${x}i):i;if(pe_t!=null)clearTimeout(pe_t);if(pe_c&&pe_c!=i)${x}pe_c)$y='hidden';pe_t=pe_c=null;if(o!=null&&o.style!=null){if(o$y=='visible')o$y='hidden';else{o$y='visible';pe_c=i;$a;}}return false;";$c['pe_w()']="if(pe_t!=null)clearTimeout(pe_t);$a;return false;";$a=',pe_t,pe_c';}if(!empty($c)){$O.=$d.">\nvar pe_ot=".($P?31:0)."$a;\n";foreach($c as$fu=>$co){$O.="function $fu {".$co."}\n";}$O.=$e;}$D=Core::isError();$s=Core::started();$d='REQUEST_TIME_FLOAT';$T=!empty($_SERVER[$d])?$_SERVER[$d]:$s;echo"\n$O<!-- MONITORING: ".($D>0?'ERROR':(Core::$core->runlevel>0?'WARNING':'OK')).', page '.sprintf("%.4f sec, db %.4f sec, server %.4f sec, mem %.4f mb%s -->\n</body>\n</html>\n",microtime(1)-$T,DS::bill(),$s-$T,memory_get_peak_usage()/1024 /1024,!empty(Cache::$mc)&&empty(Core::$core->nocache)?', mc':'');}}flush();}public static function picture($o,$n,$w,$h,$c=0,$l=1,$W='',$s=8192,$m=5){$d=@file_get_contents($o);if(!function_exists('gd_info')||empty($d)||!($i=@imagecreatefromstring($d))){Core::log('W',"no php-libgd or bad image: $o",'picture');if(file_exists($o)){@copy($o,$n);}return false;}$x=imagesx($i);$y=imagesy($i);$q=9;$m=($m>0&&$m<10?$m:5);$s=($s>64?$s:64)*1024;$j='imagepng';if(!$l){$j='imagejpeg';$m*=10;$q=99;}Core::log('D',$o."($x,$y) -> ".$n."($w,$h,".($c?'crop':'resize').",$j,$s,$q) $W",'picture');if(!$c){$X=$x<$y?floor(($h /$y)*$x):$w;$Y=$x<$y?$h:floor(($w /$x)*$y);$c=$d=0;$e=$x;$f=$y;}else{$X=$w;$Y=$h;$c=$x>$y?floor(abs($x-$y)/2):0;$d=$x>$y?0:floor(abs($y-$x)/2);$e=$x>$y?floor($w*$y /$h):$x;$f=$x>$y?$y:floor($w*$x /$h);}$N=imagecreatetruecolor($X,$Y);if($l){imagealphablending($N,0);$a=imagecolorallocatealpha($N,255,255,255,255);imagesavealpha($N,1);}else{$a=imagecolorallocate($N,255,255,255);}imagefill($N,0,0,$a);imagecopyresampled($N,$i,0,0,$c,$d,$X,$Y,$e,$f);if(!empty($W)){$g=@imagecreatefrompng($W);if(!empty($g)){$a=imagesx($g);$b=imagesy($g);for($y=0;$y<$Y;$y+=$a){for($x=0;$x<$X;$x+=$a){imagecopyresampled($N,$g,$x,$y,0,0,$a,$b,$a,$b);}}}else{Core::log('W',"bad watermark image: $W",'picture');}}@unlink($n);while(!file_exists($n)||(filesize($n)>$s&&$q>=$m)){@unlink($n);if(!$j($N,$n,$q--)){@copy($o,$n);return false;}}return true;}public static function v($a,$b,$e='',$f=[],$p='',$i='',$n=''){return(@$a->css[0]=='r'?' required':'').($p?" pattern='".$p."'":'')." class='".$a->css.' '.(!empty($b)&&$b!='-'?$b:'form-control')."'".($a->fld?" id='".$a->fld.$i."' name='".$a->fld.$n."'":'').($e&&$e!='-'?" onchange='".$e."'":'').(!empty($f[0])&&$f[0]>0?" maxlength='".$f[0]."'":'');}public static function get($n){$t='';$m=[];$V='views';$e='.tpl';$C='t_'.sha1(Core::$core->base.'_'.$n);if($p=Cache::get($C)&&!empty($p)&&is_array($p)&&!empty($p['d']))$t=$p['d'];if(empty($t)){if(!empty(DS::db())){try{foreach([Core::$core->app.'/'.$n,$n]as$v){$p=DS::fetch('*',$V,'id=?','','',[$v]);if(!empty($p['data'])){foreach(['css','jslib']as$c){$t=json_decode($p[$c],true);if(is_array($t)){foreach($t as$v){self::$hdr[$c][basename($v)]=($c=='jslib'?'99':'').$v;}}}$t=$p['data'];break;}}}catch(\Exception$e){}}if(!$t){foreach(["app/$V/$n$e",self::$p?self::$p."/$V/$n$e":'','vendor/phppe/'.Core::$core->app."/$V/$n$e","vendor/phppe/Core/$V/$n$e",]as$F){if($F&&file_exists($F)){$t=file_get_contents($F);break;}}}$t=preg_replace("/<!-.*?->[\r\n]*/ms",'',preg_replace("/<\?.*?\?\>[\r\n]*/ms",'',$t));if(!empty($t)){Cache::set($C,['d'=>$t]);}}return$t;}private static function dir(){$d=dirname(debug_backtrace()[1]['file']);if(in_array(basename($d),['ctrl','libs','js','css','addons','tests'])){$d=dirname($d);}return$d;}private static function ts($v){return preg_match('|^[0-9]+$|',$v)?$v:strtotime($v);}public static function dump(){Http::mime('text/plain',false);print_r(self::$o);print_r($_SERVER);print_r(Http::route());die;}}class Tools extends Extension{public static function rmdir($dir){if(is_dir($dir)){$d=array_diff(scandir($dir),[".",".."]);foreach($d as$v){self::rmdir($dir."/".$v);}return rmdir($dir);}else{return unlink($dir);}}public static function untar($file,$fn=''){$body='';$f=gzopen($file,'rb');if($f){$read='gzread';$close='gzclose';$close='gzclose';$open='gzopen';}else{$f=bzopen($file,'rb');if($f){$read='bzread';$close='bzclose';$close='bzclose';$open='bzopen';}else{throw new \Exception(L('Unable to open ').': '.$file);}}$data=$read($f,512);$close($f);if($data[0]=='P'&&$data[1]=='K'){$zip=zip_open($file);if(!$zip){throw new \Exception(L('Unable to open ').': '.$file);}while($zip_entry=zip_read($zip)){$zname=zip_entry_name($zip_entry);if(!zip_entry_open($zip,$zip_entry,'r')){continue;}$zip_fs=zip_entry_filesize($zip_entry);if(empty($zip_fs)){continue;}$body=zip_entry_read($zip_entry,$zip_fs);if(!empty($fn)&&is_string($fn)){zip_entry_close($zip_entry);zip_close($zip);return$body;}if(is_array($fn)&&method_exists($fn[0],$fn[1])){call_user_func($fn,$zname,$body);}zip_entry_close($zip_entry);}zip_close($zip);return;}$f=$open($file,'rb');$ustar=substr($data,257,5)=='ustar'?1:0;while(!feof($f)&&$data){$name='';if($ustar){$data=$read($f,512);$size=octdec(substr($data,124,12));$body=$size>0?$read($f,floor(($size+511)/512)*512):'';$i=0;while(isset($data[$i])&&ord($data[$i])!=0&&$i<512){$i++;}$name=substr($data,0,$i);}else{$data=$read($f,110);if(substr($data,0,6)!='070701'){throw new \Exception(L('Bad format'));}$size=floor((hexdec(substr($data,54,8))+3)/4)*4;$len=hexdec(substr($data,94,8));$len+=floor((110+$len+3)/4)*4-110-$len;$name=trim($read($f,$len));$body='';if($name=='TRAILER!!!'){break;}$body=$read($f,$size);}if(empty($name)){$close($f);return'';}if(!empty($fn)&&is_string($fn)&&$name==$fn){$close($f);return substr($body,0,$size);}if($size>0&&is_array($fn)&&method_exists($fn[0],$fn[1])){call_user_func($fn,$name,substr($body,0,$size));}}$close($f);}public static function ssh($cmd,$input="",$precmd=""){if(empty(Core::$user->data['remote']['identity'])||empty(Core::$user->data['remote']['user'])||empty(Core::$user->data['remote']['host'])||empty(Core::$user->data['remote']['path'])){throw new \Exception(L('configure remote access'));}$idfile=tempnam('.tmp','.id_');file_put_contents($idfile,trim(Core::$user->data['remote']['identity'])."\n");chmod($idfile,0400);$ssh=($precmd?$precmd."|":"")."ssh -i ".escapeshellarg($idfile)." -l ".escapeshellarg(Core::$user->data['remote']['user']).(!empty(Core::$user->data['remote']['port'])&&Core::$user->data['remote']['port']>0?" -p ".intval(Core::$user->data['remote']['port']):"")." ".escapeshellarg(Core::$user->data['remote']['host'])." sh -c \\\" ".$cmd." \\\" 2>&1";Core::log('D',$ssh,"remote");$d=[0=>["pipe","r"],1=>["pipe","w"]];$pr=proc_open($ssh,$d,$p);if($pr!==false&&is_array($p)){if(!empty($input))fwrite($p[0],$input);fclose($p[0]);$r=trim(stream_get_contents($p[1]));fclose($p[1]);proc_close($pr);}else{$r="ssh: unable to execute";}unlink($idfile);return$r;}public static function copy($files,$dest=''){if(is_string($files)){$files=[$files];}foreach($files as$k=>$v){$files[$k]=escapeshellarg($v);}$r=self::ssh("tar -xvz ".($dest?' -C '.escapeshellarg(Core::$user->data['remote']['path'].'/'.$dest):'')." 2>\&1","","tar -cz ".implode(' ',$files));if(in_array(substr($r,0,4),['ssh:','tar:'])||substr($r,0,3)=='sh:'){throw new \Exception(sprintf(L('failed to copy %d files to %s'),count($files),Core::$user->data['remote']['user'].'@'.Core::$user->data['remote']['host'].':'.Core::$user->data['remote']['path'].'/'.$dest).': '.explode("\n",$r)[0]);}return$r;}}class ClassMap extends Extension{public static$file='data/classmap';public static$map=[];public function __construct(){if(!file_exists(self::$file)||@$_SERVER['argv'][1]=='--diag'){self::$map=$this->generate();}elseif(empty(self::$map)){self::$map=json_decode(@file_get_contents(self::$file),true);}if(!is_array(self::$map)){self::$map=$this->generate();}spl_autoload_register(function($c){if(!class_exists($c)&&!empty(\PHPPE\ClassMap::$map[strtolower($c)])){include_once \PHPPE\ClassMap::$map[strtolower($c)];}});}public static function has($c){return class_exists($c)||isset(self::$map[strtolower($c)]);}public function generate(){$D=[];$R=[];foreach(['*/*','*/*/*','*/*/*/*','*/*/*/*/*','*/*/*/*/*/*']as$v){$D+=array_fill_keys(@glob('vendor/'.$v.'.php'),0);}foreach($D as$fn=>$v){if(strpos(strtolower($fn),'autoload')!==false||file_exists(dirname($fn).'/.skipautoload')){continue;}$d=file_get_contents($fn);if(strpos($d,'/*!SKIPAUTOLOAD!*/')!==false){continue;}$i=0;$l=strlen($d);$ns='';while($i<$l&&substr($d,$i,2)!='<'.'?'){$i++;}while($i<$l){if(substr($d,$i,2)=='?'.'>'){while($i<$l&&substr($d,$i,2)!='<'.'?'){$i++;}continue;}if(($d[$i]=="'"||$d[$i]=='"')){$s=$d[$i];$j=$i;++$i;while($i<$l&&$d[$i]!=$s){if($d[$i]=='\\'){$i++;}$i++;}$i++;continue;}if($d[$i]=='/'&&$d[$i+1]=='/'){$s=$i;$i+=2;while($i<$l&&$d[$i]!="\n"){$i++;}continue;}if($d[$i]=='/'&&$d[$i+1]=='*'){$s=$i;$i+=2;while($i+1<$l&&($d[$i]!='*'||$d[$i+1]!='/')){$i++;}$i+=2;continue;}if(($d[$i]=='n'||$d[$i]=='c')&&preg_match("/^(namespace|class)[\ \t\n]+([^\ \t\n;{\[\(\]\)\$]+)/ims",substr($d,$i),$m)&&ctype_alpha(trim($m[2])[0])){$c=trim($m[2]);if(strtolower($m[1][0])=='n'){$ns=$c;}else{$R[strtolower($ns.($ns?'\\':'').$c)]=$fn;}$i+=strlen($m[0]);}$i++;}}ksort($R);@mkdir(dirname(self::$file),0750,true);$ret="";foreach($R as$k=>$v){$ret.=($ret?",\n":"").'  "'.addslashes($k).'": "'.addslashes($v)."\"";}file_put_contents(self::$file,"{\n".$ret."\n}",LOCK_EX);@chmod(self::$file,0664);return$R;}}class Core{private$id;public$base;public$url;public$app;public$action;public$item;public$template;public$now;public$title;public$runlevel=1;public$syslog=false;public$trace=false;public$timeout;public$mailer;public$nocache=false;public$cache;public$cachettl=600;public$db='';public$noctrl=false;public$output;public$form;public static$core;public static$user;public static$client;public static$l=[];public static$fm;public static$dds=[];private$try;private$error;private$libs=[];private$addons=[];private$disabled=[];private static$started;private static$v;public static$paths;public static$w;public static$g;public function __construct($islib=true){self::$started=microtime(1);self::$core=$core=&$this;set_exception_handler(function($e){self::log('C',get_class($e).' '.$e->getFile().'('.$e->getLine().'): '.$e->getMessage().(\PHPPE\View::$e?"\n".\PHPPE\View::$e:'').(empty(Core::$core->trace)?'':"\n\t".strtr($e->getTraceAsString(),["\n"=>"\n\t"])),$e->getTrace()[0]['function']=='getval'?'view':'');});ini_set('error_log',dirname(__DIR__).'/phppe/log/php.log');ini_set('log_errors',1);if(version_compare(PHP_VERSION,'7.0')<0){self::log('C','PHP 7.0.0 required, found '.PHP_VERSION);}ini_set('file_uploads',1);ini_set('upload_tmp_dir',dirname(__DIR__).'/.tmp');ini_set('uploadprogress.file.filename_template',dirname(__DIR__).'/.tmp/upd_%s.txt');mb_internal_encoding('utf-8');$c=__FILE__;if(filesize($c)!=78776||'b010ac6a17233cdc3ed2776515a8d4abcf22d005'!=sha1(preg_replace("/\'([^\']+)\'\!\=sha1/","''!=sha1",file_get_contents($c))))self::log("C","Corrupted ".basename($c));chdir(dirname(__DIR__));$c='vendor/phppe/Core/config.php';if(file_exists($c)){$cfg=@require_once$c;if(is_array($cfg)){foreach($cfg as$k=>$v){$this->$k=$v;}}}else{$this->syslog=true;}$this->id='PHPPE'.VERSION;if($this->runlevel<0||$this->runlevel>3){$this->runlevel=0;}if($this->timeout<60){$this->timeout=7*24*3600;}if($this->cachettl<10){$this->cachettl=10;}if(!empty($this->allowed)&&!is_array($this->allowed)){$this->allowed=explode(',',$this->allowed);}if(!is_array($this->disabled)){$this->disabled=explode(',',$this->disabled);}ini_set('display_errors',$this->runlevel>1?1:0);$this->now=time();$this->error=[];$this->sec=strtolower(getenv('HTTPS'))=='on'?1:0;self::$w=isset($_SERVER['REQUEST_METHOD'])?1:0;$this->output=self::$w?'html':'ncurses';$this->try=0;$c=self::toBytes('post_max_size');$d=self::toBytes('upload_max_filesize');$v=self::toBytes('memory_limit');if($c>$d&&$d){$c=$d;}self::$fm=($c>$v&&$v?$v:$c);$c=$_SERVER['SCRIPT_NAME'];$C=dirname($c);if($C=='.'){$C='';}elseif($C!='/'){$C.='/';}$d='SERVER_NAME';$this->base=(!empty($this->base)?$this->base:(!empty($_SERVER[$d])?$_SERVER[$d]:'localhost').(@$C[0]!='/'?'/':'').$C);if(get_magic_quotes_gpc()){foreach($_REQUEST as$k=>$v){if(is_string($v)){$_REQUEST[$k]=stripslashes($v);}elseif(a($v)){foreach($v as$K=>$V){if(is_string($V)){$_REQUEST[$k][$K]=stripslashes($V);}}}}}list($d)=explode('?',@$_SERVER['REQUEST_URI']);foreach([$c,dirname($c)]as$C){if($C!='/'&&substr($d,0,strlen($C))==$C){$d=substr($d,strlen($C));break;}}if(@$d[0]=='/'){$d=substr($d,1);}$D=explode('/',!empty($d)?'/'.$d:'//');foreach([1=>'app',2=>'action',3=>'item']as$c=>$v){$this->$v=!empty($D[$c])?$D[$c]:(!empty($_REQUEST[$v])?trim($_REQUEST[$v]):(!self::$w&&!empty($_SERVER['argv'][$c])&&$_SERVER['argv'][$c]!='--dump'?trim($_SERVER['argv'][$c]):($c<3?($c==1?'index':'action'):'')));}if(empty($d)){$d=$this->app.'/'.$this->action.(!empty($this->item)?'/'.$this->item:'');}$this->url=$d;if(!self::$w&&!$islib){if(in_array('--version',$_SERVER['argv'])){die(VERSION."\n");}if(empty($_SERVER['argv'][1])||in_array('--help',$_SERVER['argv'])){$c='php '.$_SERVER['argv'][0];die('PHP Portal Engine '.VERSION.", LGPL 2016 bzt\n\n $c --help\n $c --version\n $c --diag [--gid=x]\n $c [application [action [item]]] [--dump]\n\n");}}@include_once'vendor/autoload.php';$this->libs['ClassMap']=new ClassMap();$this->libs['DS']=new DS($this->db);$this->libs['Client']=new Client();$cls='\\PHPPE\\User';if(ClassMap::has($cls.'s')){$cls.='s';}$this->libs['Users']=new$cls();$this->libs['Cache']=new Cache($this->cache);$this->libs['Assets']=new Assets();$this->libs['Tools']=new Tools();$d=@glob('vendor/phppe/*',GLOB_NOSORT|GLOB_ONLYDIR);foreach($d as$f){$c=basename($f);self::$paths[strtolower($c)]=$f;if(!in_array($c,$this->disabled)&&file_exists($f.'/init.php')){$cls='\\PHPPE\\'.$c;$o=include_once$f.'/init.php';if(!is_object($o)&&$c!='Core'&&ClassMap::has($cls)){$o=new$cls();}if(empty($this->libs[$c])){$this->libs[$c]=is_object($o)?$o:new Extension();}}}if(!self::$w&&!$islib&&@$_SERVER['argv'][1]=='--diag'){$this->bootdiag();}else{$d='HTTP_IF_MODIFIED_SINCE';if($this->runlevel<2&&isset($_SERVER[$d])&&strtotime($_SERVER[$d])+$this->cachettl<$this->now){header('HTTP/1.1 304 Not Modified');die;}foreach($this->libs as$k=>$v){self::lang($k);$c=@include_once self::$paths[strtolower($k)].'/config.php';if(method_exists($v,'init')&&$v->init(is_array($c)?$c:[])===false){unset($this->libs[$k]);}}self::lang('app');if(!$islib){$this->run();}}}private function bootdiag(){self::$client->init();ini_set('display_errors',1);if(!empty($_SERVER['argv'][2])&&z($_SERVER['argv'][2],0,6)=='--gid='){$g['g']=intval(substr($_SERVER['argv'][2],6));}elseif(function_exists('posix_getpwnam')){foreach(['www','_www','www-data','http','httpd','apache','nginx']as$n){$g=posix_getpwnam($n);if(!empty($g['gid'])){$g['g']=$g['gid'];break;}}}if(empty($g['g'])){self::$g=33;}else{self::$g=$g['g'];}$U=fileowner(__FILE__);if($this->runlevel){echo"DIAG-I: uid $U gid ".self::$g."\n";}function i($c,$r,$f=0,$a=0640){if(!file_exists($c)||$f){echo"DIAG-A: $c\n";file_put_contents($c,$r);}if(file_exists($c)&&(!@chgrp($c,\PHPPE\Core::$g)||!@chown($c,fileowner(__FILE__)))){echo"DIAG-E: chown/chgrp $c\n";}return!@chmod($c,$a);}$E='';$C=0750;$W=0775;if(function_exists('posix_getuid')&&posix_getuid()!=0){echo"DIAG-W: not root or no php-posix, chown/chgrp may fail!\n";}$o=umask(0);$D=['.tmp'=>$W,'data'=>$W,'app'=>0,'vendor'=>0,'vendor/bin'=>0,'vendor/phppe'=>0,'vendor/phppe/Core'=>0,'vendor/phppe/Core/log'=>$W,'vendor/phppe/Core/views'=>0,'public/images'=>0,'public/css'=>0,'public/js'=>0,'app/addons'=>0,'app/sql'=>0,'app/ctrl'=>0,'app/lang'=>0,'app/libs'=>0,'app/views'=>0,];$A=['*','*/*','*/*/*','*/*/*/*','*/*/*/*/*'];foreach(['data/','vendor/']as$d){foreach($A as$v){$D+=array_fill_keys(@glob($d.$v),0);}}foreach($D as$d=>$p){if(!$p){$p=$C;}$x=in_array(substr($d,0,4),['.tmp','data'])||substr($d,0,21)=='vendor/phppe/Core/log';if(is_file($d)){$P=fileperms($d)&0777;$p=$x?($d==ClassMap::$file?0664:0660):0640;}else{if($x){$p=$W;}if(!is_dir($d)&&!is_file($d)){echo"DIAG-A: $d\n";if(!mkdir($d,$p)){self::log('C',"creating $d",'diag');}}$P=fileperms($d)&0777;}if($P!=$p){$E.=sprintf("\t%03o?\t%03o ",$P,$p)."$d\n";@chmod($d,$p);}if(!@chgrp($d,self::$g)||!@chown($d,$U)){echo"DIAG-E: chown/chgrp $d\n";}}@symlink('../../app','vendor/phppe/app');foreach(['images','css','js']as$v){if(!file_exists("app/$v")){echo"DIAG-A: app/$v\n";}@symlink("../public/$v","app/$v");}@symlink('vendor/phppe/Core','phppe');umask(0027);i('app/config.php','');i('app/init.php','<'."?php\n//! set your routes here (if any)\n//\\PHPPE\\Http::route('myurl','myClass','myMethod');\n\n//! return service instance (if any)\n//return new myService;\n");i('public/.htaccess',"RewriteEngine On\nRewriteCond %{REQUEST_FILENAME} !-f\nRewriteRule ^(.*)\$ index.php/\$1\n");i('public/favicon.ico','');i('vendor/phppe/Core/config.php','');$U='http://bztsrc.github.io/phppe3/';$D='vendor/phppe/Core/views/';$e='.tpl';$c="<!dump core.req2arr('obj')>";i($D."403$e","<h1>403</h1><!=L('Access denied')>");i($D."404$e","<h1>404</h1><!=L('Not found')>: <b><!=core.url></b>");i($D."frame$e","<div id='content'><!app></div>");i($D."index$e","<h1>PHPPE works!</h1>Next step: install <a href='".$U."phppe3_core.tgz' target='_new'>PHPPE Pack</a>.<br/><br/><!if core.isTry()><div style='display:none;'>$c</div><!/if><div style='background:#F0F0F0;padding:3px;'><b>Test form</b></div><!form obj>Text<!field text obj.f0 - - - Example [a-z0-9]+> Pass<!field pass obj.f1> Num(100..999)<!field *num(100,999) obj.f2> Phone<!field phone obj.f3><!field check obj.f4 Check>  File<!field file obj.f5>  <!field submit></form><table width='100%'><tr><td valign='top' width='50%'><!dump _REQUEST><!dump _FILES></td><td>&nbsp;</td><td valign='top'>$c</td></tr></table>\n");i($D."login$e","<!form login><div style='color:red;'><!foreach core.error()><!foreach VALUE><!=VALUE><br/><!/foreach><!/foreach></div><!field text id><!field pass pass><!field submit></form>");i($D."maintenance$e","<h1><!=L('Site is temporarily down for maintenance reasons.')></h1>");i('composer.json',"{\n\t\"name\":\"phppe3\",\n\t\"version\":\"1.0.0\",\n\t\"keywords\":[\"phppe3\",\"\"],\n\t\"license\":[\"LGPL-3.0+\"],\n\n\t\"type\":\"project\",\n\t\"repositories\":[\n\t\t{\"type\":\"composer\",\"url\":\"$U\"}\n\t],\n\t\"require\":{\"phppe/Core\":\"3.*\"},\n\n\t\"scripts\":{\"post-update-cmd\":\"sudo php public/index.php --diag\"}\n}\n");i('.gitignore',".tmp\nphppe\nvendor\n");if($E){self::log('E',"Wrong permissions:\n$E",'diag');}self::event('diag');umask($o);die("DIAG-I: OK\n");}public function run($app='',$ac=''){$c=sha1(url());$S=!empty($_SESSION['pe_s'][$c])?$_SESSION['pe_s'][$c]:'';for($i=1;$i<=9;++$i){if(isset($_REQUEST['pe_try'.$i])&&!empty($_REQUEST['pe_s'])&&$_REQUEST['pe_s']==$S){$this->try=$i;$this->form=!empty($_REQUEST['pe_f'])?trim($_REQUEST['pe_f']):'';$_SESSION['pe_s'][$c]=0;break;}}if(empty($_SESSION['pe_s'][$c])){$_SESSION['pe_s'][$c]=sha1(uniqid().'PHPPE'.VERSION);}if(!empty($_SESSION['pe_v'])){self::$v=$_SESSION['pe_v'];}$_SESSION['pe_v']=[];View::init($this);if(empty($this->maintenance)){list($app,$ac,$args)=HTTP::urlMatch($app,$ac,$this->url);list($app,$ac)=self::event('route',[$app,$ac]);$c=$app.'_'.$ac;if(strpos($c,'..')!==false||strpos($c,'/')!==false||substr($app,-4)=='.php'||substr($ac,-4)=='.php'){$app=$this->template='403';}else{$this->template=$app.'_'.$ac;}$appCls=$app;foreach(['PHPPE\\Ctrl\\'.$app.ucfirst($ac),'PHPPE\\Ctrl\\'.$app,'PHPPE\\'.$app,$app,]as$a){if(ClassMap::has($a)){$appCls=$a;break;}}if(!ClassMap::has($appCls)){if(!self::$w){die($this->app=='cron'?self::event('cron'.ucfirst($this->action),0):'PHPPE-C: '.L($this->app.'_'.$this->action.' not found!')."\n");}$appCls='PHPPE\\Content';$ac='action';}$appObj=new$appCls();View::setPath(self::$paths[strtolower($app)]);View::assign('app',$appObj);self::log('D',$this->url." ->$app::$ac ".$this->template,'routes');$N='p_'.sha1($this->base.$this->url.'/'.self::$user->id.'/'.self::$client->lang);if(empty($this->nocache)&&!self::isTry()){$T=View::fromCache($N);}if(empty($T)){Content::getDDS($appObj);self::event('ctrl',[$app,$ac]);if(!method_exists($appObj,$ac)){$ac='action';}if(method_exists($appObj,$ac)){!empty($args)?call_user_func_array([$appObj,$ac],$args):$appObj->$ac($this->item);}$T=View::generate($this->template,$N);}}else{session_destroy();$T=View::template('maintenance');if(empty($T)){$T=L('Maintenance mode is on');}}if((@in_array('--dump',$_SERVER['argv'])||isset($_REQUEST['--dump']))&&$this->runlevel>0){View::dump();}DS::close();$T=self::event('view',$T);View::output($T);session_write_close();}public static function lib($n='',$o=null,$d=''){$L=&self::$core->libs;if(empty($o)){return empty($n)?$L:(empty($L[$n])?null:$L[$n]);}else{$f='';if($d){if(!is_array($d)){$d=self::x(',',$d);}foreach($d as$v){if(!self::isInst($v)){$f.=($f?',':'').$v;}}if($f){self::log('C',"$n depends on: $f");}}if(empty(self::$core->libs[$n])){self::$core->libs[$n]=is_object($o)?$o:(class_exists($o)?new$o():new Extension());}}}public static function addon($n='',$l='',$D='',$c=''){if(empty($n)){return self::$core->addons;}$d='';if($D){if(!is_array($D)){$D=self::x(',',$D);}foreach($D as$v){if(!self::isInst($v)){$d.=($d?',':'').$v;}}}if(empty($d)){self::lang($n);self::$core->addons[$n]=['name'=>L(empty($l)?"addon $n":$l),'conf'=>$c,];}else{self::log('E',"$n depends on: $d");}}public static function isInst($n){return isset(self::$core->libs[$n])||ClassMap::has('\\PHPPE\\'.$n)||isset(self::$core->addons[$n])||ClassMap::has('\\PHPPE\\AddOn\\'.$n)||ClassMap::has($n)||is_dir('vendor/phppe/'.$n);}public static function lang($c=''){$L=empty(self::$client->lang)?'en':self::$client->lang;$i=explode('_',$L);$la=null;$c="vendor/phppe/$c/lang/";foreach(array_unique([$L,$i[0],'en'])as$l){if(file_exists($c.$l.'.php')){$la=include_once$c.$l.'.php';break;}}if(is_array($la)){self::$l=array_merge(self::$l,$la);}}public static function log($w,$m,$n=null){$w=strtoupper($w);if(!in_array($w,['D','I','A','W','E','C'])){$w='A';}if(!is_string($m)||self::$core->runlevel<3&&$w=='D'){return;}if(empty($n)){$n=!empty(self::$core->app)?self::$core->app:'core';}$n=str_replace("--","",$n);$m=trim(strtr($m,[dirname(dirname(__FILE__)).'/'=>'']));$g=!empty(self::$l[$m])?L($m):$m;$t='';if(!empty(self::$core->trace)){$s=debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS);foreach($s as$d){$t.="\t".substr(@$d['file'],strlen(dirname(__DIR__))+1).':'.@$d['line'].':'.$d['function']."\n";}}date_default_timezone_set('UTC');$p=date('Y-m-d').'T'.date('H:i:s')."Z-$w-".strtoupper($n).': ';@date_default_timezone_set(self::$client->tz);if(!empty(self::$core->syslog)){syslog($w=='C'?LOG_ERR:LOG_NOTICE,self::$core->base.":PHPPE-$w-".strtoupper($n).': '.strtr($m,["\n"=>'\\n',"\r"=>'\\r']).strtr($t,["\n"=>'']));}else{$l='vendor/phppe/Core/log/'.$n.'.log';if(!@file_put_contents($l,$p.strtr($m,["\n"=>'\\n',"\r"=>'\\r'])."\n".$t,FILE_APPEND|LOCK_EX)){$w='C';$g.=(!self::$w?"\nLOG-C":"<br/>\n".date('Y-m-d').'T'.date('H:i:s').'Z-C-LOG').': '.L('unable to write')." $l";}@chmod($l,0660);}if($w=='C'){if(@self::$core->output!='html'){die(strtoupper("$n-C").': '.$g."\n".$t);}die("\n<html><body style='margin:8px;background:#000000;color:#A00000;'><div style='text-align:center;font-size:28px;color:#ff0000;'>PHPPE".VERSION.' - '.L('Developer Console')."</div><br/><br/>\n$p".nl2br(strtr("$g\n$t",["\t"=>'&nbsp;&nbsp;']))."</body></html>\n");}elseif(!self::$w&&$w!='D'&&$w!='I'){fwrite(STDERR,strtoupper("$n-$w").': '.$g."\n");}return true;}public static function isTry($f=''){return empty($f)||$f==self::$core->form?self::$core->try:0;}public static function error($m='',$f=''){if(empty($m)){return self::$core->error;}if(!isset(self::$core->error[$f])){self::$core->error[$f]=[];}self::$core->error[$f][trim($m)]=trim($m);}public static function isError($f=''){return!empty($f)?isset(self::$core->error[$f]):!empty(self::$core->error);}public static function event($e,$c=[]){foreach(self::$core->libs as$k=>$v){if(method_exists($v,$e)){$d=call_user_func_array([$v,$e],is_array($c)?$c:[$c]);if($d!=null){$c=$d;}}}return$c;}public static function toBytes($i){$v=trim(ini_get($i));$l=strtolower($v[strlen($v)-1]);switch($l){case't':$v*=1024;case'g':$v*=1024;case'm':$v*=1024;case'k':$v*=1024;}return$v;}public static function validate($f,$v,$r=0,$a=[],$t=[]){if(method_exists('\\PHPPE\\Addon\\'.$v,'validate')||$v=='check'||$v=='file'){self::$v[$f][$v]=[!empty($r),$a,$t];}}public static function req2obj($p,$V=[]){return self::req2arr($p,$V,0);}public static function req2arr($p,$V=[],$a=1){if($a){$o=array();}else{$o=new \stdClass();}if(!empty(self::$v)){$V+=self::$v;}$R=$_REQUEST;$E='error';foreach($V as$K=>$v){if(substr($K,0,strlen($p)+1)==$p.'.'){$d=substr($K,strlen($p)+1);$r=$p.'_'.$d;foreach($v as$T=>$C){if(($T=='check'||!empty($C[0]))&&empty($R[$r])){$R[$r]=$T=='check'?false:'';}elseif($T=='file'){$f=empty($_FILES[$r])?[]:$_FILES[$r];if(!empty($f[$E])&&$f[$E]!=4){self::error(L(ucfirst($d)).' '.L('failed to upload file.'),$K);}$R[$r]=isset($f[$E])&&$f[$E]==0?$f:[];}}}}ksort($R);foreach($R as$k=>$v){if(substr($k,0,strlen($p)+1)==$p.'_'&&$k[strlen($k)-2]!=':'){$d=substr($k,strlen($p)+1);$K=$p.'.'.$d;if(isset($V[$K])){foreach($V[$K]as$T=>$C){$t='\\PHPPE\\AddOn\\'.$T;if($T=='check'){$v=$v?($v==1||$v=='1'?true:$v):false;}if(!empty($C[0])&&empty($v)){$v=null;self::error(L(ucfirst($d)).' '.L('is a required field.'),$K);}elseif(!empty($v)&&method_exists($t,'validate')){list($r,$m)=$t::validate($K,$v,$C[1],$C[2]);if(!$r&&$m){$O=explode('.',$K);self::error(L(ucfirst(!empty($O[1])?$O[1]:$O[0])).' '.L($m),$K);}}}}$v=$v=='true'?true:($v=='false'?false:$v);if($a){$o[$d]=$v;}else{$o->$d=$v;}}}return$o;}public static function obj2str($o,$s='',$c=' '){return self::arr2str($o,$s,$c);}public static function arr2str($o,$s='',$c=' '){if(!is_array($s)){$s=self::x(',',$s);}$r='';$d=DS::db();if(is_string($o)){$o=[$o];}foreach($o as$k=>$v){if(!in_array($k,$s)){$r.=($r?$c:'').$k.'='.($c==','&&!empty($d)?$d->quote($v):"'".str_replace(["\r","\n","\t","\x1a"],['\\r','\\n','\\t','\\x1a'],addslashes($v))."'");}}return$r;}public static function val2arr($s,$c=','){if(is_array($s)){return$s;}elseif($s!=''){$v=View::getval($s);if(is_array($v)){return$v;}return self::x($c,$v);}return[];}public static function tre2arr($t,$p='  ',$s='',$P='',$S='',&$d=null){foreach($t as$v){$i=count($d);foreach($v as$k=>$w){if($k!='_'){$c=strtolower($k)=='name'&&!$s?$P.$w.$S:$w;if(is_array($v)){$d[$i][$k]=$c;}elseif(is_object($v)){@$d[$i]->$k=$c;}}}if(is_array($v)&&!empty($v['_'])||is_object($v)&&!empty($v->_)){if($s){$c="\n".sprintf($p,$i);if(is_array($d[$i])&&isset($d[$i]['name'])){$d[$i]['name'].=$c;}elseif(is_object($d[$i])&&isset($d[$i]->name)){$d[$i]->name.=$c;}}$d=self::tre2arr(is_array($v)?$v['_']:$v->_,$p,$s,$P.($s?'':$p),($s?'':$s).$S,$d);if($s){$c="\n".$s;if(is_array($d[count($d)-1])&&isset($d[count($d)-1]['name'])){$d[count($d)-1]['name'].=$c;}elseif(is_object($d[count($d)-1])&&isset($d[count($d)-1]->name)){$d[count($d)-1]->name.=$c;}}}}return$d;}public static function started(){return self::$started;}public static function cf($c){if(!is_array($c)){$c=explode(',',$c);}if(!empty($c)){foreach($c as$F){$F=trim($F);$G="PHPPE\\Filter\\$F";if(!empty($F)&&(($F[0]=='@'&&!self::$user->has(substr($F,1)))||($F[0]!='@'&&!@$G::filter()))){return false;}}}return true;}public static function x($a,$b){$r=[];$q='';for($l=$i=0;$i<=strlen($b);++$i){$c=@$b[$i];if($q){if($c==$q){$q='';}if($c=='\\'){$i++;}}elseif($c=='"'||$c=="'"){$q=$c;}elseif($c==$a||$c==''){while(@$b[$l]==$a){$l++;}$r[]=substr($b,$l,$i-$l);$l=$i+1;}}return$r;}public static function h($a,$b,$c=''){return sha1($a.'|'.$b.'|'.$c);}}if(empty(\PHPPE\Core::$core)){new \PHPPE\Core(!empty(debug_backtrace()));}return \PHPPE\Core::$core;}namespace PHPPE\Cache{class APC{public function __construct($c=''){ini_set('apc.enabled',1);if(!function_exists('apc_fetch')&&!function_exists('apcu_fetch')){\PHPPE\Core::log('C',L('no php-apc'),'cache');}}public function get($key){if(function_exists('apc_fetch')){$e='apc_exists';$f='apc_fetch';}else{$e='apcu_exists';$f='apcu_fetch';}$v=$e($key)?$f($key):null;if(function_exists('gzinflate')){$d=json_decode(@gzinflate($v));}return!empty($d)?$d:$v;}public function set($key,$value,$compress=false,$ttl=0){if(function_exists('apc_store')){$s='apc_store';}else{$s='apcu_store';}return$s($key,$compress&&function_exists('gzdeflate')?gzdeflate(json_encode($value)):$value,$ttl);}}class Files{public function __construct($c=''){@mkdir('data/cache',0770);@chmod('data/cache',0775);}private function fn($key){return'data/cache/'.substr($key,0,2).'/'.substr($key,2,2).'/'.substr($key,4);}public function get($key){if(strlen($key)<5){$key='0000'.$key;}$ttl=intval(@file_get_contents($this->fn($key).'.ttl'));if(!file_exists($this->fn($key))||($ttl>0&&time()-filemtime($this->fn($key))>$ttl)){return;}$v=@file_get_contents($this->fn($key));if(function_exists('gzinflate')){$d=@gzinflate($v);}return json_decode(!empty($d)?$d:$v,true);}public function set($key,$value,$compress=false,$ttl=0){if(strlen($key)<5){$key='0000'.$key;}@mkdir('data/cache/'.substr($key,0,2),0775);@chmod('data/cache/'.substr($key,0,2),0775);@mkdir('data/cache/'.substr($key,0,2).'/'.substr($key,2,2),0775);@chmod('data/cache/'.substr($key,0,2).'/'.substr($key,2,2),0775);if($ttl>0){@file_put_contents($this->fn($key).'.ttl',$ttl);}$v=json_encode($value);return file_put_contents($this->fn($key),$compress&&function_exists('gzdeflate')?gzdeflate($v):$v)>0?true:false;}public function cronMinute($args){$files=glob('data/cache/*/*/*.ttl');foreach($files as$f){$ttl=intval(@file_get_contents($f));$cf=substr($f,0,strlen($f)-4);if($ttl<1||time()-@filemtime($cf)>=$ttl){@unlink($f);@unlink($cf);}}}}}namespace PHPPE\Filter{class get extends \PHPPE\Filter{public static function filter(){return@$_SERVER['REQUEST_METHOD']=='GET'?true:false;}}class post extends \PHPPE\Filter{public static function filter(){return@$_SERVER['REQUEST_METHOD']=='POST'?true:false;}}class loggedin extends \PHPPE\Filter{public static function filter(){if(\PHPPE\Core::$user->id){return true;}\PHPPE\Core::redirect('login',1);}}class csrf extends \PHPPE\Filter{public static function filter(){return \PHPPE\Core::isTry();}}}namespace PHPPE\AddOn{use PHPPE\Core as Core;use PHPPE\View as View;class hidden extends \PHPPE\AddOn{public function edit(){return"<input type='hidden' name='".$this->fld."' value='".htmlspecialchars(trim($this->value))."'>";}}class button extends \PHPPE\AddOn{public function show(){return$this->edit();}public function edit(){$t=$this;$a=$t->attrs;return"<button class='".(!empty($a[1])&&$a[1]!='-'?$a[1]:'btn btn-default')."' onclick=\"".strtr(!empty($a[0])&&$a[0]!='-'?$a[0]:"alert('".L('No action')."');",['"'=>'\\"']).'">'.L(!empty($t->name)?$t->name:'Press me').'</button>';}}class update extends \PHPPE\AddOn{public function edit(){$t=$this;$a=$t->attrs;return"<button class='".(!empty($a[1])&&$a[1]!='-'?$a[1]:'btn btn-default')."' name='pe_try".View::tc()."' type='submit'".(!empty($a[0])&&$a[0]!='-'?' onclick="return '.strtr($a[0],['"'=>'\\"']).'"':'').'>'.L(!empty($t->name)?$t->name:'Okay').'</button>';}}class text extends \PHPPE\AddOn{public function show(){return htmlspecialchars($this->value);}public function edit(){$t=$this;$a=$t->args;$b=$t->attrs;$v=trim($t->value);$D=(!empty($a[3])?" dir='ltr'":'');if($v=='null'){$v='';}if(!empty($a[1])&&$a[1]>0){if($a[0]>0){View::js('pe_mt(e,m)','var c,o;if(!e)e=window.event;o=e.target;c=e.keyCode?e.keyCode:e.which;return(c==8||c==46||o.value.length<=m);');}return'<textarea'.@View::v($t,$b[1],$b[0])." rows='".$a[1]."'".($a[0]>0?" onkeypress='return pe_mt(event,".$a[0].");'":'')."$D wrap='soft' onfocus='this.className=this.className.replace(\" errinput\",\"\")'>".$v.'</textarea>';}return'<input'.@View::v($t,$b[1],$b[0],$a)." type='text'".(!empty($b[2])&&$b[2]!='-'?" onkepup='".$b[2]."'":'')." onfocus='this.className=this.className.replace(\" errinput\",\"\")'".(!empty($b[3])&&$b[3]!='-'?' placeholder="'.htmlspecialchars(L(trim($b[3]))).'"':'').(!empty($b[4])?' pattern="'.trim($b[4]).'"':'')."$D value=\"".htmlspecialchars($v).'">';}public static function validate($n,&$v,$a,$t){if(@$a[0]>0){$v=substr($v,0,$a[0]);}return[empty($t[4])||preg_match('/'.$t[4].'/',$v),'not matches the requested format',];}}class pass extends \PHPPE\AddOn{public function show(){return'******';}public function edit(){$t=$this;return'<input'.@View::v($t,$t->attrs[0],'',$t->args)." type='password' value=\"".htmlspecialchars(trim($t->value))."\" onfocus='this.className=this.className.replace(\" errinput\",\"\")'".(!empty($t->attrs[1])?' placeholder="'.htmlspecialchars(trim($t->attrs[1])).'"':'').'>';}public static function validate($n,&$v,$a,$t){if(function_exists('\\PHPPE\\pass')){return \PHPPE\pass($n,$v,$a,$t);}return[preg_match('/[0-9]/',$v)&&preg_match('/[a-z]/i',$v)&&strtoupper($v)!=$v&&strtolower($v)!=$v&&strlen($v)>=6,'not a valid password! [a-zA-Z0-9]*6',];}}class num extends \PHPPE\AddOn{public function show(){return htmlspecialchars($this->value);}public function edit(){$a=$this->args;$t='this.value';$b='o.className=o.className.replace(" errinput","")';$C=isset($a[1])?"if($t<".$a[0].")$t=".$a[0].";if($t>".$a[1].")$t=".$a[1].';':'';$r='return';View::js('pe_on(e)',"var c,o;if(!e)e=window.event;o=e.target;c=e.keyCode?e.keyCode:e.which;$b;if(c==8||c==37||c==39||c==46)$r true;c=String.fromCharCode(c);if(c.match(/[0-9\\b\\t\\r\\-\\.\\,]/)!=null)$r true;else{o.className+=' errinput';setTimeout(function(){{$b};},200);$r false;}");return'<input'.@View::v($this,$this->attrs[1],$this->attrs[0])." style='text-align:right;' type='number' onkeypress='$r pe_on(event);' onkeyup='$t=$t.replace(\",\",\".\");' onfocus='".$C."if($t==\"\")$t=0;".strtr($b,['o.'=>'this.']).";this.select();'".(isset($a[1])?" onblur='$C' min='".$a[0]."' max='".$a[1]."'":'').' value="'.htmlspecialchars(trim($this->value)).'">';}public static function validate($n,&$v,$a,$t){$r=floatval($v).''==$v.''?true:false;$m='not a valid number!';if($r&&isset($a[1])){if($v<$a[0]){$r=false;$m='not enough!';$v=$a[0];}if($v>$a[1]){$r=false;$m='too much!';$v=$a[1];}}$v=floatval($v);return[$r,$m];}}class select extends \PHPPE\AddOn{public function show(){return htmlspecialchars(is_array($this->value)?implode(', ',$this->value):$this->value);}public function edit(){$t=$this;$a=$t->attrs;$b=$t->args;$opts=!empty($a[0])&&$a[0]!='-'?View::getval($a[0]):[];if(is_string($opts)){$opts=Core::x(',',$opts);}$skip=!empty($a[1])&&$a[1]!='-'?View::getval($a[1]):[];if(is_string($skip)){$skip=Core::x(',',$skip);}if(!is_array($skip)){$skip=[];}else{$skip=array_flip($skip);}if(!empty($b[1])){$t->name.='[]';}$r='<select'.@View::v($t,$a[3],$a[2],[],'','',!empty($b[1])?'[]':'').(!empty($b[1])?' multiple':'').(!empty($b[0])&&$b[0]>0?" size='".intval($b[0])."'":'')." onfocus='this.className=this.className.replace(\" errinput\",\"\")'>";if(is_array($opts)){foreach($opts as$k=>$v){$o=is_array($v)&&isset($v['id'])?$v['id']:(is_object($v)&&isset($v->id)?$v->id:$k);$n=is_array($v)&&!empty($v['name'])?$v['name']:(is_object($v)&&!empty($v->name)?$v->name:(is_string($v)?$v:$k));if(!isset($skip[$o])&&!empty($n)){$r.='<option value="'.htmlspecialchars($o).'"'.((is_array($t->value)&&in_array($o.'',$t->value))||$o==$t->value?' selected':'').'>'.$n.'</option>';}}}$r.='</select>';return$r;}}class check extends \PHPPE\AddOn{public function show(){$t=$this;return empty(Core::$core->output)||Core::$core->output!='html'?('['.(!empty($t->value)?'X':' ').'] '.(!empty($t->attrs[0])?L($t->attrs[0]):$t->value)):htmlspecialchars($t->value);}public function edit(){$t=$this;$a=$t->attrs;$e=Core::isError($t->name);return($e?"<span class='errinput'>":'').'<label><input'.@View::v($t,empty($a[2])?'checkbox':$a[2],$a[1])." type='checkbox'".(!empty($t->value)?' checked':'').' value="'.htmlspecialchars(trim(!empty($t->args[0])?$t->args[0]:'1')).'">'.(!empty($a[0])?L($a[0]):'').'</label>'.($e?'</span>':'');}}class radio extends \PHPPE\AddOn{public function show(){$t=$this;return empty(Core::$core->output)||Core::$core->output!='html'?('('.($t->value==$t->args[0]?'X':' ').') '.(!empty($t->attrs[0])?L($t->attrs[0]):$t->args[0])):htmlspecialchars($t->value);}public function edit(){$t=$this;$a=$t->args;$b=$t->attrs;return'<label><input'.@View::v($t,empty($b[2])?'radiobutton':$b[2],$b[1],[],'','_'.sha1($a[0]))." type='radio'".($t->value==$a[0]?' checked':'').' value="'.htmlspecialchars(trim(!empty($a[0])?$a[0]:'1')).'">'.(!empty($b[0])?L($b[0]):'').'</label>';}}class phone extends \PHPPE\AddOn{public function show(){return htmlspecialchars($this->value);}public function edit(){$t=$this;$b='o.className=o.className.replace(" errinput","")';View::js('pe_op(e)',"var c,o;if(!e)e=window.event;o=e.target;c=e.keyCode?e.keyCode:e.which;$b;if(c==8||c==37||c==39||c==46)return true;c=String.fromCharCode(c);if(c.match(/[0-9\\b\\t\\r\\-\\ \\+\\(\\)\\/]/)!=null)return true;else{o.className+=' errinput';setTimeout(function(){{$b};},200);return false;}");return'<input'.@View::v($t,$t->attrs[1],$t->attrs[0],$t->args,"[0-9\+][0-9\ \(\)\-]+")." type='tel' onfocus='".strtr($b,['o.'=>'this.'])."' onkeypress='return pe_op(event);' value=\"".htmlspecialchars(trim($t->value)).'">';}public static function validate($n,&$v,$a,$t){return[preg_match("/^[0-9\+][0-9\ \(\)\-]+$/",$v),'invalid phone number',];}}class email extends \PHPPE\AddOn{public function show(){if(empty(Core::$core->output)||Core::$core->output!='html'){return$this->value;}return strtr(htmlspecialchars($this->value),['@'=>'&#64;','.'=>'&#46;']);}public function edit(){$t=$this;$a=$t->attrs;$b='o.className=o.className.replace(" errinput","")';View::js('pe_oe(o)',"$b;if(o.value!=''&&o.value.match(/^.+\@(\[?)[a-z0-9\-\.]+\.([a-z]{2,3}|[0-9]{1,3})(\]?)$/i)==null)o.className+=' errinput';");return'<input'.@View::v($t,$a[1],'',$t->args)." type='email' onfocus='".strtr($b,['o.'=>'this.'])."' onchange='pe_oe(this);".(!empty($a[0])&&$a[0]!='-'?$a[0]:'')."' value=\"".htmlspecialchars(trim($t->value)).'">';}public static function validate($n,&$v,$a,$t){return[preg_match("/^.+\@(\[?)[a-z0-9\-\.]+\.([a-z]{2,3}|[0-9]{1,3})(\]?)$/i",$v),'invalid email address',];}}class file extends \PHPPE\AddOn{public function show(){return'';}public function edit(){$t=$this;$e=Core::isError($t->name);return'<input'.@View::v($t,$t->attrs[0],$t->attrs[1],$t->args)." type='file' style='display:inline;' title='".round(Core::$fm /1048576)."Mb'>";}}class color extends \PHPPE\AddOn{public function show(){return"<span style='width:10px;height:10px;background-color:".$this->value.";'></span> ".$this->value;}public function edit(){$t=$this;$a=$t->attrs;return'<input'.@View::v($t,$a[1],'',$t->args)." type='color' ".(!empty($a[0])&&$a[0]!='-'?" onchange='".$a[0]."'":'').' value="'.htmlspecialchars(trim($t->value)).'">';}}class label extends \PHPPE\AddOn{public function show(){return$this->edit();}public function edit(){return'<label'.(!empty($this->attrs[1])?" class='".$this->attrs[1]."'":'')." for='".$this->fld."'>".L($this->attrs[0]).':</label>';}}}namespace{function L($s){return isset(\PHPPE\Core::$l[$s])?\PHPPE\Core::$l[$s]:strtr($s,['_'=>' ']);}function url($m=null,$p=null){return \PHPPE\Http::url($m,$p);}}