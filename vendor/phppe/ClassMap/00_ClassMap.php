<?php
/**
 *  PHP Portal Engine v3.0.0
 *  https://github.com/bztsrc/phppe3/
 *
 *  Copyright LGPL 2016 bzt
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU Lesser General Public License as published
 *  by the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Lesser General Public License for more details.
 *
 *   <http://www.gnu.org/licenses/>
 *
 * @file vendor/phppe/ClassMap/00_ClassMap.php
 * @author bzt@phppe.org
 * @date 1 Jan 2016
 * @brief PHP Compositor and PSR-4 compliant, classmap based class auto loader.
 */
namespace PHPPE;
use PHPPE\Core as PHPPE;

/**
 * Main class
 */
class ClassMap
{
/**
 * Initialize library
 *
 * @param cfg not used
 */
    function init($cfg) {
        PHPPE::lib("ClassMap","Class auto loader");
        return true;
    }

/**
 * Diagnostics hook
 * Generate classmap for autoload
 *
 * @param  unix group (like the array returned by posix_getpwnam() call)
 */
    public function diag($group)
    {
        $D=[]; $R=[];
        foreach(["*/*","*/*/*","*/*/*/*","*/*/*/*/*","*/*/*/*/*/*"] as$v) {$D+=array_fill_keys(@glob("vendor/".$v.".php"),0); $D+=array_fill_keys(@glob("app/".$v.".php"),0); }
        foreach($D as $fn=>$v) {
            if(strpos(strtolower($fn),"autoload")!==false||strpos(strtolower($fn),"00_classmap")!==false||explode("/",$fn)[1]=="phppe") continue;
            $data=str_replace("\n{","{",preg_replace("|//[^\n]*$|ims","",preg_replace("|/\*.+?\*/|ims","",preg_replace("|/'.+?'|ims","",preg_replace("|/\".+?\"|ims","",file_get_contents($fn))))));
            if(preg_match_all("/(namespace|class)[\ \t]+([^\ ;{\[\(\]\)\$]+)/ims",$data,$m,PREG_SET_ORDER)) {
                $ns="";
                foreach($m as $V) {
                    if(strtolower($V[1])=="namespace"&&ctype_alpha(trim($V[2])[0])) $ns=trim($V[2]);
                    if(strtolower($V[1])=="class"&&ctype_alpha(trim($V[2])[0]) && (empty(PHPPE::$core->disabled)||(!in_array(trim($V[2]),PHPPE::$core->disabled)&&!in_array($ns.($ns?"\\":"").trim($V[2]),PHPPE::$core->disabled)))) $R[$ns.($ns?"\\":"").trim($V[2])]=$fn;
                }
            }
        }
        uksort($R,function($a,$b){
            $c=substr_count($a,"\\")-substr_count($b,"\\");
            return $c!=0?$c:strcasecmp($a,$b);
        });
        $ret="<"."?php\n/**
 *  PHP Portal Engine v3.0.0
 *  http://phppe.org/
 *
 *  Copyright LGPL 2016 bzt
 *
 * @file vendor/autoload.php
 * @date ".@date("r",PHPPE::$core->now)."
 * @brief This file was generated by PHPPE ClassMap AutoLoader.
 * @regenwith php public/index.php --diag\n */\nspl_autoload_register(function(\$c){\$m=[\n";
        foreach($R as $k=>$v)
            $ret.="  \"".$k."\" => \"".addslashes($v)."\",\n";
        $ret.="];if(!class_exists(\$c) && !empty(\$m[\$c]) && file_exists(\$m[\$c])) include_once(\$m[\$c]);"./*\nelse\n  \\PHPPE\Core::\$core->log('E','Unable to load class: '.\$class,'autoloader');*/"});\n";
        @unlink("vendor/autoload.php");
        i( "vendor/autoload.php",  $ret, true );
    }
}
